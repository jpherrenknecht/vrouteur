<html>
    <head>
    <title>Vrouteur </title>
   
        <meta name="Author" content="JP Herrenknecht">
        <meta charset="utf-8"/>   
        <meta  name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no"    />
        <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
        <script src="https://api.windy.com/assets/map-forecast/libBoot.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        
        <!-- <script src="https://unpkg.com/leaflet.boatmarker/leaflet.boatmarker.min.js"></script> -->
        <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>

        <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/vrouteur.css') }}">
        <link rel="shortcut icon"       href="{{ url_for('static', filename='img/favicon.ico') }}">
affichetabprogs
        <script  type="text/javascript" src="{{ url_for('static', filename='js/vrouteur.js') }}"></script>
        <script  type="text/javascript" src="{{ url_for('static', filename='js/leaflet.curve.js') }}"></script>
        <script  type="text/javascript" src="{{ url_for('static', filename='js/Path.Drag.js') }}"></script>
        <script  type="text/javascript" src="{{ url_for('static', filename='js/leaflet-arc.js') }}"></script>
        <script  type="text/javascript" src="{{ url_for('static', filename='js/boatmarker.min.js') }}"></script>
       <!-- <script src="https://unpkg.com/leaflet-arc/bin/leaflet-arc.min.js"></script> -->

    <script type="text/javascript">


//************************************************************************************************
// 50    Connection websocket
// 85    Declaration des variables 
// 557   Fonctions d affichage         
// 742   Fonctions utilitaires 
// 922   Fonctions de gestion de localstorage 
// 866   Fonctions de gestion de localstorage ANCIEN MODELE
// 1094  Fonctions asynchrones de recuperation des infos sur serveur
// 1395  Fonctions de validation de l input  et recuperation coordonneees 
// 1553  Gestion des waypoints
// 2038  Recherche des cartes VR
// 1931  Gestion de l editeur de routes 
// 2285  Zones Exclusions perso
// 2247  Gestion boite jaune
// 2907  Exemples gestion personalinfos 
// 2970  main Programme principal
// 2990  update    
// 2745  Changement utilisateur 
// 2897  Changement de course 
// 3075  Utilisateur inconnu
// 3189  Fonctions d affichage diverses
// 4225  Listeners
// 4156  Gestionnaires de map 
// 3212  Lancement et mises a jour
// 4319  Fin du script et de windyinit



var origine          = "{{origine}}"
var sourceinfos      = "{{source}}"
var posStart         = {{ posStart | tojson }}


var serveurdistant    = "http://vrouteur.com"   ;   //sur linux0
var serveurlocal      = "http://127.0.0.1:5000" ;   //sur linux1

if (origine=='http://127.0.0.1:5000/')
    {var serveur           = serveurlocal}
else{var serveur           = serveurdistant}


console.log ( 'serveur '+serveur )
console.log ( 'origine de l ip '+origine )

console.log ( 'source des infos '+sourceinfos )
websocket

var client_id;
//var client_id ="59c2706db395b292ed622d84"      // "user1234"; // ID unique du client
   






            


//****************************************************************************************************
//*********  Declaration des variables     ***********************************************************
//****************************************************************************************************






var tabNameCourses          = new Array ();
var coursecomplete          = new Array ();
var trajet                  = new Array ();
var ari                     = new Array ();
var coursesUser             = new Array ();
var tabLignesCheckPoints    = new Array ();
var polylineCourse          = new Array ();
var polylineCurve           = new Array ();
//var tabcoursesactives       = new Array (); // remplacé par coursesUser
var zonesExclusions         = new Array ();
var tooltip                 = new Array ();
var tooltipprog             = new Array ();
var waypoints               = new Array ();
var nomsWaypoints           = new Array ();
var ari                     = new Array ();

var arrayroutage            = new Array ();
var tc                      = new Array ();                                         // temps des isochrones   
var arraypolairesglobales   = new Array ();  
var arraytabvmg10           = new Array ();  
var circleprog              = new Array ();  
var circleprog2             = new Array ();     //Cercles pour le cheminement des wp
var circleWPVR               = new Array();    // Cercles representant les WP
var programmationsvrjaunes  = new Array ();  
var programmationsvr        = new Array ();  

var nomsZonesExclu          = new Array ();     // les 3 sont les memes
var zoneNames               = []; // Tableau pour stocker les noms des zones
var listeZones              = [];
var nomsroutages            = [];

var nomroutage              = new Array ();
var routages                = new Array ();
var polyglobal              = new Array ();     // destiné a recevoir le routage avec les couleurs de voiles 
var tabSelected;
let exclusionsMap           = new Map();
let zonesPolygones = {}; // Stocker les polygones pour pouvoir les supprimer plus tard

var typeVoiles              = ['jib','Spi','Staysail','LightJib','Code0','HeavyGnk','LightGnk'];
var typeVoilesShort         = ['JI','SP','ST','LJ','C0','HG','LG'];
var colors                  = ['red','lime','blue'  ,'orange','darkgreen','#b00000','#d77900'];
var colorhex                = ['#2F67FA','#C62F3E','#319B43','#E4FB74','#FFE852','#52FCFF']

// Localstorage 
var username; 
var course; 
var ycoord;                       // Derniers coordonnees rentres
var xcoord;     
var y0vr;                         // Dernière position VR 
var x0vr; 
var t0vr;
var t0;        
var y1;                           // derniers coordonnés de l 'arrivee 
var x1;          
var dep;                          // valeur de depart

var Source;
var t0routage;

var userId;
var user_id
var id_user; 
var nbWP;
var indiceCourse;
var nbprogress=0;                 // valeur de l avancement dans progressbar       
var intervalid;                   // valeur de l intervalle dans progressbar  

let nowJS           = new Date()
let nowMSec          = nowJS.getTime()
var decalageUTC     = nowJS.getTimezoneOffset()
var unixTimestamp   ;      // valeur du temps unix  
var ecartTemps;            // Ecart entre la mise a jour et le temps actuel pour message sur position>10mn
var eta ;
var dureeparcours;

// valeurs extraites des tables 
var boatinfos;
var leginfos;
var personalinfos;
var personalInfosStr;
var progsvr;
var etatinitial;    // premiere prog correspondant a l etat courant  
var couleurwp='yellow'
var boatVisibility=1
var nomlocalstorage='memoiretrajets'
var urlPolaires;
// variable permettant de bloquer les mises a jour pendantle routage
var bloque=0 ;                 

var cocheexclusions = false
var popup           = L.popup(); 
let popupPolaires
let popupPara;
let overlay = null; // Variable globale
let boite   = null; // Variable globale
var windiv=document.getElementById("windy")
const options =  { key: 'ydO74Xuxv2WWOEShDpel1kaiae8zCnLO', verbose: true,lat: 46.1551,lon: -1.2297, zoom:6  };             //Positionné sur La Rochelle
        

windyInit(options, windyAPI => {
const {map, picker, utils, broadcast,store } = windyAPI;
var windiv=document.getElementById("windy")  

map.setMaxZoom(19); // Augmente la limite globale de zoom

const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap'
    });

    map.addLayer(osmLayer);

// Écouter les changements de zoom
map.on('zoomend', () => {
        const currentZoom = map.getZoom();
         console.log ('currentZoom ',+currentZoom)

        if (currentZoom > 9) {
           
            // if (!map.hasLayer(osmLayer)) {
                map.addLayer(osmLayer);
            // }
        } 
        
        else {
            // if (map.hasLayer(osmLayer)) {
                map.removeLayer(osmLayer);
            // }
        }
    });





var lgMarkers           = new L.LayerGroup()
var lgDashLines         = new L.LayerGroup()
var routageLayer        = new L.LayerGroup()
var boatMarkers         = new L.LayerGroup()
var layerExclusions     = new L.LayerGroup()
var WpCirclesLayer      = new L.LayerGroup()
var routageCircles      = new L.LayerGroup()
var isochronesLayer     = new L.LayerGroup()
var progsvrLayer        = new L.LayerGroup()
var progsvrLayerJaune   = new L.LayerGroup()
var circleBoatLayer     = new L.LayerGroup()
var cartesLayer         = new L.LayerGroup()
var circlew             = new L.circle();
var lgMarkersVR         = new L.LayerGroup()     //waypoints vr 
var lgMarkersVR2        = new L.LayerGroup()     //waypoints vr 
//var progsvrwp           = new L.LayerGroup()   






var texteboite1=`
    <div class="titrevrouteur"  id="boite1" >  VRouteur     <span class="droite">  <a href="http://virtualregatta.com/fr/offshore-jeu/" target= "_blank">VR</a></span>
    <div name='routage'  >
    <table class='table3' id= 'table31'><tr>
    <td>  <input type='text' class='black11' id ='idusername' name='username' placeholder= 'Nom du bateau sur VR'  required size=16> </td>
    <td colspan=2> <span id='idselectcourse' name='selectcourse' class='black11' placeholder ='Choix de la Course'> 
    <select id='idcourse'> <option value='654.1'  selected >Vendee Globe </option></select>    </span>
      </td></tr>  
    </table>

    <table class='table3' id= 'table32' >
     <tr><td class='l20px' >De</td> <td  id='idselectdepart' ></td><td  rowspan='3' class='center' > A</td> <td rowspan='3' id='idselectarrivee'  > </td></tr>

   
   

    </table>
    </div>
    <div id="coordinateInput">
    <!--<label for="inputCoordinates">coordonnées (DMS) :</label>-->
    <input type="text" id="inputCoordinates" placeholder="Ou Coordonnees du Dash avec Ctrl+C Ctrl+V" size="35">
    </div>
    <div id="coordinateDepInput">
            <!-- Latitude -->
            <span id="latitude">
               <!-- <label>Latitude:</label>-->
                <input class="classinput" type="number" id="deplatDeg" min="0" max="90" step="1" value="0">°
                <input class="classinput2" type="number" id="deplatMin" min="0" max="60" step="1" value="0"> 
                <input class="classinput2" type="number" id="deplatSec" min="0" max="60" step="1" value="0">
                <select id="deplatDir" class="classinput5" >
                    <option value="N" selected>N</option>
                    <option value="S">S</option>
                </select>
            </span>
        
        <!-- Longitude -->
            --<span id="longitude">
                <!--<label>Longitude:</label>-->
                <input class="classinput" type="number" id="deplngDeg" min="0" max="180" step="1" value="0">°
                <input class="classinput2" type="number" id="deplngMin" min="0" max="60" step="1" value="0"> 
                <input class="classinput2" type="number" id="deplngSec" min="0" max="60" step="1" value="0">
                <select id="deplngDir" class="classinput5" >
                    <option value="E" selected>E</option>
                    <option value="W">W</option>
                </select>
            </span>
    </div>
    <div><label>Position du dernier WP sélectionné : </label> <label id='iddernierwp'>(Arrivée)</label> </div>
          
    <div id="coordinateAriInput">
            <!-- Latitude -->
            <span id="latitude">
               <!-- <label>Latitude:</label>-->
                <input class="classinput" type="number" id="arilatDeg" min="0" max="90" step="1" value="0">°
                <input class="classinput2" type="number" id="arilatMin" min="0" max="60" step="1" value="0"> 
                <input class="classinput2" type="number" id="arilatSec" min="0" max="60" step="1" value="0">
                <select id="arilatDir" class="classinput5" >
                    <option value="N" selected>N</option>
                    <option value="S">S</option>
                </select>
            </span>
        
        <!-- Longitude -->
            --<span id="longitude">
                <!--<label>Longitude:</label>-->
                <input class="classinput" type="number" id="arilngDeg" min="0" max="180" step="1" value="0">°
                <input class="classinput2" type="number" id="arilngMin" min="0" max="60" step="1" value="0"> 
                <input class="classinput2" type="number" id="arilngSec" min="0" max="60" step="1" value="0">
                <select id="arilngDir" class="classinput5" >
                    <option value="E" selected>E</option>
                    <option value="W">W</option>
                </select>
            </span>
    </div>
   
    <div class='heuredepart'><label>Heure de Depart du Routage:</label>
    <input type="datetime-local" id="datetime" />
     </div>

    <div   id ='dategrib' class='dategrib' > Grib :  </div>Maj à 51,58 - 3,17 - 14<br>
    <div align='center'>
    <button  id='lancerRoutage' class='blackwhite11' value='Lancer le routage' > Lancer le Routage </button>
    <input type='checkbox' id='cocheexclusions' name='cocheexclusions'  />
    <label for='cocheexclusions'>Exclusions</label><br>
    <br><progress value='0' min='0' max='100' id ='progress'></progress>
    
    Isos <input type='checkbox' id='showisochrones' name='showisochrones' checked  />   
    Boat  <input type='checkbox' id='showboat' name='showboat' checked  />
    Marques   <input type='checkbox' id='showmarques' name='showmarques' checked  />
    <div > <span id='eta' class='eta'></span>    <span id='dureeeta'></span><span  id='detailroute2'></span></div> 
    </div>`
    



var texteboite2= `    <div  >
            <span class='col0'> Données VR du :</span><span   class ='col1'  id='dateposvr'  > </span> <span class= 'col2' id='usernamevr'>     </span> <span class='col3'   >Clt : </span><span class='col4' id='rankvr'  ></span>
    <div class='position'>
            <br/>
            <em> Lat : </em><span class='sp11' id='y0vr'  ></span> 
            <em> Lng : </em><span class='sp12' id ='x0vr'></span>
    </div> 
    <table class='table50' id= 'table21'>
        <tr>
           <td>Speed</td>    <td id='speedvr'></td>    <td>Twsvr </td> <td id='twsvr'   ></td>   <td> Twdvr </td>    <td id='twdvr'  ></td> 
        </tr><tr>
        <td>Cap </td><td id='headingvr' ></td><td>Twscalc </td>    <td id='twscalc' ></td>     <td> Twdcalc </td>  <td id='twdcalc'></td>
        </tr><tr>
         <td> Sail </td>  <td id='sailvr'></td>        <td >Twavr </td><td id='twavr' class='red'></td>                             <td>Stamina</td>   <td  id='staminavr'></td></tr>
        <tr><td colspan=2> Voiles auto</td ><td><input type='checkbox' id='voilesautovr' name='voilesautovr'  checked    /></td>
        <td colspan=2> Twa auto</td ><td><input type='checkbox' id='twaauto' name='twaauto'  checked    /></td></tr>
        </table>   
    </div>` 
    



var texteboite22= " "
        +"<div class='caravoiles' id='caravoiles' >"
        +"<table>"
        +"<tr><td>Tws</td><td><input class='classinput50' type='number' min='0' max='35'   step='.1' id ='twsvmg'   size='8'><td>Vmg</td> <td id='vmgmin2' class='pink' ></td>  <td id='vmgmax2' class='pink'>  </td><td id='vmax2' class='pink'></td></tr>"
        +"</table>"
        +"<table id='tabrecou'>"
        +"</table>"
        +"</div>"



y0=0
x0=0
var twsjp  = 50 ;        // voir a supprimer
var twdjp  = 100;
var texteboite3= " " 
    +"<div class='cap'>"
                +"<em>HDG : </em><span class='spred50' id='hdg'>--</span>"
                +"<input type='checkbox' id='cochehdg' name='cochehdg' checked  />"  
                +"<span class='col1'>       </span>  "
                +"<em>  TWA : </em><span class='green50' id='twa'>--</span>"
                +"<input type='checkbox' id='cochetwa' name='cochetwa'  checked    />"  
            
        +"</div>"
    +"<div class='position'>"
        +"<br/>"
        +"<em> Lat : </em><span class='sp11' id='latitudevent'  >"+pos_dec_mn_lat(y0)+'('+ y0.toFixed(4) + ")</span>" 
        +"<em> Lng : </em><span class='sp12' id ='longitudevent'>"+pos_dec_mn_lng(x0)+'('+ x0.toFixed(4)+ ")</span>"
    +"</div> "
    // +"<br/> "
    // +"<div class='vent'><em> "
    //     +"<span id= 'ecarth' class='sp15'> "
    //         +"H + <input class='classinput50' type='number' min='0' max='72'    step='1' id ='mnDecalageMeteo'  value='0' size='7'> h </span></em>" 
    //         +" <span id= 'hprev' class='sp15'>"+hmns.format(tempscourant)+"</span>"            
    //         +"<em>   TWS   </em><span class='sp11purple' id='twscurseur'>"+twsjp.toFixed(2)+"</span>"
    //         +"<em>   TWD   </em><span class='sp12green' id='twdcurseur'>"+twdjp.toFixed(0)+"</span>"
    //             +"<br/> "
    //     +"</div>";
course='654.1'
username='Takron-BSP'

var texteboite4=
       `<div class='liens' >
       <span style="width:120px"><button  id='afficheflotte' >Affichage Flotte</button></span>
       <button id="btnDivers">  Divers Calculettes   </button>
       <button id="btnPolaires">Polaires BSP</button>
       <br> <button onclick='EditeurExclusions()'>Zones d\'exclusions </button>
       <button onclick='chargecartes()'> Cartes VR</button>
       <button onclick='EditeurRoutes()'> Archivage routes</button>
       </div>`;



 



      // <span id='lienpolaires'class='polaires'> <a href=javascript:popupbasique('http://inc.bureauvallee.free.fr/polaires/?race_id='654.1'&tws=13.6+&twa=45&utm_source=VRDashboard')>Polaires </a></span>
//onclick='afficheFlotte()'


var texteboite44= 
        `<div class='progsvr' >
         <span class= 'col150' > Programmations VR </span>
        <span class= 'col30' ><input type='checkbox' id='showprogsvr' name='showprogsvr'  checked    /></span>
      
        <button  id='rafraichir' class='blackwhite11' value='0' > Rafraichir </button>
       
        <button  id='dupliquerprogsvr' class='blackwhite11' value='0' > Dupliquer  </button>
        <div id='idprogrammationsvr' class='idprogrammationsvr' ></div>
       </div>`;



 var texteboitejaune  ="<div id='boitejaune' ></div>"
    //+ intlhmn.format(t0*1000)+textsimultwa(donnees[0][0],donnees[0][1],donnees[0][2],donnees[0][3],donnees[0][4])+
   


var texteEditeurWP =
    `<div id="waypointEditor" class="waypointeditor">
        <span class="close-button" onclick="fermerEditeurWaypoint()">×</span>       
        <h3>Modifier le Waypoint</h3>
        <p>Nom: <span id="wpName"></span></p>
        <p>Latitude: <span id="wpLat"></span></p>
        <p>Longitude: <span id="wpLon"></span></p>
        <span> Rayon: <input type="number" id="wpRadius" step="1" style="width: 60px;"> NM &nbsp;</span>
        Couleur: <input type="color" id="wpColor" value="#FFFF00"></input><br>
        <button id="saveWaypoint">Sauvegarder le WP</button>
        <button id="deleteWaypoint">Supprimer le WP</button>
    </div>`;


var texteEditeurExclusions =""
        + '<div id="exEditor" class = "exEditor" >'
        + '  <span class="close-button" onclick="fermerEditeurEx()">×</span>'   
        + `<h3>Zones d\'exclusions personnalisées</h3>`
        + `  <label for="dynamicSelect">Zones existantes :</label>
            <select id="dynamicSelect"> </select>`
        
        +`<button onclick="fermerEx()"  id="fermerEx">Supprimer la zone</button>`
        + `<div id="addSection">`
        +`<input type="text" size=10 id="nomNewZone" placeholder="Nouvelle zone" title="Zone à créer">`
        +`<button onclick="startDrawing()"  id="startDrawing">Demarrer</button>`
        +`<button   onclick="finishDrawing()" id="finishDrawing"  >Sauver</button>`
        +`<button   onclick="deleteDrawing()" id="deleteDrawing"  >Supprimer</button>`
        + `</div>`;





var texteEditeurRoutes =
        `<div id="RoutesEditor" class = "RoutesEditor" >
         <span class="close-button" onclick="fermerEditeurRoutes()">×</span>  
        <h3>Editeur de Routes</h3>
        <label> Route  à enregistrer </label>
        <input type="text" size=15 id="nomRoutage" placeholder="Nom  du Routage"    value ="${genererNomRoutage()}" title="Zone à créer">
        <button onclick="sauveroute()"  id="sauveroute">Sauvegarder la route</button>
        <br><br>
        <div id="tableroutages"></div>
        </table>    
        </div>`;





function initBoites()                                       //necessaire
        {
             // on va rajouter des div  a windy    
            const newElt1 = document.createElement("div");   
            newElt1.setAttribute("id", "boite1")
            windiv.appendChild(newElt1);
            newElt1.classList.add("boite1");
            newElt1.innerHTML=texteboite1   
                    
            const newElt2 = document.createElement("div");             // c'est la boite des infos vr
            newElt2.setAttribute("id", "boite2")
            windiv.appendChild(newElt2);
            newElt2.classList.add("boite2"); 
            newElt2.innerHTML=texteboite2 

            const newElt22 = document.createElement("div");            // c'est la boite des recouvrements
            newElt22.setAttribute("id", "boite22")
            windiv.appendChild(newElt22);
            newElt22.classList.add("boite22"); 
            newElt22.innerHTML=texteboite22


            const newElt23 = document.createElement("div");             // c'est la boite des recouvrements
            newElt23.setAttribute("id", "popup22")
            windiv.appendChild(newElt23);
            newElt23.innerHTML=texteEditeurWP
                
            const newElt3 = document.createElement("div");              // c'est la boite qui suit le curseur et donne la position et le vent 
            newElt3.setAttribute("id", "boite3")
            windiv.appendChild(newElt3);
            newElt3.classList.add("boite3"); 
            newElt3.innerHTML=texteboite3
                
            const newElt4 = document.createElement("div");              // c'est la boite des liens parametres cartes polaires 
            newElt4.setAttribute("id", "boite4")
            windiv.appendChild(newElt4);
            newElt4.classList.add("boite4"); 
            newElt4.innerHTML=texteboite4


            const newElt44 = document.createElement("div");              // c'est la boite des liens parametres cartes polaires 
            newElt44.setAttribute("id", "boite44")
            windiv.appendChild(newElt44);
            newElt44.classList.add("boite44"); 
            newElt44.innerHTML=texteboite44

            const newElt5 = document.createElement("div");      // c est la boite jaune pour simulation 
            windiv.appendChild(newElt5);
            newElt5.id = "boitejaune";                          // Ajout de l'id
            newElt5.classList.add("boite5");                    // ajout de la classe
         
            
            const newElt24 = document.createElement("div");             // c'est la boite des recouvrements
            newElt24.setAttribute("id", "popup24")
            windiv.appendChild(newElt24);
            newElt24.innerHTML=texteEditeurExclusions
        
        
            const newElt25 = document.createElement("div");             // c'est la boite des recouvrements
            newElt25.setAttribute("id", "popup25")
            windiv.appendChild(newElt25);
            newElt25.innerHTML=texteEditeurRoutes


            // const newElt6 = document.createElement("div");     // c est la boite rouge pour simulation
            // elt.appendChild(newElt6);
            // newElt6.classList.add("boite6"); 
            // newElt6.innerHTML= "<div id='achoix2' name='achoix2' > test3  </div>" 
            // captab=100 
            // donnees2= new Array([0,'cap',amure,Math.abs(Math.round(captab,0)),60])     //initialisation de la deuxieme boite de simulation
            // texte2 ="<div id='achoix2' name='achoix2'>"+ intlhmn.format(t0*1000)+textsimultwa2(donnees2[0][0],donnees2[0][1],donnees2[0][2],donnees2[0][3],donnees2[0][4])+"</div>"        
            // document.getElementById('achoix2').innerHTML=texte2



            // const newElt7 = document.createElement("div");     // c est la boite cachée pour ajout de Wp
            // windiv.appendChild(newElt7);
            // //newElt7.classList.add("popup2"); 
            // newElt7.innerHTML= textepopup
            // var closewp=document.getElementById('closewp') 
            // closewp.addEventListener("click", function (evt){
            //     var popup2        = document.getElementById('popup2');
            //     popup2.style.display = 'none';

         
            //         })
        
        var usernameInput = document.getElementById('idusername');

        } 
        initBoites()







//****************************************************************************************************
//*********  Fonctions d affichage         ***********************************************************
//****************************************************************************************************




function affichecoordsdep(latDecimal,lngDecimal)
{
const { latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir }=fromDecimal(latDecimal, lngDecimal)
//console.log(' test '+latDeg+' '+ latMin +' '+latSec+' '+ latDir+' '+ lngDeg+' '+ lngMin +' '+lngSec +' '+lngDir)
document.getElementById("deplatDeg").value = latDeg;
    document.getElementById("deplatMin").value = latMin;
    document.getElementById("deplatSec").value = latSec;
    document.getElementById("deplatDir").value = latDir;
    document.getElementById("deplngDeg").value = lngDeg;
    document.getElementById("deplngMin").value = lngMin;
    document.getElementById("deplngSec").value = lngSec;
    document.getElementById("deplngDir").value = lngDir;
}


function affichecoordsari(latDecimal,lngDecimal)
{
const { latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir }=fromDecimal(latDecimal, lngDecimal)
//console.log(' test '+latDeg+' '+ latMin +' '+latSec+' '+ latDir+' '+ lngDeg+' '+ lngMin +' '+lngSec +' '+lngDir)isochrones
document.getElementById("arilatDeg").value = latDeg;
    document.getElementById("arilatMin").value = latMin;
    document.getElementById("arilatSec").value = latSec;
    document.getElementById("arilatDir").value = latDir;
    document.getElementById("arilngDeg").value = lngDeg;
    document.getElementById("arilngMin").value = lngMin;
    document.getElementById("arilngSec").value = lngSec;
    document.getElementById("arilngDir").value = lngDir;

}



function afficheBoat (y0vr,x0vr,t0vr,twsvr,twdvr,heading,username){
        circleBoatLayer.clearLayers()
        var circleBoat = L.circle([y0vr,x0vr],{ color: 'white',weight:0.8,fillColor: '#f03',opacity:1,fillOpacity: 0,radius: 250,}).bindTooltip(y0vr) .addTo(circleBoatLayer);
        var circleBoat2 = L.circle([y0vr,x0vr],{ color: 'white',weight:0.8,fillColor: '#f03',opacity:1,fillOpacity: 0,radius: 500,}).bindTooltip(y0vr) .addTo(circleBoatLayer);
        // desactive provisoire 
        boatMarkers.clearLayers()
        var boatMarker = L.boatMarker([y0vr,x0vr], {  color: "#ff00ff",Heading :heading 	}).bindPopup(username+'xx '+intlhmn.format(t0vr*1000)+'<br><b> Tws :'+twsvr.toFixed(2)+' Twd :'+twdvr.toFixed(2) +'<br> Lat : '+y0vr.toFixed(4)+' Lon : '+x0vr.toFixed(4)   ).addTo(boatMarkers);
        boatMarker.setLatLng([y0vr,x0vr]).bindPopup('<b>'+intlhmn.format(t0vr*1000)+' /  '+ username+'<br> Tws :'+twsvr.toFixed(2)+'N  Twd :'+twdvr.toFixed(2) +'°<br>Lat :'+y0vr.toFixed(4) +'  Lon '+x0vr.toFixed(4)+' </b>'  );
        boatMarker.setHeadingWind(heading, twsvr, twdvr);
        if (boatVisibility==1) { boatMarkers.addTo(map)}
        else {boatMarkers.clearLayers()}
        circleBoatLayer.addTo(map)

    }   

//#ff00ff






function affichetabwpvr(data){
  //programmationsJson=JSON.parse(data.programmations)
  waypointsvr=JSON.parse(data.programmations) 
//   console.log ('on est dans affichage donnees waypoints')
//   console.log (waypointsvr)
//   waypointsvr=programmationsJson['progs']
//   console.log ()
 
  let textewp=`<br>`

   for (let i=0 ; i<waypointsvr.length ; i++ ){
     textewp+=`<span style="color: red;">  ${waypointsvr[i]['WPname']} </span>  ${pos_dec_mn_lat( waypointsvr[i]['WPLat'])} / ${pos_dec_mn_lng(waypointsvr[i]['WPLon'])}
     Vent ${waypointsvr[i]['WPTws'].toFixed(2)}N / ${waypointsvr[i]['WPTwd'].toFixed(2)}°
     Twa ${waypointsvr[i]['WPTwam1'].toFixed(2)} / ${waypointsvr[i]['WPTwap1'].toFixed(2)}°<br>
    ${ typeVoilesShort[waypointsvr[i]['WPSailm1']] } / ${typeVoilesShort[waypointsvr[i]['WPSailp1']]}
    Duree ${formatTemps(parseInt(waypointsvr[i]['WPDuree']))} ETA ${  hmns.format(   waypointsvr[i]['WPEta']*1000)}
    NRJ ${waypointsvr[i]['WPNrjm1'].toFixed(1)} / ${waypointsvr[i]['WPNrjp1'].toFixed(1)}
    Peno ${waypointsvr[i]['WPPenop1'].toFixed(0)}s
    <br>
     <br><br>`

   }



     
    
     
    //  ${ typeVoilesShort[waypointsvr[i]['WPSailm1']] } / ${typeVoilesShort[waypointsvr[i]['WPSailp1']]}
    //  Duree ${waypointsvr[i]['WPDuree'].toFixed(0)}s ETA ${  hmns.format(   waypointsvr[i]['WPEta']*1000)}
     

//   texte+=` <thead> 
//             <tr>
//             <th >WP</th>
//             <th >Lat</th>
//             <th >Lon</th>
//             <th>Temps</th>
//             <th >Tws</th>
//             <th >Twd</th>
//             <th>Twa</th>
//             <th >V. Av</th>
//             <th >V. Ap</th>
//             <th>Stam Ap </th>
//             <th>Peno Ap </th>
//             </tr>
//         </thead>`

//    let texte=`<br>`
//    for (let i=0 ; i<waypointsvr.length ; i++ ){
//      texte+=` 

//         WP${i+1} : ${pos_dec_mn_lat( waypointsvr[i][0])} / ${pos_dec_mn_lng(waypointsvr[i][1])}   Vent : 10.5N 207.3°  Cap 110.1 / 132.3<br> Twa  45.1/127.2°   HG / LG NRJ: 80/65 Peno:125s -- 55s ETA: 10h55:03
//         <br><br>`

//    }




//   console.log (texte)
  document.getElementById('idprogrammationsvr').innerHTML      =textewp
  
    //     console.log("programmationsvr contient des 'wp'");
    //     //console.log ('programmationsJson'+programmations )
    //     programmationsWPvr=programmationsJson['wp']
    //    // console.log(programmationsWPvr)
    //         texte="<table class= 'table50'>"
    //             for ( var i=0 ; i<programmationsWPvr.length ; i++ )
    //         {//console.log (programmationsWPvr[i]['lat']+' ' +programmationsWPvr[i]['lon']              )
    //             texte+= '<tr><td> WP'+i+'</td><td>Lat</td> <td>'+programmationsWPvr[i]['lat'].toFixed(3)+' </td><td> Lon</td>  <td> '+programmationsWPvr[i]['lon'].toFixed(3)+'</td></tr>'
    //         }
    //         texte+="</table >"
    //        // console.log ('texte '+texte)    
    //         document.getElementById('idprogrammationsvr').innerHTML      =texte 
    //         }

    //  else {console.log("programmationsvr ne contient rien ni progs ni wp ");}

    }





function afficheligneprogs (data){
    // Affiche la ligne des programmations sur la carte

    polylineprog    = data.polyline
    lgMarkersVR.clearLayers()
    progsvrLayer.clearLayers()

    heurePremiereProg=polylineprog[0][4]        // premiere prog  
    console.log ('heure du premier point de la simulation '+hmns.format(heurePremiereProg*1000))   // c est le point 1 et non le point 0 
    try
        {ecartmn=parseInt((polylineprog[0][4]-arrayroutage[0][3])/60) -0           //c'est polylineprog qui n est pas entier 
            console.log(' temps initial du routage '+hmns.format(arrayroutage[0][3]*1000))
            console.log (' ecart entre la simulation et le routage en mn '+ ecartmn)
        }
    catch{ console.log('pas encore de routage')   ; ecartmn=0} 
    console.log ('ecart en mn entre le premmier point du routage et le premier point de la ligne de programmations ' +ecartmn)    
   
    
    for ( var i=1 ; i<polylineprog.length-1 ; i++ )                // on affiche les nouveaux points mais pas le premier pas necessaire 
        {   if (polylineprog[i][2]==0){option='Cap'}else{option='Twa'}
            voile= typeVoiles [polylineprog[i][5]]  
            couleur=colors[polylineprog[i][5]]
            tooltipprog[i]=intlhmn.format(polylineprog[i][4]*1000)+'<br> '+option +' ' +polylineprog[i][3]+'<br>'+voile              // le temps est en position 3


             if (polylineprog[i][3] == polylineprog[i-1][3])          // si pas de changement de programmation  on fait des cercles noirs   
             {
            if ((i+ecartmn)%10!=0)       
            { circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'white' ,color:couleur , weight:1 ,opacity:1,fillOpacity: 0,radius: 100,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayer)  }                                                                
            else {
                circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'white' ,color:'black', weight:1 ,opacity:1,fillOpacity: 0,radius: 220,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayer)
            
                if ((i+ecartmn)%60==0)       
            { circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'white' ,color:'red' , weight:1 ,opacity:1,fillOpacity: 0,radius: 220,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayer)  }                                                                
            
            }
             }

            else{  //il y a un changement de programmation qui se decale automatiquement 
                circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'red' ,color:'red', weight:1 ,opacity:1,fillOpacity:100,radius: 220,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayer)
                }
        }


       
// // on en profite pour rajouter des cercles pour les waypoints 
// for ( var i=0 ; i<programmationsWPvr.length ; i++ ){
// circleWPVR[i] = L.circle([programmationsWPvr[i]['lat'],programmationsWPvr[i]['lon']] ,{fillColor: 'white' ,color:'white' , weight:1 ,opacity:1,fillOpacity: 0,radius:20000,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayer) 
//  }                                                                



        
        progsvrLayer.addTo(map) 
    }




function afficheligneprogsjaunes (polylineprog){
    progsvrLayerJaune.clearLayers()
    console.log ('heure du premier point de la simulation jaune '+intlhmn.format(polylineprog[0][4]*1000))
    try
        {ecartmn=(polylineprog[0][4]-arrayroutage[0][3])/60 
            console.log(' temps initial du routage '+intlhmn.format(arrayroutage[0][3]*1000))
        console.log (' ecart en mn  entre le routage et la simulation '+ ecartmn)
        }
    catch{ console.log('pas encore de routage')   ; ecartmn=0}    
    console.log ('heure du premier point de la simulation jaune'+intlhmn.format(polylineprog[0][4]*1000))

    for ( var i=1 ; i<polylineprog.length-1 ; i++ )                // on affiche les nouveaux points mais pas le premier pas necessaire 
        {   if (polylineprog[i][2]==0){option='Cap'}else{option='Twa'}
            voile= typeVoiles [polylineprog[i][5]]  
            couleur=colors[polylineprog[i][5]]
            tooltipprog[i]=intlhmn.format(polylineprog[i][4]*1000)+'<br> '+option +' ' +polylineprog[i][3]+'<br>'+voile              // le temps est en position 3
            
            if (polylineprog[i][3] == polylineprog[i-1][3])          // si pas de changement de programmation  on fait des cercles noirs   
             {
            if ((i+ecartmn)%10!=0)       
            { circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'yellow' ,color:couleur , weight:1 ,opacity:1,fillOpacity: 0,radius: 100,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayerJaune)  }                                                                
            else {
                circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'white' ,color:'black', weight:1 ,opacity:1,fillOpacity: 0,radius: 220,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayerJaune)
            
                if ((i+ecartmn)%60==0)       
            { circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'white' ,color:'yellow' , weight:1 ,opacity:1,fillOpacity: 0,radius: 260,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayerJaune)  }                                                                
            
            }
             }

            else{  //il y a un changement de programmation qui se decale automatiquement 
                circleprog[i] = L.circle([polylineprog[i][0],polylineprog[i][1]] ,{fillColor: 'red' ,color:'yellow', weight:1 ,opacity:1,fillOpacity:100,radius: 260,}).bindTooltip(tooltipprog[i]).addTo(progsvrLayerJaune)
            }
        }
        progsvrLayerJaune.addTo(map) 
    }





    
function verifierDeltat(deltat) {

    console.log ('Temps depuis la derniere mise a jour   '+parseInt(ecartTemps) +'s' ) 
    boite = document.querySelector(".boite2");

    // Vérifier si l'élément overlay existe déjà
    overlay = boite.querySelector(".boite-overlay");

    if (deltat > 540) {
        if (!overlay) {
            overlay = document.createElement("div");
            overlay.classList.add("boite-overlay");
            overlay.textContent = "La position date de plus de 10 mn";
            boite.appendChild(overlay);
        }
    } else {
        if (overlay) {
            overlay.remove();
        }
    }
}





 //------------------------------------------------------------------------------------     
 // Fonctions utilitaires 
 //------------------------------------------------------------------------------------  

function ftabnamecourses(listetoutescourses)    // donne le tableau reduit des courses a partir de la listecomplete sous for me de chaine 
    { listetoutescourses=JSON.parse (listetoutescourses)
        nombreCourses=listetoutescourses['res'].length
            tabNameCourses.length=nombreCourses
            for ( var i=0 ; i<nombreCourses ; i++ )
            { let  coursei=listetoutescourses['res'][i]

            numero    = coursei['raceId']+'.'+coursei['legNum']
            startdate = coursei['startDate']
            status    = coursei['status']
            polar_id  = coursei['boat']['polar_id']
            depart    = [coursei['start']['lat'],coursei['start']['lon'],coursei['start']['name'],coursei['start']['heading'],coursei['start']['radius'],]
            end       = [coursei['end']['lat'],coursei['end']['lon'],coursei['end']['name'],coursei['end']['heading'],coursei['end']['radius'],]
            tabNameCourses[i]=[ numero,coursei['legName']+' (' + numero+')', startdate,status,depart,end,polar_id];        
            }
    return tabNameCourses

    }



function tracearc(y0,x0,y1,x1)               
    { //trace un arc entre les points 1 et 2
        L.Polyline.Arc([y0,x0],[y1,x1],{color:'white',weight:1,vertices:50,dashArray: '5, 5' // 5 pixels de ligne, 5 pixels d'espace
        }).addTo(lgDashLines)
    }

       
function rechercheindice2(tabNameCourses,course)
        { 
        for (var i=0;i< tabNameCourses.length;i++)                             // on recupere la valeur des marques pour la course choisie
                {              
                    if (course==(tabNameCourses[i][0]))      // si on est bien sur la course selectionnee val est renvoye par selectcourse 
                        {  indice= i ;break }
                    else {indice=0}    
                    } 
                return indice
        }     



function generateSelect(id,tabValeurs,tabNoms, grises, selectini,class1) {
    // genere le html pour le select depart avec valeurs tabvaleurs noms tabnoms coursesuser =courses en cours  course = selection initiale 
let selectHtml = '<select id="'+id+'"  class='+class1+'>';

    for (let i = 0; i < tabValeurs.length; i++) {
        const value = tabValeurs[i];
        const readableValue = tabNoms[i];
        const style = grises.includes(value) ? 'black11grey' : 'black11';
        //const style = value === selectini ? 'black11' : grises.includes(value) ? 'black11grey' : 'black11bold';

        const selected = value === selectini ? ' selected' : '';
        selectHtml += `<option value="${value}" class="${style}"${selected}>${readableValue}</option>`;
    }
    selectHtml += '</select>';
    return selectHtml;
}


function fselectarrivee(tabValues, tabNoms, tabSelected,class1) {

   // console.log('tabValues '+tabValues+ 'tabNoms '+ tabNoms+' ' + tabSelected+ 'class1 '+class1) 
    // Génère le HTML pour un <select> multiple
    let selectHtml = '<select multiple  id="idarrivee" class="'+class1+'">';
    console.log    ('longueur ',tabValues.length) 
    console.log    ('longueur ',tabValues.length, ' '+tabNoms.length) 
    console.log    ('longueur ',tabValues.length, ' '+tabNoms.length+' ' +tabSelected.length) 


    for (let i = 0; i < tabValues.length; i++) {
        const value = tabValues[i];
        const readableValue = tabNoms[i];
        const selected = tabSelected.includes(value) ? ' selected' : ''; // Vérifier si la valeur est sélectionnée       
        const style = tabSelected.includes(value) ? 'black11wblue' : 'black11'; // Appliquer le style black11grey si l'option est sélectionnée
        
        selectHtml += `<option value="${value}" class="${style}"${selected}>${readableValue}</option>`;// Ajouter l'élément <option>
    }
    selectHtml += '</select>';
    return selectHtml;
    }


    
function afficheselectarrivee(waypoints,ari) {
    // Génère le HTML pour un <select> multiple

    tabValues = waypoints.map(subArray => subArray[1]);
    tabNoms  = waypoints.map(subArray => subArray[1]);
    if (ari==0){ari=['Arrivee']}
    tabSelected= ari
    class1='black11ari'

    let selectHtml = '<select multiple  id="idarrivee" class="'+class1+'">';
    for (let i = 0; i < tabValues.length; i++) {
        const value = tabValues[i];
        const readableValue = tabNoms[i];
        const selected = tabSelected.includes(value) ? ' selected' : ''; // Vérifier si la valeur est sélectionnée       
        const style = tabSelected.includes(value) ? 'black11wblue' : 'black11'; // Appliquer le style black11grey si l'option est sélectionnée
        
        selectHtml += `<option value="${value}" class="${style}"${selected}>${readableValue}</option>`;// Ajouter l'élément <option>
        }
    selectHtml += '</select>';
    try{
    nomdernierwp=ari[ari.length-1]   
    document.getElementById('iddernierwp').innerHTML='('+nomdernierwp+')'}
    catch{ None }
    document.getElementById('idselectarrivee').innerHTML= selectHtml

    return selectHtml;
    }











function couperPolyligneLongitude(points) {
  const troncons = [];
  let tronconCourant = [];

  for (let i = 0; i < points.length - 1; i++) {
    const [lat1, lon1] = points[i];
    const [lat2, lon2] = points[i + 1];

    // Ajouter le point actuel au tronçon courant
    tronconCourant.push([lat1, lon1]);

    // Vérifier si une coupure au niveau de l'antiméridien est détectée
    if (Math.abs(lon1 - lon2) > 180) {
      // Calculer le point d'intersection avec le méridien
      const t = (180 - Math.abs(lon1)) / (Math.abs(lon2 - lon1));
      const latIntersection = lat1 + t * (lat2 - lat1);
      const lonIntersection = lon1 > 0 ? 180 : -180;

      // Ajouter le point d'intersection et terminer le tronçon courant
      tronconCourant.push([latIntersection, lonIntersection]);
      troncons.push(tronconCourant);

      // Démarrer un nouveau tronçon à partir de l'autre côté du méridien
      const newLon = lon1 > 0 ? -180 : 180;
      tronconCourant = [[latIntersection, newLon]];
    }
  }

  // Ajouter le dernier point et le dernier tronçon
  tronconCourant.push(points[points.length - 1]);
  troncons.push(tronconCourant);

  return troncons;
}    





function formatDuree(seconds) {
    let h = Math.floor(seconds / 3600);
    let m = Math.floor((seconds % 3600) / 60);
    let s = seconds % 60;

    let resultat = [];
    if (h > 0) resultat.push(`${h}h`);
    if (m > 0) resultat.push(`${m}mn`);
    if (s > 0 || resultat.length === 0) resultat.push(`${s}s`);

    return resultat.join(" ");
}




//***************************************************************************************************************
//********  Fonctions de gestion de localstorage                                   ******************************
//***************************************************************************************************************



async function initialise1(){
    //initialisememoiretrajets
    //const tabNameCourses= await chercheracesinfos() 
    tabNameCourses=await chercheracesinfos() // independant de tout 
    if (localStorage.getItem("memoiretrajets") === null) {
           // on crée un premier trajet pour Inconnu        
        username='Bateau Inconnu'
        course= tabNameCourses [0][0]
        y0    = tabNameCourses [0][4][0]
        x0    = tabNameCourses [0][4][1]
        y1    = tabNameCourses [0][5][0]      // a voir avec les futures modi 
        x1    = tabNameCourses [0][5][1]
        r1    = tabNameCourses [0][5][4]
        nomAr = tabNameCourses [0][5][2]
        t0    = nowMSec/1000
        ari   = ['Arrivee']
        WP    = [[1,'Arrivee',y1,x1,r1]]   
        trajet[0]=username
        trajet[1]=course
        trajet[2]=y0
        trajet[3]=x0
        trajet[4]=y0
        trajet[5]=x0
        trajet[6]=t0
        trajet[7]=y1
        trajet[8]=x1
        trajet[9]=-1     // dep
        trajet[10]=0    //ari
        trajet[11]=ari    //ari
        trajet[12]=WP
        trajet[13]='Initialisation'
        // on sauve 
        localStorage.setItem('memoiretrajets',JSON.stringify([trajet]))
        //On en profite aussi pour lui initialiser sa course par defaut 
        coursesUser=[course]

        }      
 
    }



function ajoutetrajet (trajet)
{  //ajoute le trajet en première position 
   memoiretrajets = JSON.parse(localStorage.getItem(nomlocalstorage))
   //console.log('memoiretrajets \n'+memoiretrajets)
   memoiretrajets.unshift(trajet)
   memoiretrajets = memoiretrajets.slice(0, 10); // Garder seulement les 10 premiers
   localStorage.setItem('memoiretrajets',JSON.stringify(memoiretrajets))
}




function trouvetrajet( username, course) {
    //trouve le trajet et le reinstalle en première position 
   
    let  tableau = JSON.parse(localStorage.getItem(nomlocalstorage))
    // Trouver l'index du trajet
    let index = tableau.findIndex(ligne => ligne[0] === username && ligne[1] === course);
    if (index === -1) {
        return [] ; // Retourner un tableau vide si rien n'est trouvé
    }
    if (index > 0) { // L'élément est trouvé mais pas en premier
        let ligneCible = tableau.splice(index, 1)[0]; // Extraire la ligne ciblée
        tableau.unshift(ligneCible); // Réinsérer en première position
        localStorage.setItem('memoiretrajets', JSON.stringify(tableau)); // Mettre à jour localStorage
        return ligneCible;
    }

    console.log('ligne 836'+tableau[0])
    return tableau[0];  // L'élément est déjà en première position
}




function trouvetrajetcomplet ( username, course) {
    //trouve le trajet et le reinstalle en première position et initialise les variables  
    // On commence par rechercher s il existe dans la base boatinfos


    let  tableau = JSON.parse(localStorage.getItem(nomlocalstorage))
    

    // Trouver l'index du trajet
    let index = tableau.findIndex(ligne => ligne[0] === username && ligne[1] === course);
    if (index === -1) {
        return [] ; // Retourner un tableau vide si rien n'est trouvé
    }
    if (index > 0) { // L'élément est trouvé mais pas en premier
        let trajet = tableau.splice(index, 1)[0]; // Extraire la ligne ciblée
        tableau.unshift(trajet); // Réinsérer en première position
        localStorage.setItem('memoiretrajets', JSON.stringify(tableau)); // Mettre à jour localStorage
        
        username    =trajet [0]
        course      =trajet [1]
        ycoord      =trajet [2]                 // Derniers coordonnees rentres
        xcoord      =trajet [3]
        y0vr        =trajet [4]                 // Dernière position VR 
        x0vr        =trajet [5]
        t0          =trajet [6]                 // dernier temps de calcul
        y1          =trajet [7]                 // derniers coordonnés de l 'arrivee 
        x1          =trajet [8]
        dep         =trajet [9]                 // valeur de depart
        ari         =trajet [10]                // c 'est un tableau ordre des waypoints
        waypoints   =trajet [11]
        Source      =trajet [12]    
        return trajet;
    }

    console.log('ligne 836'+tableau[0])
    return tableau[0];  // L'élément est déjà en première position
}


function trouvederniertrajet (){
    //cherche le dernier trajet et initialise directement les variables globales 
    let trajet = JSON.parse(localStorage.getItem(nomlocalstorage))[0]
    username    =trajet [0]
    course      =trajet [1]
    ycoord      =trajet [2]                 // Derniers coordonnees rentres
    xcoord      =trajet [3]
    y0vr        =trajet [4]                 // Dernière position VR 
    x0vr        =trajet [5]
    t0          =trajet [6]                 // dernier temps de calcul
    y1          =trajet [7]                 // derniers coordonnés de l 'arrivee 
    x1          =trajet [8]
    dep         =trajet [9]                 // valeur de depart
    ariold      =trajet [10] 
    ari         =trajet [11]                // c 'est un tableau ordre des waypoints
    waypoints   =trajet [12]
    Source      =trajet [13]  
    return trajet

}



function updatetrajet(username, course, trajet) {
    // substitue le trajet si deja existant le cree sinon et le place en premier dans tous les cas  
    
    let memoiretrajets = JSON.parse(localStorage.getItem('memoiretrajets')) || [];// Récupérer le tableau 
    // Trouver l'index de la ligne à remplacer
    let index = memoiretrajets.findIndex(row => row[0].trim() === username.trim() && row[1] == course);
    if (index !== -1) { memoiretrajets.splice(index, 1);}      // Supprimer la ligne existante       
    memoiretrajets.unshift(trajet); // Ajouter la nouvelle ligne en tête de liste
    // Sauvegarder dans le localStorage
    localStorage.setItem('memoiretrajets', JSON.stringify(memoiretrajets));
}













//***************************************************************************************************************
//********  Fonctions asynchrones de recuperation des infos sur serveur            ******************************
//***************************************************************************************************************




async function recherchepersonalinfos2(username,course)
{
// console.log('*********************************************************************')    
// console.log ("On recherche les infos personelles de "+ username+" sur course "+ course+" avec recherchepersonalinfos2 ")
// console.log('**********************************************************************')   


const url = serveur + "/recherchepersonalinfos2?username="+username+"&course="+course
const response = await fetch(url);
if (!response.ok) {  throw new Error(`La recherche des infos perso a echouée : ${response.statusText}`);  }
        const reponse = await response.json();
   
infos=reponse['infos']
// console.log ('infos '+infos )        

// waypoints=infos['wp']
// console.log ('Test de recuperation waypoints'+waypoints)
return infos
}

async function newpersonalinfos(username,course){
// cree un personalinfos pour username et course 
// on va envoyer les donnees recuperees pour la course a partir de tabnamecourses 
let courseencours = tabNameCourses.find(tabNameCourses => tabNameCourses[0] === course)
console.log(courseencours)
courseencours=JSON.stringify(courseencours)
const url = serveur + "/newpersonalinfos?username="+username+"&course="+courseencours
const response = await fetch(url);
if (!response.ok) {  throw new Error(`La recherche des infos perso a echouée : ${response.statusText}`);  }
        const reponse = await response.json();
        message=reponse['message']
console.log ('message : '+message )        

// waypoints=infos['wp']
// console.log ('Test de recuperation waypoints'+waypoints)
return message

}



// requete en post 
async function modifpersonalinfos(username, course, typeinfo, typeaction, nom, valeur) {
    valeur = encodeURIComponent(valeur);

    const url = serveur + "/modifpersonalinfos";

    const data = {
        username: username,
        course: course,
        typeinfo: typeinfo,
        typeaction: typeaction,
        nom: nom,
        valeur: valeur
    };

    console.log("Données envoyées :", data);

    const response = await fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    });

    if (!response.ok) {
        throw new Error(`La modification des infos perso a échoué : ${response.statusText}`);
    }

    const reponse = await response.json();
    message = reponse['message'];
    console.log("Message reçu :", message);

    return message;
}



// async function modifpersonalinfos(username,course,typeinfo,typeaction,nom,valeur){
// // console.log (`valeur du ${valeur} a modifier par ${typeaction} : \n ${valeur}`)

// valeur=encodeURIComponent(valeur)
// const url = serveur + "/modifpersonalinfos?username="+username+
// "&course="+course+
// "&typeinfo="+typeinfo+
// "&typeaction="+typeaction+
// "&valeur="+valeur+
// "&nom="+nom


// console.log (url)
// const response = await fetch(url);
// if (!response.ok) {  throw new Error(`La recherche des infos perso a echouée : ${response.statusText}`);  }
//         const reponse = await response.json();
//         message=reponse['message']
// console.log ('message : '+message )     
// return message
// }




async function chercheracesinfos() {
    const url = serveur + "/rechercheracesinfos";
    try {
        const response = await fetch(url);
        if (!response.ok) {  throw new Error(`La liste des courses generales  n'a pas été trouvée : ${response.statusText}`);  }
        const data = await response.json();
        const listetoutescourses = data.result; // Données brutes
        let tabNameCourses = ftabnamecourses(listetoutescourses);                   // Simplification des donnees en Tableau
        tabNameCourses  = tabNameCourses.filter(course => course[3] !== 'ended');
        console.log('Tableau des courses en cours')
        console.log(tabNameCourses)
        return tabNameCourses;
    } catch (error) {
        console.error("Erreur lors de la récupération de chercheracesinfos :", error);
        throw error; // Propager l'erreur pour que l'appelant puisse la gérer
    }
}




async function cherchecoursesuser(username){   
    const url=serveur+"/recherchecoursesuser?username="+username
    try{
        let response = await fetch(url,);
        if (!response.ok) { throw new Error('La liste des coursesuser  n a pas ete trouvee ' + response.statusText);    }
        let data = await response.json();
        coursesUser =data.result
       
        
        if (coursesUser==null){ //alert ('Ce bateau n est inscrit sur aucune course, il n\'est pas possible d utiliser la position VR   ') ;
        course = tabNameCourses[0][0];
        coursesUser=[course]  
        }        
        else{
        coursesUser=JSON.parse(coursesUser)// on transforme le tableau de json en tableau simle
        coursesUser=coursesUser.map(item => `${item.raceId}.${item.legNum}`)
        }
        console.log ('Courses User :  '+coursesUser)
        return coursesUser
    }

    catch (error) {
        console.error("Erreur lors de la récupération de cherchecoursesuser :", error);
        throw error; // Propager l'erreur pour que l'appelant puisse la gérer
    }
}





async function chercheleginfos(course){
    const url=serveur+"/rechercheleginfos?course="+course
    try{
    let response = await fetch(url,);
    if (!response.ok) { throw new Error('chercheleginfos n a pas repondu ' + response.statusText);    }
    let data = await response.json();
    leginfos =data.result
    return leginfos
    }
    catch (error) {
        console.error("Erreur lors de la récupération de chercheleginfos :", error);
        throw error; // Propager l'erreur pour que l'appelant puisse la gérer
    }
}





async function chercheboatinfos(username,course){   
    // recupere le resultat qui vient directement du serveur VR
    const url=serveur+"/rechercheboatinfos?username="+username+"&course="+course
    let response = await fetch(url);
    try{ 
        if (!response.ok) { throw new Error('Problème avec cherche Boatinfos ' + response.statusText);    }
        let data       = await response.json();
        boatinfos      = data.result 
        tig            = data.tig 
        indicemajgrib  = data.indicemajgrib
        console.log ('ligne 1174  tig '+ intlhmn.format(tig*1000))
        console.log ('Indice '+indicemajgrib)
        return data
        }
        catch (error) {
            console.error("Erreur lors de la récupération de boatinfos :", error);
            throw error; // Propager l'erreur pour que l'appelant puisse la gérer
        }
    }



async function cherchepersonalinfos(username,course){   
    const url=serveur+"/recherchepersonalinfos?username="+username+"&course="+course
    let response = await fetch(url);
    try{ 
        if (!response.ok) { throw new Error('Problème avec cherche Personalinfos ' + response.statusText);    }
        personalinfos = await response.json();
        // ici c est un dico avec nom et zone
       
        return personalinfos
        }
    catch (error) {
            console.error("Erreur lors de la récupération de personalinfos :", error);
            throw error; // Propager l'erreur pour que l'appelant puisse la gérer
        }
    }
    


async function chercheprogsvr(id_user,course,t0routage){   
    // console.log('Recherche des Progs\n*********************************')
    // console.log (' ligne 1277 '+t0routage)
    if (!t0routage){
        let nowJS  = new Date(); 
        let nowSec = nowJS.getTime() / 1000;
        let nowSecArrondi = Math.ceil(nowSec / 60) * 60;
        t0routage= nowSecArrondi} 
        // console.log (' ligne 1282 '+t0routage)
        // console.log (' ligne 1365 userId'+userId)

        const url=serveur+"/rechercheprogsvr?id_user="+userId+"&course="+course+"&t0routage="+t0routage
    //console.log ('ligne 1192 url \n'+url)
    
    let response = await fetch(url);
        if (!response.ok) { throw new Error('Problème avec cherche Progsvr ' + response.statusText);    }
        progsvrglobal = await response.json();
        // ici c est un dico avec nom et zone
        // on va gerer l affichage ici 
        //sprogsvr=progsvrglobal.programmations 
        // console.log ( 'ligne1434 reponse a rechercheprogsvr '+progsvrglobal)
        // console.log ( 'ligne1435 reponse a rechercheprogsvr '+progsvrglobal['typeprogs'])
        afficheprogsvr(progsvrglobal)   // affiche a la foirs le tableau et la polyline 
        bloque=0
        //return progsvr
    }
    

async function cherchevoiles(y0,x0,t0,tws,twa,polar_id){
       
        const url=serveur+"/recherchevoiles?y0="+y0+"&x0="+x0+"&t0="+t0+"&tws="+tws+"&polar_id="+polar_id
        //console.log ('url'+url)
        let response = await fetch(url);
    try{ 
        if (!response.ok) { throw new Error('Problème avec cherchevoiles ' + response.statusText);    }
         resvoiles = await response.json();
        // console.log('resvoiles'+resvoiles)
         // on lance ici directement l affichage pour pouvoir utiliser la fonction dans les mises a jour 
        twscalc             = resvoiles.twscalc
        twdcalc             = resvoiles.twdcalc
        tabvmg              = resvoiles.tabvmg
        tabrecouvrements    = resvoiles.tabrecouvrements   
        // on affiche les valeurs 
        document.getElementById('twscalc').innerHTML=twscalc.toFixed(2)
        document.getElementById('twdcalc').innerHTML=twdcalc.toFixed(2)
        document.getElementById('vmgmin2').innerHTML=tabvmg[2].toFixed(1)
        document.getElementById('vmgmax2').innerHTML=tabvmg[4].toFixed(1)
        document.getElementById('vmax2').innerHTML  =tabvmg[6].toFixed(1)
        affichagerecou(tabrecouvrements)
        // on en profite pour mettre ajour le lien sur les polaires avec tws et twa 
        return resvoiles
        }
     catch (error) {
            console.error("Erreur lors de la récupération de cherchevoiles :", error);
            throw error; // Propager l'erreur pour que l'appelant puisse la gérer
        }
    }



async function calculeroute(id_user,course,programmations,voilesauto)
    {
    // avant d envoyer la demande de calcul au serveur on uniformise la premiere date jaune avec les programmations rouges

    console.log(' ligne 706 heure de la premiere programmation jaune ' + hmns.format(programmations[0][0]*1000))
    console.log(' ligne 706 heure de la premiere programmation rouge ' + hmns.format(heurePremiereProg*1000))
    programmations[0][0]=heurePremiereProg
    const progs5 = JSON.stringify(programmations);        // pour envoi par url 

    //console.log('ligne 1332 '+progs5)
   
    url=serveur+"/calculeroute?username="+username+"&id_user="+id_user+"&course="+course+"&programmations="+progs5+"&voilesauto="+voilesauto
            let response = await fetch(url);            
            if (!response.ok) { throw new Error('Probleme dans calculroute ' + response.statusText);    }
            let data = await response.json();
            polylineprog=data.polylineprog
            //console.log (polylineprog)
            afficheligneprogsjaunes(polylineprog)// il n y a plus qu a tracer 
    }





    
async function chercheroutage(y0,x0,heuredepart,waypoints,ari,cocheexclusions){
        bloque=1        // on bloque les tentatives d update pour ne pas satrurer le serveur 
        let swaypointsjson= JSON.stringify(waypoints);
        let waypointsEncode = encodeURIComponent(swaypointsjson);
        let sarijson = JSON.stringify(ari);
        let sariEncode =encodeURIComponent( sarijson);

        //on va recuperer les coordonnees y1 x1 par l affichage  uniquement pour calculer la duree de la progressbar 
        const  {lat,lng}=recuperecoordsari ()

        console.log (' ligne 1168 lat'+lat+' '+lng) 
       

        console.log ('on est dans chercheroutage')
        progressbar(y0,x0,lat,lng)           // on lance la progressbar

        isochronesLayer.clearLayers()
        console.log (heuredepart )
        console.log (`ligne 1407 heure de depart du routage  ${ intlhmn.format(heuredepart*1000)}`) 
        // clearMap(map) 
        // affichageExclusions(map,layerExclusions,exclusions)
        //url=serveur+"/rechercheroutage3?username="+username+"&course="+course+"&y0="+y0+"&x0="+x0+"&t0="+t0vr+"&waypoints="+waypointsEncode+"&indiceWParrivee="+indiceWParrivee+"&cocheexclusions="+cocheexclusions
        url=serveur+"/rechercheroutage3?username="+username+"&course="+course+"&y0="+y0+"&x0="+x0+"&t0="+heuredepart+"&waypoints="+waypointsEncode+"&ari="+sariEncode+"&cocheexclusions="+cocheexclusions
        console.log('\nDemande de routage url : '+url+'\n***************************************************************************')
        
        t0routageprogs=heuredepart                            //heurededepart du routage

        let response = await fetch(url);
                if (!response.ok) { throw new Error('Le routage n a pas pu etre calculé ' + response.statusText);    }
                routageLayer.clearLayers()
                
                routageCircles.clearLayers();
                let data = await response.json();
                console.log (data.test)

                polynoir        = data.polynoir
                polyblanc       = data.polyblanc
                polyred         = data.polyred
                polybleu        = data.polybleu
                polyglobal      = data.polyglobal         //chemin compose  de plusieurs array avec les voiles 
                tc              = data.tc
                arrayroutage    = data.arrayroutage      //  console.log ('arrayroutage') //  console.log (arrayroutage)

             
                eta             =     intlhmn.format(arrayroutage[arrayroutage.length-1][3]*1000)
                dureeparcours=arrayroutage[arrayroutage.length-1][3]-arrayroutage[0][3]
                console.log ('ligne 1376   ETA  ', eta) 
                 
                document.getElementById('eta').innerHTML='Duree : '+formatDuree(dureeparcours)+'&nbsp;&nbsp; ETA :'+eta  
                polynoir  = L.polyline(polynoir) .setStyle({ color: 'black', weight:1, opacity:0.3, }).addTo(isochronesLayer);           // Isochrones noirs
                polyblanc = L.polyline(polyblanc).setStyle({ color: 'white', weight:1, opacity:0.3, }).addTo(isochronesLayer);           // Isochrones noirs
                polyred   = L.polyline(polyred).setStyle({ color: 'red', weight:1, opacity:1, }).addTo(isochronesLayer);           // Isochrones noirs
                polybleu  = L.polyline(polybleu).setStyle({ color: 'blue', weight:3, opacity:1, }).addTo(isochronesLayer);           // Isochrones noirs
                colors=[ 'red','lime','blue'  ,'orange','darkgreen','#b00000','#d77900']
                //polyglobal1=polyglobal[0]
                console.log(' ')
                console.log ('ligne 1586 Longueur de polyglobal '+polyglobal.length )
                console.log(' ')

                    for (var j=0;j<polyglobal.length;j++)
                    {polyglobal1=polyglobal[j]
                    for (var i=0;i<polyglobal1.length;i++)
                                     { polyvoile=L.polyline(polyglobal1[i]).setStyle({ color: colors[i], weight:2, opacity:1, }).addTo(routageLayer);  }
                                
        //                            // tooltips sur la ligne de routage
                    }
                    for ( var i=0 ; i<arrayroutage.length ; i++ )
                            {   
                                delta= parseInt(arrayroutage[i][3]-arrayroutage[0][3])
                                he=parseInt(delta/3600)
                                mni=Math.round((delta-3600*he)/60)
                               
                               
                                // +"<td class='c10' >"+ i+"</td>" 
                                // +"<td>+"+ he+"h <br>"+mni+"mn</td>"
                                
                             tooltip[i]=' '
                                +' <b>'+(i)+')  '+intl.format((arrayroutage[i][3]*1000)) +'  ( +'+ he+'h '+mni+'mn)'
                                + '<br><b>  HDG : <span class="red">' +arrayroutage[i][7].toFixed(1)  +'°</span> ---  TWA : <span class="green"> ' +arrayroutage[i][4].toFixed(1)+'°</span>'
                                + '<br><b>  Speed : <span class="purple">' +arrayroutage[i][8].toFixed(2)  +'N</span>'    
                                +' <br> TWS : <span class="purple">' +arrayroutage[i][11].toFixed(2)+' N.  --</span> TWD : <span class="purple">'+arrayroutage[i][12].toFixed(1)+'°</span>'
                                +' <br>  '+typeVoiles[parseInt(arrayroutage[i][9]%10)]+ ' Stamina : '+arrayroutage[i][13].toFixed(0)+' '
                                +' <br> Lat  : '+pos_dec_mn_lat(arrayroutage[i][1]) +' ('+arrayroutage[i][1].toFixed(4)+'°)<br>Lng : '+pos_dec_mn_lng(arrayroutage[i][2]) +'('+arrayroutage[i][2].toFixed(4)+'°)'
                            
                            if (i%6 != 0)
                                {var circle = L.circle([arrayroutage[i][1],arrayroutage[i][2]],{ color: 'black',weight:0.7, fillColor: '#f03',opacity:1,fillOpacity: 0,radius: 200,}).bindTooltip(tooltip[i]) .addTo(routageCircles); }   
                            else{ var circle = L.circle([arrayroutage[i][1],arrayroutage[i][2]],{ color: 'white',weight:0.8,fillColor: '#f03',opacity:1,fillOpacity: 0,radius: 200,}).bindTooltip(tooltip[i]) .addTo(routageCircles); }    
                            }
                            
                          // L.Polyline.Arc([y0,x0],[y1,x1],{color:'white',weight:1,vertices:50}).addTo(map)
                            routageLayer.addTo(map)
                            isochronesLayer.addTo(map)
                            routageCircles.addTo(map)
        //                         // lorsque le routage est terminé on peut afficher detailroute 
                             document.getElementById('detailroute2').innerHTML   =  " <button  >Detail Route </button>"     

                    bloque=0             // on debloque le update  
                   
                    document.getElementById('progress').value=100;          //ne marche pas 
                    clearInterval(intervalid);
                    }   // fin de la fonction de demande de routage 






//***************************************************************************************************************
//********  Fonctions de validation de l input                                     ******************************
//***************************************************************************************************************



  function waitForInput() {
            return new Promise((resolve) => {
                usernameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { // Si "Entrée" est pressée
                        if (validateInput()) {
                            resolve(usernameInput.value.trim()); // Résout avec la valeur
                        }
                    }
                });
            });
        }

function validateInput() {
            const value = usernameInput.value.trim();
            if (value === "") {
                alert("Veuillez entrer un nom d'utilisateur avant de continuer.");
                usernameInput.focus(); // Re-mets le focus sur le champ
                return false;
            }
            return true;
        }


function recuperecoordsdep (){
    var  latDeg = document.getElementById("deplatDeg").value;
    var  latMin = document.getElementById("deplatMin").value;
    var  latSec = document.getElementById("deplatSec").value;
    var  latDir = document.getElementById("deplatDir").value;
    var  lngDeg = document.getElementById("deplngDeg").value;
    var  lngMin = document.getElementById("deplngMin").value;
    var  lngSec = document.getElementById("deplngSec").value;
    var  lngDir = document.getElementById("deplngDir").value;
    return toDecimal(latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir);   
}

function recuperecoordsari (){
    var  latDeg = document.getElementById("arilatDeg").value;
    var  latMin = document.getElementById("arilatMin").value;
    var  latSec = document.getElementById("arilatSec").value;
    var  latDir = document.getElementById("arilatDir").value;
    var  lngDeg = document.getElementById("arilngDeg").value;
    var  lngMin = document.getElementById("arilngMin").value;
    var  lngSec = document.getElementById("arilngSec").value;
    var  lngDir = document.getElementById("arilngDir").value;
    return toDecimal(latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir);   
}




//***************************************************************************************************************
//********  Gestion des waypoints                                       ******************************
//***************************************************************************************************************
// dblclick
// ouvrir editeur
// fermerediteur
// miseajourwaypoint 
// ajouterwaypoint
// supprimerdulocalstorage
// affichewaypoints 


let circles   = []; // Pour stocker le cercle actuel
let newCircle = null;     // Cercle temporaire
let newlat;
let newlon;
let newRayon;
let waypointSauve = false;
var waypointCircles2 = {}; // Stocke les cercles créés pour éviter les doublons
var waypointsJS = {}; // Stocke les cercles créés pour éviter les doublons





map.on('dblclick', function (e) {      
    console.log ('ligne 1578 nombre de wp lors du double click : '+nbWP)
    // mis a jour 
    var lat = e.latlng.lat;
    var lon = e.latlng.lng;
    var rayon = 10;  // Rayon par défaut (en NM)
    var couleur = "#FFFF00"; // Jaune par défaut
    let dernierIndex = 0;

    // Trouver le dernier index avant "Arrivee"
    for (let i = 0; i < waypoints.length - 1; i++) {
        if (waypoints[i][0] !== 99) {
            dernierIndex = Math.max(dernierIndex, waypoints[i][0]);
        }
    }

    let nouvelIndex = dernierIndex + 1;
    let nomwp = "WP" + nouvelIndex;

   
    var newCircle = L.circle([lat, lon], {
        color: 'black',
        fillColor: couleur,
        fillOpacity: 0.5,
        radius: rayon * 1852,
        draggable: true
    }).bindTooltip('WP'+nbWP)
    .addTo(WpCirclesLayer);

    newCircle.on('drag', function (event) {
        cercleSelectionne = newCircle;
        const newLatLng = event.target.getLatLng();
        document.getElementById('wpLat').textContent = newLatLng.lat.toFixed(4);
        document.getElementById('wpLon').textContent = newLatLng.lng.toFixed(4);
        ouvrirEditeurModifWaypoint(newCircle, nomwp,couleur);
    });

    newCircle.on('click', function () {
        ouvrirEditeurModifWaypoint(newCircle, nomwp,couleur);
    });

    waypointsJS[nomwp] = newCircle;

    
    ouvrirEditeurWaypoint(newCircle, nomwp, couleur); // Ouvre l'éditeur avec les parametres 
});








function ouvrirEditeurWaypoint(cercle, nom, couleurParDefaut = null) {    // mis a jour 
    const waypointEditor = document.getElementById("waypointEditor");
    waypointEditor.style.display = "block";
    waypointEditor.classList.add("visible");

    const latLng = cercle.getLatLng();
    var lat = latLng.lat;
    var lon = latLng.lng;
    var rayon = cercle.getRadius() / 1852; // Conversion en NM
    var couleur = couleurParDefaut || cercle.options.fillColor; // Priorité à la couleur par défaut si fournie

    document.getElementById('wpName').textContent = nom;
    document.getElementById('wpLat').textContent = lat.toFixed(4);
    document.getElementById('wpLon').textContent = lon.toFixed(4);
    document.getElementById('wpRadius').value = rayon;
    document.getElementById('wpColor').value = couleur; // S'assurer que la couleur est bien affichée

    cercleSelectionne = cercle;    // ? 

    // Mise à jour du rayon en temps réel
    document.getElementById('wpRadius').oninput = function () {
        var newRayon = parseFloat(this.value);
        cercle.setRadius(newRayon * 1852);
    };

    // Mise à jour de la couleur en temps réel
    document.getElementById('wpColor').oninput = function () {
        var newCouleur = this.value;
        cercle.setStyle({ fillColor: newCouleur });
    };

    // sauvegarde du waypoint  si bouton savewaypoint
    document.getElementById("saveWaypoint").onclick = function () {
        console.log(' on est dans onclick savewaypoint') 
        ajouteWaypoint2(nom, lat, lon, parseFloat(document.getElementById('wpRadius').value), document.getElementById('wpColor').value);
        waypointSauve = true;
        afficheselectarrivee(waypoints,ari)
        fermerEditeurWaypoint();
    };
}







async function ajouteWaypoint2(nomwp,latwp,lonwp,rayonwp,colorwp){                                     //nouvelleversion 
    console.log ('On est dans ajoute waypoint ')
                           
        // console.log ('liste complete des waypoints avant ajout')   
        // console.log (waypoints)
        typeinfo='wp'
        typeaction ='insert',
        nouveauWP=[nbWP,nomwp,latwp,lonwp, rayonwp, 'yellow']
        nouveauWPStr=JSON.stringify(nouveauWP)
        message=await modifpersonalinfos(username,course,typeinfo,typeaction,nomwp,nouveauWPStr)
        waypoints.splice(waypoints.length - 1, 0, nouveauWP);
        nbWP+=1
        // console.log ('liste complete des waypoints apres ajout')   
        // console.log (waypoints)


        // //console.log ('nomWaypoints apres ajout  '+ nomsWaypoints)
        // console.log ('ari'+ari)   
    afficheselectarrivee(waypoints,ari)
  
    }





function ouvrirEditeurModifWaypoint(cercle, nom,couleurParDefaut = null) {
    const waypointEditor = document.getElementById("waypointEditor");
    waypointEditor.style.display = "block";
    waypointEditor.classList.add("visible");

    const latLng = cercle.getLatLng();
    var lat = latLng.lat;
    var lon = latLng.lng;
    var rayon = cercle.getRadius() / 1852; // Conversion en NM
    var couleur = cercle.options.fillColor; // Récupération de la couleur actuelle

    document.getElementById('wpName').textContent = nom;
    document.getElementById('wpLat').textContent = lat.toFixed(4);
    document.getElementById('wpLon').textContent = lon.toFixed(4);
    document.getElementById('wpRadius').value = rayon;
    document.getElementById('wpColor').value = couleur;
    cercleSelectionne = cercle; // Mettre à jour le cercle sélectionné

    // Mise à jour du rayon en temps réel
    document.getElementById('wpRadius').oninput = function () {
        var newRayon = parseFloat(this.value);
        cercle.setRadius(newRayon * 1852);
    };


  //  <td><input type="color" value="${route.couleur}" oninput="changerCouleurRoute(${i}, this.value)"></td>  

    // Mise à jour de la couleur en temps réel
    document.getElementById('wpColor').oninput = function () {
        var newCouleur = this.value;
        document.getElementById('wpColor').value=newCouleur
        console.log ('newCouleur '+newCouleur)
        cercle.setStyle({ fillColor: newCouleur });
    };



    document.getElementById("saveWaypoint").onclick = function () {
        wpRadius=parseFloat(document.getElementById('wpRadius').value)

        wpColor=document.getElementById('wpColor').value
        
        console.log (`on declenche miseajourwaypoint2 avec nom ${nom} lat${lat} lon${lon}  wpradius${wpRadius}  color ${wpColor}`)
        miseajourWaypoint2(nom, lat, lon, wpRadius, wpColor);
        waypointSauve = true;
        fermerEditeurWaypoint();
    };
}










async function miseajourWaypoint2(nomwp, newLat, newLon, newRayon,newColor)

{   
// cette fonction sert pour le cas de l insertion ou de la modification 
    let ordre = parseInt(nomwp.slice(2));                                                                        //mis ajour 
    console.log ('On est dans miseajourWaypoint2 ')
    console.log (`Dans miseajourwaypoint2 avec ordre ${ordre}  nom ${nomwp} lat${newLat} lon${newLon}  wpradius${newRayon}  color ${newColor}`)

    // la numerotation sera reprise 
    // on l ajoute dans le select ari 


    typeinfo='wp'
    typeaction ='modify',
    nouveauWP=[ordre,nomwp,newLat,newLon, newRayon, newColor]
    nouveauWPStr=JSON.stringify(nouveauWP)
    console.log ('WPStr modifié '+nouveauWPStr)
    message=await modifpersonalinfos(username,course,typeinfo,typeaction,nomwp,nouveauWPStr)
    waypoints[ordre-1]=nouveauWP       // on substitue les nouvelles valeurs dans les wp 
    //waypoints.splice(waypoints.length - 1, 0, nouveauWP);

    console.log (' ligne 1756 '+waypoints)

    afficheselectarrivee(waypoints,ari)

    }






function fermerEditeurWaypoint()
        {
            const waypointEditor = document.getElementById("waypointEditor");
            waypointEditor.style.display = "none";
            waypointEditor.classList.remove("visible");          
        }

window.fermerEditeurWaypoint = fermerEditeurWaypoint;


    


 // Gestionnaire pour le bouton "Supprimer" de l editeur 
 document.getElementById('deleteWaypoint').addEventListener('click', function() {
        console.log ('fonction de suppression activee')
        nomWP      =document.getElementById('wpName').textContent;
       
        let confirmation = window.confirm('Voulez-vous vraiment supprimer le waypoint '+nomWP+'?');
            if (confirmation) {
                //supprimerDuLocalStorage(nomwp);
                console.log ('on tente une suppression dans personalinfos2')
                //on va tenter une suppression dans personalinfos 
                typeinfo='wp'
                typeaction ='delete',
                valeur='rien'
                nom=nomWP
                message= modifpersonalinfos(username,course,typeinfo,typeaction,nom,valeur)
                console.log(message)
                // on supprime le waypoint de la variable liste des waypoints pour que ari soit affiche correctement 

                console.log ('liste waypoints avant suppression ' )
                console.log (waypoints)
                console.log ('waypoint a supprimer de la liste '+nomWP )

                let index = waypoints.findIndex(waypoint => waypoint[1] === nomWP);
                if (index !== -1) 
                { waypoints.splice(index, 1);
                    nbWP-=1;    
                }
                //waypoints.filter(waypoint => waypoint[1] !== nomWP);
                console.log ('liste waypoints apres suppression ' )
                console.log (waypoints)
                


                if (cercleSelectionne) {
                console.log('Ligne 493 Cercle à supprimer:', cercleSelectionne);
                // Supprimer le cercle de la carte
                console.log( 'ligne 495 '+WpCirclesLayer.hasLayer(cercleSelectionne))
                WpCirclesLayer.removeLayer(cercleSelectionne);
                cercleSelectionne = null; // Réinitialiser la sélection
               }  
               
                afficheselectarrivee(waypoints,ari)          
                fermerEditeurWaypoint()
            }
        });




function affichewaypoints2(personalInfosJS)
   {   // permet d afficher tous les waypoints  
       // Effacer les anciens cercles de la carte
       // Récupérer uniquement les valeurs des waypoints

if (personalInfosJS.wp) {
    Object.values(personalInfosJS.wp).forEach(cercleData => {     

    console.log("Valeurs du waypoint  dans affichewaypoints2 :", cercleData);

    let numero = cercleData[0];
    let nom   = cercleData[1];
    let lat   = cercleData[2];
    let lon   = cercleData[3];    
    let rayon = cercleData[4]; // Convertir le rayon en Mnautiques 
    let couleur =cercleData[5]

     let cercle = L.circle([lat, lon], {
            color: 'black',           // Couleur du bord
            weight:0.5,
            fillColor: couleur,      // Couleur de remplissage
            fillOpacity: 0.5,         // Opacité de remplissage
            radius:   rayon*1852,    // Rayon en mètresrayon*1852, 
            draggable: true,          // Rendre le cercle draggable
            indice :numero
        });

        // On lie l ouverture de l'éditeur de waypoint lorsque le cercle est cliqué
        cercle.on('click', function() {
            console.log ('click detecte sur le cercle ')
            console.log ('rayon au moment de louverture de l editeur de cercle'+rayon )
            cercleSelectionne = cercle; // Mettre à jour le cercle sélectionné
            rayon =cercle.getRadius()/1852
            ouvrirEditeurModifWaypoint(cercle, nom, lat, lon, rayon);
        });

        // On lie la Gestion des événements pendant le déplacement du cercle
        cercle.on('drag', function(event) {
            console.log ('click detecte sur le cercle ')
            console.log ('rayon au moment de louverture de l editeur de cercle'+rayon )
            cercleSelectionne = cercle; // Mettre à jour le cercle sélectionné
            ouvrirEditeurModifWaypoint(cercle, nom, lat, lon, rayon);
            newLatLng = event.target.getLatLng();
            newlat=newLatLng.lat
            newlon=newLatLng.lng           
            document.getElementById('wpLat').textContent = newLatLng.lat.toFixed(4);
            document.getElementById('wpLon').textContent = newLatLng.lng.toFixed(4);
 

         });

         cercle.bindTooltip(nom).addTo(WpCirclesLayer); //Ajouter le cercle au LayerGroup

      });    // fin du foreach 

      WpCirclesLayer.addTo(map);

}// fin du if
   }   //fin de affichewaypoints2

  


//**********************************************************************************************************************************
//**********    Chargement des cartes                                          ********************************************
//**********************************************************************************************************************************


let cartesAffichees = false; // État global
window.chargecartes = () => {chargecartes()}


async function chargecartes(){

    console.log ('on est dans chargecartes')
    if (cartesAffichees) {
        // Masquer les cartes
        cartesLayer.clearLayers()    
        
    }
else{
poly3=polyglobal.flat().flat().flat()
let Position=[y0vr,x0vr];
polylineCurve.unshift(Position)
poly4=polylineCurve.concat(poly3)




// let url = serveur + "/chargecarte?points=" + JSON.stringify(poly4)
// let response = await fetch(url);


let url = serveur + "/chargecarte";

let response = await fetch(url, {
    method: "POST",
    headers: {
        "Content-Type": "application/json"
    },
    body: JSON.stringify({ points: poly4 }) // Envoi en tant qu'objet JSON
});







if (!response.ok) { throw new Error('Problème dans la sauvegarde de la route : ' + response.statusText); }
   let data = await response.json();
   let cartevr= data.carte 

   console.log ('cartevr'+cartevr)
   let polycarte = L.polyline(cartevr, { weight:1 ,color:'blue' }).addTo(cartesLayer);
   cartesLayer.addTo(map) }

   cartesAffichees = !cartesAffichees; // Inverser l'état
} 





//**********************************************************************************************************************************
//**********************************************************************************************************************************
//**********    Gestion de l editeur de routes                                          ********************************************
//**********************************************************************************************************************************

var routageLayer = L.layerGroup().addTo(map);
var polylines = {}; // Objet pour stocker les polylines
let routes = [];  // Tableau global contenant toutes les routes



function getRandomColor() {
    return "#" + Math.floor(Math.random()*16777215).toString(16); // Génère une couleur hexadécimale aléatoire
}



window.EditeurRoutes = () => {ouvrirEditeurRoutes()}
function ouvrirEditeurRoutes() 
            // Fonction pour ouvrir l'éditeur de waypoint
        {
            console.log (' Demande affichage ouvrirEditeurRoutes l 1941 ')
            const RoutesEditor = document.getElementById("RoutesEditor");
            RoutesEditor.style.display = "block";
            document.getElementById("RoutesEditor").classList.add("visible");         
        };




window.fermerEditeurRoutes = () => {
            const RoutesEditor = document.getElementById("RoutesEditor");
            RoutesEditor.style.display = "none";
            RoutesEditor.classList.remove("visible");
        }


window.sauveroute = async () => {
    console.log('On est dans sauveroute');
    try {
        await sauveRouteServeur2();  // Attente de la sauvegarde
        mettreAJourTableau();  // Mise à jour de l'affichage après la sauvegarde
    } catch (error) {
        console.error('Erreur lors de la sauvegarde : ', error);
        alert("Erreur lors de la sauvegarde : " + error.message);
    }
};



window.afficherroute = function(i) {
    if (i < 0 || i >= routes.length) {
        console.error("Index invalide :", i);
        return;
    }

    let route = routes[i];

    if (!route.layer) { // Si la polyline n'existe pas encore
        console.log(`Affichage de la route : ${route.nom}`);

        let polylineLeaflet = L.polyline(route.polyline, { color: route.couleur ,weight:1 }).addTo(map);
        routes[i].layer = polylineLeaflet; // Stocke la référence dans routes[i]
    } else if (!map.hasLayer(route.layer)) {
        map.addLayer(route.layer);
    }
};




window.effacerroute = function(i) {
    if (i < 0 || i >= routes.length) {
        console.error("Index invalide :", i);
        return;
    }

    let route = routes[i];
    console.log(`Effacement de la route : ${route.nom}`);

    if (route.layer && map.hasLayer(route.layer)) {
        map.removeLayer(route.layer);
        console.log(`Route ${route.nom} supprimée de la carte`);
    } else {
        console.warn(`La route ${route.nom} n'est pas affichée ou n'existe pas`);
    }
};



window.exporterroute = function(i) {
    exporterroute(i)
}


window.supprimerroute = function(i) {
    let nom = routes[i].nom;
    console.log('Username:', username);
    console.log('Course:', course);
    console.log('Nom du routage à supprimer:', nom);
    supprimerroute(i);
};







  function genererNomRoutage() {
    let now = new Date();
    let jour = String(now.getDate()).padStart(2, '0');
    let mois = String(now.getMonth() + 1).padStart(2, '0'); // Les mois commencent à 0
    let heure = String(now.getHours()).padStart(2, '0');
    let minute = String(now.getMinutes()).padStart(2, '0');
    return `Routage ${jour}/${mois} ${heure}:${minute}`;
}





async function sauveRouteServeur2() {
    typeinfo = 'routage';
    typeaction = 'insert';
    console.log('Sauvegarde de la route sur le serveur dans personalinfos2');
    nbRoutes=routes.length
    let color = colorhex[nbRoutes % colorhex.length];
    console.log (color)

    let nomRoutage = document.getElementById('nomRoutage').value;

    // Vérification des valeurs avant de sauvegarder
    if (!nomRoutage || !eta || !dureeparcours || !polyglobal) {
        alert("Données incomplètes pour sauvegarder la route.");
        return;
    }

    // Création de l'objet JSON pour la nouvelle route
    let nouvelleRoute = {
        nom: nomRoutage,
        eta: eta,
        duree: dureeparcours,
        couleur:color,
        polyline: polyglobal
    };

    try {
        let message = await modifpersonalinfos(username, course, typeinfo, typeaction, nomRoutage, JSON.stringify(nouvelleRoute));
        console.log('Sauvegarde réussie : ', message);
        alert('Route sauvegardée avec succès !');

        // ✅ Ajout de la nouvelle route à `routes` localement
        routes.push(nouvelleRoute);

        // ✅ Mise à jour immédiate de l'affichage
        mettreAJourTableau();
    } catch (error) {
        console.error('Erreur lors de la sauvegarde : ', error);
        alert('Échec de la sauvegarde : ' + error.message);
    }
}





function mettreAJourTableau() {
    console.log('Mise à jour du tableau des routes');

    let texte = `<table id="tableRoutes">
                    <tr>
                        <th class="colDouble">Nom</th>
                        <th>ETA</th>
                        <th>Durée</th>
                        <th>Couleur</th>
                        <th colspan="4">Actions</th>
                    </tr>`;

    for (let i = 0; i < routes.length; i++) {
        let route = routes[i];
        let couleur = colorhex[i % colorhex.length]; // Sélection avec modulo

        texte += `
        <tr>
            <td class="colDouble">${route.nom}</td>
            <td>${route.eta}</td>
            <td>${formatDuree(route.duree)}</td>            
            <td><input type="color" value="${route.couleur}" oninput="changerCouleurRoute(${i}, this.value)"></td>  
            <td><button onclick="afficherroute(${i})">Afficher</button></td>
            <td><button onclick="effacerroute(${i})">Masquer</button></td>
            <td><button onclick="supprimerroute(${i})">Supprimer</button></td>
            <td><button onclick="exporterroute(${i})">Export GPX</button></td>
        </tr>`;
    }

    texte += `</table>`;
    document.getElementById('tableroutages').innerHTML = texte;
}



window.changerCouleurRoute = async function(i, nouvelleCouleur) {
    console.log(`Changement de couleur pour la route ${routes[i].nom} -> ${nouvelleCouleur}`);

    // Mise à jour de la couleur dans `routes`
    routes[i].couleur = nouvelleCouleur;

    // 🟢 Vérifier si la polyline est affichée et mettre à jour immédiatement
    if (routes[i].layer && map.hasLayer(routes[i].layer)) {
        routes[i].layer.setStyle({ color: nouvelleCouleur });
        console.log(`Couleur de la route ${routes[i].nom} mise à jour sur la carte.`);
    }

    // 🟢 Sauvegarde de la modification sur le serveur
    try {
        let typeinfo = 'routage';
        let typeaction = 'modify';
        let nomRoutage = routes[i].nom;

        let nouvelleRoute = { 
            nom: nomRoutage,
            eta: routes[i].eta,
            duree: routes[i].duree,
            couleur: nouvelleCouleur,
            polyline: routes[i].polyline
        };

        let message = await modifpersonalinfos(username, course, typeinfo, typeaction, nomRoutage, JSON.stringify(nouvelleRoute));
        console.log(`Mise à jour réussie : ${message}`);
    } catch (error) {
        console.error('Erreur lors de la mise à jour de la couleur : ', error);
        alert('Échec de la mise à jour de la couleur.');
    }
};












function recupereRoutes(personalInfosJS) {
    routes = [];  // Réinitialisation avant de charger de nouvelles routes

    if (personalInfosJS.routage) {
        for (const key in personalInfosJS.routage) {
            if (personalInfosJS.routage.hasOwnProperty(key)) {
                const routage = personalInfosJS.routage[key];
                //console.log ('ligne 2179 '+routage.polyline)   (un par routage)
                routes.push({
                    nom: routage.nom,
                    eta: routage.eta,
                    duree: routage.duree,
                    couleur:routage.couleur,
                    polyline: routage.polyline
                });
            }
        }
    }
    console.log("Routes chargées :", routes);
    mettreAJourTableau(); // ✅ Mise à jour de l'affichage avec les données chargées
}







async function supprimerroute(i) {    

    if (i < 0 || i >= routes.length) {
        console.error("Index invalide :", i);
        return;
    }

    let nom = routes[i].nom;
    console.log(`Suppression de la route ${nom} sur le serveur dans personalinfos2`);

    try {
        // 1️⃣ **Supprime la route sur le serveur**
        let message = await modifpersonalinfos(username, course, 'routage', 'delete', nom, ' ');
        console.log("Réponse du serveur:", message);

        // 2️⃣ **Supprime la polyline de la carte si elle existe**
        if (polylines[nom]) {
            map.removeLayer(polylines[nom]); 
            delete polylines[nom]; 
            console.log(`Polyline ${nom} supprimée`);
        }

        // 3️⃣ **Supprime la route du tableau local**
        routes.splice(i, 1);

        // 4️⃣ **Met à jour l'affichage**
        mettreAJourTableau();
        console.log(`Route ${nom} supprimée localement`);

    } catch (error) {
        console.error("Erreur lors de la suppression :", error);
        alert("Échec de la suppression : " + error.message);
    }
}



async function exporterroute(i){
    let route = routes[i];   
    let points= route.polyline[0].flat()
    //    console.log (points)
    nom=route.nom
    exportGPX(points,nom);

}



//**********************************************************************************************************************************
//**********    Affichage de la Flotte                                                  ********************************************
//**********************************************************************************************************************************

let flotteCercles = []; // Tableau pour stocker les cercles affichés

async function toggleFlotte() {
    if (flotteCercles.length > 0) {
        // Si la flotte est déjà affichée, on l'efface
        flotteCercles.forEach(circle => map.removeLayer(circle));
        flotteCercles = [];
        console.log("Flotte effacée");
    } else {
        // Sinon, on la charge et l'affiche
        console.log('Chargement de la flotte...');
        try {
            let url = `${serveur}/rechercheflotte?id_user=${userId}&course=${course}`;
            let response = await fetch(url);
            if (!response.ok) throw new Error('Problème dans rechercheflotte ' + response.statusText);

            let data = await response.json();
            console.log('Données reçues :', data.message);
            console.log(data.fleetinfos)
            let flotte = JSON.parse(data.fleetinfos);
            flotteCercles = flotte.map(boat => {
                let colorboat = (boat[1] === 'top') ? 'yellow' : (boat[9]  ? 'red' : 'blue');
                return L.circle([boat[2], boat[3]], {
                    fillColor: colorboat, color: colorboat,
                    weight: 1, opacity: 1, fillOpacity: 1, radius: 200
                }).bindTooltip(boat[0]).addTo(map);
            });

            console.log("Flotte affichée");
        } catch (error) {
            console.error(error);
        }
    }
}

// Associe la fonction au bouton
document.getElementById("afficheflotte").addEventListener("click", toggleFlotte);


// window.afficheFlotte = () => {afficheFlotte()}
// async function afficheFlotte()      // Fonction pour afficher la flotte
//         {
//          console.log('On est dans la fonction affiche flotte')
//         console.log('user_id '+userId+ ' Course '+course)
//         let message = await chercheflotte(userId, course);
//         };


// async function chercheflotte(userId, course){
//     url=serveur+"/rechercheflotte?id_user="+userId+"&course="+course
//     let response = await fetch(url);            
//     if (!response.ok) { throw new Error('Probleme dans rechercheflotte ' + response.statusText);    }
//          let data = await response.json();
//          console.log('data \n'+data.message)
//          flotte=JSON.parse(data.fleetinfos)
//          console.log(flotte)
//          for (let i = 0; i < flotte.length; i++) {
//             if (flotte[i][1]=='top') {colorboat='yellow'}
//             if (flotte[i][9]=='true') {colorboat='red'}
//             else  {colorboat='red'}
//           //  console.log(flotte[i][2])
//             L.circle([flotte[i][2],flotte[i][3]] ,{fillColor: colorboat ,color:colorboat , weight:1 ,opacity:1,fillOpacity:1 ,radius: 200}).bindTooltip(flotte[i][0]).addTo(map)                                                              
//         }

// }




//**********************************************************************************************************************************
//**********    Gestion des Zones exclusion persos                                                  ********************************************
//**********************************************************************************************************************************

let zonePoints = [];
let polygon    = null;
let isDrawing  = false; // Indique si le tracé est actif


window.EditeurExclusions = () => {ouvrirEditeurExclusions()}
function ouvrirEditeurExclusions()      // Fonction pour ouvrir l'éditeur de waypoint
        {
            const exEditor = document.getElementById("exEditor");
            exEditor.style.display = "block";
            mettreAJourListeZones() // on ajoute la liste des zones  dans les zones existates
            document.getElementById("exEditor").classList.add("visible");
        };
      

window.startDrawing = () => {
    isDrawing = true;
    zonePoints = [];
    if (polygon) {
    map.removeLayer(polygon);
    polygon = null;
    }
    alert('Cliquez sur la carte pour ajouter des points à la zone.');
    };



// Ajout d'un listener sur les clics pour définir les points
map.on('click', (e) => {
    if (!isDrawing) return; // Ignore les clics si le tracé est terminé
      const { lat, lng } = e.latlng;
      zonePoints.push([lat, lng]);
      if (polygon) {
        polygon.setLatLngs(zonePoints);
      } else {
        polygon = L.polygon(zonePoints, { color: 'blue', weight: .8,fillcolor:'blue',opacity:0.2 }).addTo(map);
      }
    });



window.finishDrawing = () => {
  if (zonePoints.length > 2) {
    polygon.setLatLngs([...zonePoints, zonePoints[0]]); // Fermer la zone
    isDrawing = false; // Désactiver le tracé
    zonePoints.push(zonePoints[0]);
    createZone(zonePoints)
    alert('Tracé terminé.');
  } else {
    alert('Vous devez sélectionner au moins trois points pour créer une zone.');
  }
};



window.deleteDrawing = () => {
  if (polygon) {
    map.removeLayer(polygon); // Supprimer le polygone de la carte
    polygon = null; // Réinitialiser la référence
    zonePoints = []; // Vider les points
    isDrawing = false; // Désactiver le tracé
  } else {
    alert('Aucun tracé à supprimer.');
  }
 
}



window.fermerEx= () => {
console.log ('Bouton supprimer la Zone declenché')
nomZone=document.getElementById('dynamicSelect').value
console.log ('Bouton supprimer la Zone declenché avec nom de zone '+nomZone )
deleteZone(username,course,nomZone)
}


window.fermerEditeurEx = () => {
            const exEditor = document.getElementById("exEditor");
            exEditor.style.display = "none";
            exEditor.classList.remove("visible");
        }



async function createZone(zonepoints){
// sauve la zone danspersonalinfos2 

nomZone       = document.getElementById('nomNewZone'  ).value
zonePointsStr = JSON.stringify(zonepoints)
console.log('sauvegarde des points sur le serveur ')
console.log ('zonepoints')
console.log ('Nom de la Zone d exclusions : '+nomZone)
console.log ('points '+zonepoints)

// on va sauver dans personalinfos2
typeinfo   = 'exclusions'
typeaction = 'insert',
nom        = nomZone
valeur     = zonePointsStr
console.log (` Pour ${username} sur ${course} Action ${typeaction} de ${typeinfo} nom  ${nomZone} valeur  ${valeur} `)
message=await modifpersonalinfos(username,course,typeinfo,typeaction,nom,valeur)
console.log(message)


let polygone = L.polygon(zonepoints)
                .setStyle({ color: 'black', fillColor: 'blue', weight: 0.5, fillOpacity: 0.2 })
                .bindTooltip(nomZone, { permanent: false, direction: "center", className: "zone-tooltip" })
                .on("click", () => ouvrirEditeurExclusions(nomZone, zonepoints)) // 🔹 Ouvrir l'éditeur sur clic
                .addTo(layerExclusions);

            listeZones.push(nomZone); 

            console.log (' ligne 2425 Listezones apres ajout  '+listeZones )
            zonesPolygones[nomZone] = polygone; 
            exclusionsMap.set(nomZone, polygone);
mettreAJourListeZones()
}







async function deleteZone(username, course, nomZone) { 
    // Supprimer une zone (mise à jour carte + liste)
    console.log("Suppression de la zone :", nomZone);

    // Suppression dans la base
    let typeinfo = 'exclusions';
    let typeaction = 'delete';
    let nouvelleZone = '';

    let message = await modifpersonalinfos(username, course, typeinfo, typeaction, nomZone, nouvelleZone);

    // Si la suppression est confirmée, retirer de la carte et mettre à jour la liste
   // if (message.success) { // 🔹 Supposons que `message.success` indique la réussite
        if (zonesPolygones[nomZone]) {
            layerExclusions.removeLayer(zonesPolygones[nomZone]); // 🔹 Supprimer de la carte
            delete zonesPolygones[nomZone]; // 🔹 Supprimer du stockage des polygones
        }
        listeZones = listeZones.filter(zone => zone !== nomZone); // 🔹 Mise à jour de listeZones
        console.log("Zones restantes :", listeZones);
  //  }

    mettreAJourListeZones()
}




function mettreAJourListeZones() {
   // let listeZones = Array.from(exclusionsMap.keys());
    console.log('ligne 2417 listeZones'+ listeZones) 

    let texte = '';
    for (let i = 0; i < listeZones.length; i++) {
        texte += '<option value="' + listeZones[i] + '">' + listeZones[i] + '</option>';
    }
    document.getElementById('dynamicSelect').innerHTML = texte;
    }








//***************************************************************************************************************
//********  Gestion boite jaune                                                    ******************************
//***************************************************************************************************************
//Dupliquer progsvr
// affichertableau
//ajouterligne
//supprimerligne
// initialiser les gestionnaires ajouter et supprimer





var dupliquerprogsvr=document.getElementById('dupliquerprogsvr') 
    dupliquerprogsvr.addEventListener("click", function (evt)
    { 
    console.log ('Bouton de duplication cliqué')
    console.log ('id_user '+id_user)
    console.log ('course '+course)
    //programmationsvr=chercheprogsserveur(id_user,course)
    console.log ('programmationsvr issues de la demande de duplication' )
    console.log (programmationsvr  )
    programmationsvrjaunes= [].concat(programmationsvr)
    afficherTableau3(programmationsvr)
    let voileautojaunes=document.getElementById('voileautojaunes')
    
    voilesauto=voileautojaunes.checked 
    calculeroute(id_user,course,programmationsvr,voilesauto)
    });







function afficherTableau3(progra) {
    let texte = '';
    texte+=`<div class='progsvr' > <span class= 'col120' > Progs Jaunes </span>
    <span class= 'col30' ><input type='checkbox' id='showprogsvrjaunes' name='showprogsvrjaunes'  checked    /></span>
    <span class= 'col120' >Voiles Auto jaunes</span>
    <span class= 'col30' ><input type='checkbox' id='voileautojaunes' name='voileautojaunes'  checked    /></span>
    </div>`  

    if (!Array.isArray(progra) || progra.length === 0) {
        // Si programmationsvr n'est pas un tableau ou est vide, on affiche un message ou on ne fait rien
        texte = 'Aucune donnée disponible.';      
    }    
    else {
            progra.forEach((ligne, i) => {
            let [unixTime, option, valeur] = ligne;
            //console.log (ligne)
            // Recalculer heure et minutes à partir du timestamp Unix
            const date  = new Date(unixTime * 1000); // Conversion en millisecondes
            const heure = date.getHours(); // Heure locale
            const mn    = date.getMinutes(); // Minutes locales

            // Déterminer la classe et l'option sélectionnée
            let classcolor, selected;
            if (option ===  1 ) { classcolor = 'green' ; selected = 0; }
            if (option === -1 ) { classcolor = 'red'   ; selected = 1; }
            if (option ===  0 ) { classcolor = 'purple'; selected = 2; }

            // Construire la ligne HTML
            texte += `
                A <input class="classinput" id="heureprog${i}" type="number" min="0" max="24" step="1" value="${heure}">
                H <input class="classinput" id="mnprog${i}" type="number" min="0" max="60" step="1" value="${mn}">
                <span class="col20"></span>
                <select id="twacap${i}" class="black">
                    <option value="Twa+" ${selected === 0 ? "selected" : ""}>Twa+</option>
                    <option value="Twa-" ${selected === 1 ? "selected" : ""}>Twa-</option>
                    <option value="Cap" ${selected === 2 ? "selected" : ""}>Cap</option>
                </select>
                <input type="number" id="valtwacap${i}" class="${classcolor}" min="0" max="${selected === 2 ? 360 : 180}" step="1" value="${Math.abs(valeur)}">
                <span class="col20"></span>
                <button class="black12 add-row" data-index="${i}">+</button>
                <button class="black12 remove-row" data-index="${i}">-</button>
                <br>
            `;
        });

     // Insérer le tableau dans un conteneur HTML (par exemple, une div avec id="boitejaune")
        document.getElementById('boitejaune').innerHTML = texte;
        const showprogsvrjaunes=document.getElementById('showprogsvrjaunes')
        showprogsvrjaunes.addEventListener('change', toggleshowprogsLayerJaune())


//gestionnaire d 'evenements pour changement voileauto 
        document.getElementById('voileautojaunes').addEventListener('change', function() {
        voilesauto=voileautojaunes.checked 
        calculeroute(id_user,course,progra,voilesauto);
        });
       }
    }





// Fonction pour ajouter une ligne au tableau en dessous de la ligne selectionnée 
function ajouterLigneT3(index) {
    // Déterminer un timestamp Unix pour une nouvelle ligne (par exemple, l'heure actuelle)
    console.log ('programmationsvrjaunes')
    console.log (programmationsvrjaunes)
    console.log (programmationsvrjaunes[0])
    let timeplus60=programmationsvrjaunes[index][0]+600
    let optionplus=programmationsvrjaunes[index][1]
    let valeurplus=programmationsvrjaunes[index][2]
    const nowUnix = Math.floor(Date.now() / 1000); // Timestamp Unix en secondes
    //programmationsvrjaunes.splice(index + 1, 0, [nowUnix, 0, 0]);
    programmationsvrjaunes.splice(index + 1, 0, [timeplus60,optionplus, valeurplus]);
    // Rafraîchir l'affichage
    afficherTableau3( programmationsvrjaunes);
}





// Fonction pour supprimer une ligne du tableau
function supprimerLigneT3(index) {
    console.log ('Bouton de suppression  cliqué')
    if (programmationsvrjaunes.length >=1) {
        programmationsvrjaunes.splice(index, 1); // Supprime la ligne à l'index donné

        // Rafraîchir l'affichage
        console.log ('index de la ligne a supprimer '+index)
        console.log ('programmationsvrjaunes apres suppression ')
        console.log (programmationsvrjaunes)
        afficherTableau3(programmationsvrjaunes);
    } else {
        alert("Vous ne pouvez pas supprimer la dernière ligne.");
    }
}




// Gestionnaire d'événements pour les boutons Ajouter et Supprimer
function initialiserEvenementsT3() {
    document.getElementById('boitejaune').addEventListener('click', (event) => {
        if (event.target.classList.contains('add-row')) {
            const index = parseInt(event.target.dataset.index, 10);
            ajouterLigneT3(index);
        } else if (event.target.classList.contains('remove-row')) {
            const index = parseInt(event.target.dataset.index, 10);
            supprimerLigneT3(index);
        }
    });
}



function recupererDonnees() {
    console.log ('on est dans recupererdonnees')
            // Récupérer les données des inputs actuels
            donneesprog = donneesprog.map((_, i) => {
            const twacap = document.getElementById(`twacap${i}`).value;
            const valeur = parseInt(document.getElementById(`valtwacap${i}`).value);
            const heure  = parseInt(document.getElementById(`heureprog${i}`).value);
            const mn     = parseInt(document.getElementById(`mnprog${i}`).value);    
            let option;
            if (twacap === "Twa+") option = 1;
            else if (twacap === "Twa-") option = 1;
            else option = 0;
            const valeurFinale = twacap === "Twa-" ? -valeur : valeur;
            return [heure, mn, option, valeurFinale];

            });
            console.log(" Ligne 928 Données récupérées******************************************** :", donneesprog);
            return donneesprog;
        }











initialiserEvenementsT3()






var boitejaune=document.getElementById('boitejaune') 
boitejaune.addEventListener("change", function (evt){
        console.log('changement dans boite jaune')
        if (evt.target.matches('[id^="heureprog"], [id^="mnprog"], [id^="twacap"], [id^="valtwacap"]')) {
        let timer = null; // Timer pour le déclenchement différé
        clearTimeout(timer); // Annule le timer existant
        timer = setTimeout(() => {
        const jourEnCours = Math.floor(new Date().setHours(0, 0, 0, 0) / 1000); // Timestamp Unix pour minuit du jour en cours
        const programmations = []; // Tableau pour stocker les données transformées
        const lignes = document.querySelectorAll('.classinput[id^="heureprog"]'); // Sélectionne les champs de saisie des heures
        lignes.forEach((ligne, i) => {
            const heure   = parseInt(document.getElementById(`heureprog${i}`).value);
            const minutes = parseInt(document.getElementById(`mnprog${i}`).value);
            const option  = document.getElementById(`twacap${i}`).value;
            const valeur  = parseFloat(document.getElementById(`valtwacap${i}`).value);
            const optionCode = option === 'Twa+' ? 1 : option === 'Twa-' ? -1 : 0; // Transformer l'option en format attendu
            const valeurCorrigee = optionCode === 0 ? valeur : valeur;      //* optioncode;
            let unixTime = jourEnCours + heure * 3600 + minutes * 60;            // Calcul du timestamp Unix


            if ( i>=1  && unixTime<programmations[i-1][0] ) {   console.log ('On est dans le jour +1'); unixTime+=86400}
            programmations[i]=     [ unixTime,optionCode,valeurCorrigee]})
        console.log ('programmations : ')
        console.log (programmations)
     

      

        let voileautojaunes=document.getElementById('voileautojaunes')
        voilesauto=voileautojaunes.checked 
        console.log ('\n Ligne 2550 Voileautojaune  '+voilesauto )

        calculeroute(id_user,course,programmations,voilesauto) // on envoie sur l appele ajax 
          }, 1000); // Délai de 1 seconde
        }




        if (evt.target.matches('[id^="show"]')) {
           console.log ('changement detecte sur  check boite jaune')
           if (showprogsvrjaunes.checked) { progsvrLayerJaune.addTo(map); } // Ajouter le layer à la carte   


           else                           {  map.removeLayer(progsvrLayerJaune);}// Retirer le layer de la carte
    
        }
        });



        document.getElementById('voilesautovr').addEventListener('click', function(event) {
    event.preventDefault();
});

document.getElementById('twaauto').addEventListener('click', function(event) {
    event.preventDefault();
});



// gestionnaire d 'evenements pour changement voileauto 
// document.getElementById('voileautojaunes').addEventListener('change', function() {
//     voilesauto=voileautojaunes.checked 
//     calculeroute(id_user,course,programmations,voilesauto);
//      });

// async function calculeroute(id_user,course,programmations)
// {

// // avant d envoyer la demande de calcul au serveur on uniformise la premiere date jaune avec les programmations rouges

// console.log(' ligne 706 heure de la premiere programmation jaune ' + hmns.format(programmations[0][0]*1000))
// console.log(' ligne 706 heure de la premiere programmation rouge ' + hmns.format(heurePremiereProg*1000))


// programmations[0][0]=heurePremiereProg
// const progs5 = JSON.stringify(programmations);        // pour envoi par url 

// url=serveur+"/calculroute?username="+username+"&id_user="+id_user+"&course="+course+"&programmations="+progs5
//         let response = await fetch(url);            
//         if (!response.ok) { throw new Error('Probleme dans calculroute ' + response.statusText);    }
//         let data = await response.json();
//         polylineprog=data.polylineprog
//         afficheligneprogsjaunes(polylineprog)// il n y a plus qu a tracer 
// }





//***************************************************************************************************************
//********  Exemples gestion personalinfos2                                  ******************************
//***************************************************************************************************************






// console.log ('infos   par personalinfos 2 '+infos)
// infos=JSON.parse(infos)
// waypoints2=infos['wp']
// console.log ('waypoints2  '+waypoints2 ['wp1'])

// //on va tenter une insertion  de personalinfos 

//on va tenter une suppression dans personalinfos 
// typeinfo='wp'
// nom='wp1'
// typeaction ='delete',
// valeur='rien'
// message=await modifpersonalinfos(username,course,typeinfo,typeaction,nom,valeur)
// console.log(message)



// typeinfo='wp'
// typeaction ='insert',
// nom='wp1'
// valeur=JSON.stringify([1, 48.3753, -7.46093, 'WP1', 20, 'yellow'])
// message=await modifpersonalinfos(username,course,typeinfo,typeaction,nom,valeur)
// console.log(message)

//on va tenter une suppression dans personalinfos 
// typeinfo='wp'
// typeaction ='delete',
// valeur='rien'
// message=await modifpersonalinfos(username,course,typeinfo,typeaction,nom,valeur)
// console.log(message)


// //on va tenter une modification dans personalinfos 
// typeinfo='wp'
// nom='wp1'
// typeaction ='modify',
// valeur=JSON.stringify([1,"WP1", 48.3753, -7.46093,  20, "yellow"])

// message=await modifpersonalinfos(username,course,typeinfo,typeaction,nom,valeur)
// console.log(message)
// let data = await recherchepersonalinfos2(username,course)
// console.log ('Nouvelles valeurs infos   par personalinfos 2 '+infos)











//***************************************************************************************************************
//********  Programme proprement dit main                                   ******************************
//***************************************************************************************************************

async function maindash(posStart){

// console.log ('on est dans maindash')
// console.log (JSON.stringify(posStart))
username=posStart.username
teamname=posStart.teamname
race=posStart.race
leg=posStart.leg
tws=posStart.tws
twd=posStart.twd
twa=posStart.twa
y0=posStart.lat
x0=posStart.lon
t0=posStart.t0
user_id=posStart.user_id
legStartDate=posStart.legStartDate
last_seen_rank=posStart.last_seen_rank
state=posStart.state
speed=posStart.speed
twaAuto=posStart.twaAuto
sail=posStart.sail
polar_id=posStart.polar_id
stamina=posStart.stamina
lastCalcDate=posStart.lastCalcDate
gateGroupCounters=posStart.gateGroupCounters
heading=posStart.heading
rank=posStart.rank
tsLastAction=posStart.tsLastAction
t0=posStart.t0


course=race+'.'+leg

//on initialise un trajet en localstorage



}


async function main(){
// recupere toutes les infos et affiche mais ne fait rien     
    
 // On commence par aller chercher sur Local storage la dernière course enregistrée 
tabNameCourses=await chercheracesinfos() // independant de tout  deja charge dans initialize
if (sourceinfos!='dash'){trouvederniertrajet ()}   // trouve le dernier trajetpour le charger
console.log (`Utilisateur ${username} sur course ${course}\n*****************************************************`)  
// Si le bateau Inconnu le selectdepart est le depart et  le selectarrivee est l arrivee de la premiere course  
var selectini=username=='Bateau Inconnu'?1:0;       // position vr par defaut 
document.getElementById('idusername').value= username 
// on affiche le selectcourse   
let tabValeurs = tabNameCourses.map(subArray => subArray[0]);
let tabNoms    = tabNameCourses.map(subArray => subArray[1]);
let coursesUser = await cherchecoursesuser(username) // on cherche les courses en cours du username
    if ( coursesUser ==null )   //si l utilisateur est Bateau Inconnu on lui a attribué une course d'office 
    { // on est dans le cas d'un nouveau bateau ou de bateau inconnu qui n a pas encore de courses repertoriées 
          course=tabNameCourses[0][0];
          coursesUser=[course] 
    }      
var selectcourse  = generateSelect( 'idcourse',tabValeurs,tabNoms, coursesUser, course,'limited-width-select-200') 
document.getElementById('idselectcourse').innerHTML= selectcourse

    


//****************************************************************************
// ********** On recherche les personalinfos
//****************************************************************************

personalInfosStr = await recherchepersonalinfos2(username,course)
personalInfosJS = JSON.parse(personalInfosStr);
console.log (`Recuperation de PersonalInfos  pour ${username}  course ${course}`)
// console.log (`PersonalInfos  pour ${username} sur la course ${course}\n*************************************************\n${personalInfosStr}`)
// console.log('*****************************************************')    


affichewaypoints2(personalInfosJS)
waypoints     = Object.values(personalInfosJS.wp).sort((a, b) => a[0] - b[0]);
nomsWaypoints = waypoints.map(item => item[1]);
ari=personalInfosJS['ari']

afficheZonesExclusions (personalInfosJS)
recupereRoutes(personalInfosJS)              


afficheselectarrivee(waypoints,ari)// on affiche le select arrivee avec les waypoints et ceux selectionnes  
// ici on peut afficher les coordonnneses du dernier wp selectionné qui est le dernier element de ari 
nomdernierwp=ari[ari.length-1]                                        // nom du dernier wp
waypoint = waypoints.find(waypoints => waypoints[1] === nomdernierwp) // on le recherche dans la liste 
y1=waypoint[2]
x1=waypoint[3]
document.getElementById('iddernierwp').innerHTML=nomdernierwp
affichecoordsari(y1,x1)

// pour pouvoir numeroter les waypoints 
nbWP = personalInfosJS.wp ? Object.keys(personalInfosJS.wp).length : 0;
console.log ( 'nbWP : '+nbWP)



//****************************************************************************
//****************************************************************************

// on affiche le select depart 
tabNoms=['Position VR - Heure VR ','Coordonnées / Heure Manuelle ','Coordonnées / Heure Depart ' ]
tabValeurs=[0,1,2]
grises =[]
selectdepart  = generateSelect( 'iddepart',tabValeurs,tabNoms, grises, selectini,'limited-width-select-100') 
document.getElementById('idselectdepart').innerHTML= selectdepart
    
// on va chercher leginfos      qui donne les particularites de la course 
// problème si la course n a jamais ete initiee   a voir dans chgt course 
   leginfos        = await chercheleginfos(course) 
   console.log (`leginfos recuperees \n*******************\n`)
//   console.log (leginfos)

// On va chercher les donnees les plus recentes sur le bateau 
   boatinfosdata       = await chercheboatinfos(username,course)
//    console.log (`boatinfosdata recuperees \n********************\n`)
//    console.log ('boatinfosdata ' +boatinfosdata)
//    console.log ('boatinfosdata keys ' +Object.keys(boatinfosdata))
   console.log ('boatinfosdata.result'+boatinfosdata.result)
   boatinfosJSON=JSON.parse (boatinfosdata.result)
   user_id=boatinfosJSON['bs']['_id']['user_id']
   console.log (user_id)

// on les affiche 
if (boatinfosdata.result==null){/*utilisateurinconnu()*/console.log('Utilisateur inconnu ') ; affichecoordsdep(ycoord,xcoord) }

afficheboatinfos (boatinfosdata)  
 

 // on va chercher progsvr       qui donne la dernière  programmations enregistrées pour le user et la course 
   try{   await chercheprogsvr(user_id,course,t0routage)  }                 
   catch{console.log('Probleme dans la recuperation de progsvr')}
    
  
   map.panTo([y0vr,x0vr])               // on centre la carte 
   afficheleginfos  (leginfos) 
     

//  les valeurs pour les voiles et le vent sont traitees avec l affichage boatinfos 

/// Partie relative au websocket 
//**********************************************************************************************************
console.log (' user_id '+ user_id)



client_id = user_id



const socket = io(serveur, { query: { client_id } });


socket.on("connect",    () => { console.log("Connexion au Websocket réussie !");});
socket.on("disconnect", () => { console.log("Déconnecté du webSocket !");});

// gestion du websocket 
socket.on("update", (data) => {       
        console.log(data.message); // Affiche le message dans la console
        response =data.message
        type=response['Reception']
        console.log(type)
        if (type=='boatinfos'){
                console.log ('on traite boatinfos')
                console.log('********************************************************')
                console.log ('Ligne 4976 username '+username+' course '+course+ ' bloque '+bloque)
                update(username,course,bloque)
                console.log ('boatinfos traité')

                if (overlay) {  overlay.remove();       }
                }
        if (type=='boatActions'){
                console.log ('on traite boatActions')   
            chercheprogsvr(user_id,course,t0routage)
            console.log ('boatActions traité')
            let boite = document.querySelector(".boite2");
            let overlay = boite.querySelector(".boite-overlay");}

        if (type=='getfleet'){
            console.log ('on traite getfleet')
            course2=response['course'] 
            console.log ('course '+course2)
            if (course2!=course) {console.log ('on a change de course') 


            changementcourse(username,course2)

            course=course2

            }
            // else {
            //     console.log ('on traite getfleet')
            //     console.log ('getfleet recu')
            //     flotte=response['flotte']
            //     console.log ('flotte recu')
            //     console.log (flotte)
            //     afficheflotte(flotte)
            // }
            console.log ('getfleet traité')  }
        

        


    });

//***********************************************************************************************************

 }//fin du main 


    










//***************************************************************************************************************
//********  Update                                                         ******************************
//***************************************************************************************************************


// on a besoin de mettre a jour
// La position du bateau  
// Les parametres de voile
// Le lien pour les polaires 
// la maj meteo sera traitee independamment 
async function update(username,course,bloque)  
{ if (bloque==0) {

   // on a besoin des donnees boatinfos
    console.log ('\nDemande de update le '+intlhmn.format(Date.now())+'\n***************************************'  )
  
    boatinfosdata            = await chercheboatinfos(username,course)
    boatinfos                = boatinfosdata.result 

    if (boatinfos!=null   ) 
        { 
           afficheboatinfos (boatinfosdata)
        }
    else {console.log ( "Ce bateau n'etant pas connu dans boatinfos , ça ne sert à rien de faire un update ")}   

} //fin du bloquage si routage 
} //fin de update  










//***************************************************************************************************************
//********  Changement Utilisateur                                                          ******************************
//***************************************************************************************************************


async function changementuser(username){
    console.log (' Changement user  Nouveau  '+username )
  console.log ('***************************************************')

bloque=1    // on bloque l update    

    console.log ('username2 '+username)
    course=document.getElementById('idcourse').value
    routageLayer.clearLayers()    
    boatMarkers.clearLayers()
    layerExclusions .clearLayers()
    WpCirclesLayer.clearLayers();          
    routageCircles.clearLayers();
    isochronesLayer.clearLayers()
    progsvrLayer.clearLayers()
    document.getElementById("inputCoordinates").value=''    


// on affiche le selectcourse   correctement pour le user 
let tabValeurs = tabNameCourses.map(subArray => subArray[0]);
let tabNoms    = tabNameCourses.map(subArray => subArray[1]);
let coursesUser = await cherchecoursesuser(username) // on cherche les courses en cours du username
    if ( coursesUser ==null )   //si l utilisateur est Bateau Inconnu on lui a attribué une course d'office 
    { // on est dans le cas d'un nouveau bateau ou de bateau inconnu qui n a pas encore de courses repertoriées 
          course=tabNameCourses[0][0];
          coursesUser=[course] 
    }      
course=coursesUser[0]
var selectcourse  = generateSelect( 'idcourse',tabValeurs,tabNoms, coursesUser, course,'limited-width-select-200') 
document.getElementById('idselectcourse').innerHTML= selectcourse



// on va voir dans le local storage et dans boatinfos 
trajet= trouvetrajetcomplet( username, course)  
console.log ('trajet trouve en ligne 2362 \n*********************************')
console.log (trajet)

boatinfosdata            = await chercheboatinfos(username,course)
boatinfos           = boatinfosdata.result 
boatinfosjson       = JSON.parse(boatinfos)


if (boatinfos!=null   )
        { 

            console.log ('On a des donnees dans boatinfos')
            user_id             = boatinfosjson['bs']['_id']['user_id']
            y0vr                = boatinfosjson['bs']['pos']['lat']
            x0vr                = boatinfosjson['bs']['pos']['lon']
            twsvr               = boatinfosjson['bs']['tws']
            twavr               = boatinfosjson['bs']['twa']
            t0vr                = boatinfosjson['bs']['lastCalcDate']/1000
            polar_id            = boatinfosjson['bs']['boat']['polar_id']
            stamina             = boatinfosjson['bs']['stamina']
            sail                = boatinfosjson['bs']['sail']

            afficheboatinfos (boatinfosdata)   // visiblement ne se met a jour qu a l update  ? 
            document.getElementById('iddepart').selectedIndex=0 // on peut afficher un selectdepart avec Position VR 
            y0=y0vr
            x0=x0vr

            if (trajet.length != 0) 
            {   document.getElementById('iddepart').selectedIndex=0 // on peut afficher un selectdepart avec Position VR 
                console.log(' il y a des boatinfos et un trajet donc des WP')
                ari=trajet[11]
                waypoints=trajet[12]        
                nomdernierwp=ari[ari.length-1]
                dernierwaypoint = waypoints.find(waypoints => waypoints[1] === nomdernierwp) // on le recherche dans la liste 
                y1=dernierwaypoint[2]
                x1=dernierwaypoint[3]
                // pour l affichage des coordonnees du depart
               trajet[2]=y0vr 
               trajet[3]=x0vr 
               trajet[4]=t0vr 
               // Le trajet etant deja existant on nemodifie que les coordonnnees de depart        
               
            }    

            else{ 
                //console.log(' il y a des boatinfos mais pas de trajet // on cree un trajet et le select d arrivee ')
                document.getElementById('iddepart').selectedIndex=0
                let courseencours = tabNameCourses.find(tabNameCourses => tabNameCourses[0] === course)
                y1           = courseencours[5][0]
                x1           = courseencours[5][1]
                var rayonari = courseencours[5][4]   
                waypoints=[[99, "Arrivee", y1, x1, rayonari]]
                trajet=[username,course,y0vr,x0vr,y0vr,x0vr,t0vr,y1,x1,-1,1,['Arrivee'],waypoints,'Nouvel Utilisateur' ]       
                }
            
            //valable dans les 2 cas
            updatetrajet(username, course, trajet)              // sauve le trajet et le place en premier  

            affichewaypoints(waypoints)
            affichecoordsdep(y0,x0)
            affichecoordsari(y1,x1)
            afficheselectarrivee(waypoints,ari)   // on remet a jour le selectari 
            map.panTo([y0,x0])   

        }  // fin du cas ou il y a des boatinfos 


// il n'y a pas de boatinfos mais peut etre un trajet 
   else {  
                
            if (trajet.length != 0) {
                console.log(' il y a des boatinfos et un trajet donc des WP')
                ari=trajet[11]
                waypoints=trajet[12]        
                nomdernierwp=ari[ari.length-1]
                dernierwaypoint = waypoints.find(waypoints => waypoints[1] === nomdernierwp) // on le recherche dans la liste 
                y1=dernierwaypoint[2]
                x1=dernierwaypoint[3]

                // pour l affichage des coordonnees du depart
                y0=trajet[1]
                x0=trajet[2]   
                updatetrajet(username, course, trajet)              //  replace le trajet en premier  
                affichewaypoints(waypoints)
                affichecoordsdep(y0,x0)
                affichecoordsari(y1,x1)
                afficheselectarrivee(waypoints,ari)   // on remet a jour le selectari 
                map.panTo([y0,x0])   
            }
            
            else{  console.log(' l utilisateur '+username+' n est connu ni dans boatinfos ni dans les trajets ')
                utilisateurinconnu2(username,course    ) }

        }
bloque=0
}








//***************************************************************************************************************
//********  Changement course                                                      ******************************
//***************************************************************************************************************

// on a besoin de mettre a jour
// La position du bateau ou le point de depart si pas de trajet existant  
// le selecteur d arrivee 
// les waypoints si existants 
// Les parametres de voile
// Le lien pour les polaires en fonction du vent 
// les lignes et tableau  de programmation si existants 

// la maj meteo sera traitee independamment 







async function changementcourse(username,course){
  console.log (' Nouvellecourse :'+course +' pour '+username )
  console.log ('***************************************************')
  // On efface tout 
    lgMarkers .clearLayers()  ;
    lgDashLines.clearLayers()  ;
    routageLayer.clearLayers() ;   
    boatMarkers.clearLayers();
    layerExclusions .clearLayers();
    WpCirclesLayer.clearLayers();          
    routageCircles.clearLayers();
    isochronesLayer.clearLayers()
    progsvrLayer.clearLayers();
    progsvrLayerJaune.clearLayers();
    circleBoatLayer.clearLayers();
    fermerEditeurRoutes()
    document.getElementById("inputCoordinates").value=''
    zonesPolygones = {};      // on vide la liste des polygones perso 
    listeZones=[]                   // on vide la liste des zones exclusion perso 
    waypointsjs={}
    for (let nom in polylines) {
    if (map.hasLayer(polylines[nom])) {
        map.removeLayer(polylines[nom]);
    }
    }

    routes = [];             // Liste des routes
    nomsroutages = [];       // Noms des routages
    polylines = {};          // Objets Leaflet des routes affichées
    document.getElementById('tableroutages').innerHTML = ""; // Efface le tableau des routes

    let courseencours = tabNameCourses.find(tabNameCourses => tabNameCourses[0] === course)
    var selectini=username=='Bateau Inconnu'?1:0;       // position vr par defaut 
// on n a pas besoin de changer le selectcourse qui reste identique 
// on recupere les personalinfos  s il n y en a pas sur cette course une ligne est ouverte automatiquement

personalInfosStr = await recherchepersonalinfos2(username,course)
console.log ('personalInfosStr '+personalInfosStr)     // si il n'y en a pas la fonction en cree un avec la course
personalInfosJS = JSON.parse(personalInfosStr);
console.log (`personalInfos  pour ${username} sur la course ${course}\n*************************************************\n${personalInfosStr}`)
    
affichewaypoints2(personalInfosJS)
waypoints     = Object.values(personalInfosJS.wp).sort((a, b) => a[0] - b[0]);
nomsWaypoints = waypoints.map(item => item[1]);
ari=personalInfosJS['ari']
afficheselectarrivee(waypoints,ari)// on affiche le select arrivee avec les waypoints et ceux selectionnes  
// ici on peut afficher les coordonnneses du dernier wp selectionné qui est le dernier element de ari 
nomdernierwp=ari[ari.length-1]                                        // nom du dernier wp
waypoint = waypoints.find(waypoints => waypoints[1] === nomdernierwp) // on le recherche dans la liste 
let y1=waypoint[2]
let x1=waypoint[3]
document.getElementById('iddernierwp').innerHTML=nomdernierwp
affichecoordsari(y1,x1)

// pour pouvoir numeroter les waypoints 
nbWP = personalInfosJS.wp ? Object.keys(personalInfosJS.wp).length : 0;
console.log ( 'nbWP : '+nbWP)



//****************************************************************************
//****************************************************************************

// on affiche le select depart 
tabNoms=['Position VR - Heure VR ','Coordonnées / Heure Manuelle ','Coordonnées / Heure Depart ' ]
tabValeurs=[0,1,2]
grises =[]
selectdepart  = generateSelect( 'iddepart',tabValeurs,tabNoms, grises, selectini,'limited-width-select-100') 
document.getElementById('idselectdepart').innerHTML= selectdepart
    
// on va chercher leginfos      qui donne les particularites de la course 
// problème si la course n a jamais ete initiee   a voir dans chgt course 
   leginfos        = await chercheleginfos(course) 
   console.log ('leginfos\n***********\n' +leginfos)

afficheZonesExclusions (personalInfosJS)
// On va chercher les donnees les plus recentes sur le bateau 
   boatinfosdata       = await chercheboatinfos(username,course)
//    console.log ('boatinfosdata ' +boatinfosdata)
//    console.log ('boatinfosdata keys ' +Object.keys(boatinfosdata))
//    console.log ('boatinfosdata.result'+boatinfosdata.result)



// on les affiche 
   if (boatinfosdata.result==null){
    /*utilisateurinconnu()*/console.log('Utilisateur inconnu ') ; affichecoordsdep(ycoord,xcoord) }


// on va sauver un trajet pour y revenir directement la prochaine fois 

        let t0              = document.getElementById('datetime').value
        let dateObj         = new Date(t0);  
        let t0Secondes      = Math.floor(dateObj.getTime() / 1000);
        let t0formate           = formatTime(t0Secondes)
        let y0           = courseencours[4][0]
        let x0           = courseencours[4][1]
        y1           = courseencours[5][0]
        x1           = courseencours[5][1]
        // waypoints et ari ont deja ete recuperes
        // waypoints=[[99, "Arrivee", y1, x1, rayonari]]
        // ari=['Arrivee']
        trajet=[username,course,y0,x0,y0,x0,t0,y1,x1,-1,1,ari,waypoints,'New'+username+' '+t0formate ]
        updatetrajet(username, course, trajet)   // sauve le trajet  
        map.panTo([y0vr,x0vr])               // on centre la carte 


afficheleginfos  (leginfos) 
afficheboatinfos (boatinfosdata)  
// on va remettre l eta et la duree a 0 
document.getElementById('eta').innerHTML='Pas de Routage ' 
// on se positionne sur le bateau
map.panTo([y0vr,x0vr])


}









async function changementcourse_old(username,course){
  console.log (' Nouvellecourse :'+course +' pour '+username )
  console.log ('***************************************************')
  // On efface tout 

    lgMarkers .clearLayers()  
    lgDashLines.clearLayers()  
    routageLayer.clearLayers()    
    boatMarkers.clearLayers()
    layerExclusions .clearLayers()
    WpCirclesLayer.clearLayers();          
    routageCircles.clearLayers();
    isochronesLayer.clearLayers()
    progsvrLayer.clearLayers()
    progsvrLayerJaune.clearLayers()
    circleBoatLayer.clearLayers()
    document.getElementById("inputCoordinates").value=''

// on recupere le trajet en cours pour la course  et on le replace en premier 

    trouvetrajet( username, course)



//pour test 

// on cherche s il existe deja un trajet enregistré
// trajet= trouvetrajetcomplet( username, course)  
// console.log ('trajet trouve en ligne 2362 \n*********************************')
// console.log (trajet)

// donnes completes de la course (depart arrivee )
let courseencours = tabNameCourses.find(tabNameCourses => tabNameCourses[0] === course)
// on cherche s il existe des boatinfos

boatinfosdata            = await chercheboatinfos(username,course)
boatinfos           = boatinfosdata.result 
boatinfosjson       = JSON.parse(boatinfos)



if (boatinfos!=null   )
    { 
        afficheboatinfos (boatinfosdata)   // visiblement ne se met a jour qu a l update  ? 

        // console.log (' Il y a des boatinfos pour course :'+course +' et '+username )
        // console.log ('***************************************************')
        // user_id             = boatinfosjson['bs']['_id']['user_id']
        // let     y0vr                = boatinfosjson['bs']['pos']['lat']
        // let     x0vr                = boatinfosjson['bs']['pos']['lon']
        // let     twsvr               = boatinfosjson['bs']['tws']
        // let     twavr               = boatinfosjson['bs']['twa']
        // let     t0vr                = boatinfosjson['bs']['lastCalcDate']/1000
        // let     polar_id            = boatinfosjson['bs']['boat']['polar_id']
        // let     stamina             = boatinfosjson['bs']['stamina']
        // let     sail                = boatinfosjson['bs']['sail']
        
        //     map.panTo([y0vr,x0vr])  
           
        //     document.getElementById('iddepart').selectedIndex=0   // selectdepart avec Position VR 




    // on va chercher dans localstorage si il y  a deja un trajet pour recuperer les waypoints 
        trajet=trouvetrajetcomplet ( username, course)    
        if (trajet.length != 0) {     console.log(' il y a des boatinfos et un trajet')
                ari=trajet[11]
                waypoints=trajet[12]        
                nomdernierwp=ari[ari.length-1]
        // on le recherche dans la liste 
                waypoint = waypoints.find(waypoints => waypoints[1] === nomdernierwp) 
                y1=waypoint[2]
                x1=waypoint[3]
        // pour l affichage des coordonnees du depart
                y0=y0vr
                x0=x0vr


                nowJS           = new Date()
                console.log(intlhmn.format(Date.now()))
                console.log ('date courante '+nowJS)
                // on met a jour le trajet avec y0vr et x0vr uniquement    
                trajet[2]=y0vr
                trajet[3]=x0vr    

                //trajet=[username,course,y0vr,x0vr,y0,x0,t0vr,y1,x1,-1,1,['Arrivee'],waypoints,'maj boatinfos' ]
                console.log (trajet)   
                updatetrajet(username, course, trajet)    // sauve le trajet pour la prochaine fois 
                affichewaypoints(waypoints) 
                affichecoordsdep(y0,x0)
                afficheselectarrivee(waypoints,ari) // on remet a jour le selectari 
                affichecoordsari(y1,x1)

                map.panTo([y0vr,x0vr])

        }

    else { console.log('boatinfos mais pas de trajet enregistre pour cette course et ce username on va le creer ainsi que le select d arrivee') 

        console.log (' Il y a des boatinfos mais pas de trajet pour course :'+course +' et '+username )
        console.log ('***************************************************')

            document.getElementById('iddepart').selectedIndex=0  //Position VR pour la position de depart 
        //recherche des coordonnees de l arrivee globale 
            y1           = courseencours[5][0]
            x1           = courseencours[5][1]
            var rayonari = courseencours[5][4]   
            waypoints=[[99, "Arrivee", y1, x1, rayonari]]
            
            console.log('y0vr'+y0vr+ ' x0vr '+x0vr)
            y0=y0vr
            x0=x0vr
           
            //Constitution du trajet 
            trajet=[username,course,y0vr,x0vr,y0vr,x0vr,t0vr,y1,x1,-1,1,['Arrivee'],waypoints,'Nouvelle course ' ]
            updatetrajet(username, course, trajet)   // sauve le trajet   
            affichecoordsdep(y0,x0)
            afficheselectarrivee(waypoints,ari)
            affichecoordsari(y1,x1)
       
        }

    // Quel que soient les donnees du joueur // on affiche les parametres de la course avec les exclusions 
       leginfos        = await chercheleginfos(course) 
                       // on centre la carte 
       affichewaypoints (waypoints)       // ici waypoints  c'est l'arrivee 
       afficheleginfos  (leginfos)
  } // fin du boatinfos valide a voir 





 else {  // on n a pas de boatinfos , ca veut dire que l user ne s'est jamais connecte sur le dash pour cette course 
        alert(' Vous devez Soit rentrer les coordonnees manuellement depart et arrivee ou waypoint , soit  vous connecter sur le dash pour cette course afin de pouvoir recuperer les informations VR ')
        
        // on va lui creer un trajet 
        // coordonnees par defaut et depart sur coordonnees
        let t0              = document.getElementById('datetime').value
        let dateObj         = new Date(t0);  
        let t0Secondes      = Math.floor(dateObj.getTime() / 1000);
        let t0formate           = formatTime(t0Secondes)
        let y0           = courseencours[4][0]
        let x0           = courseencours[4][1]
        let y1           = courseencours[5][0]
        let x1           = courseencours[5][1]
        waypoints=[[99, "Arrivee", y1, x1, rayonari]]
        ari=['Arrivee']
        trajet=[username,course,y0,x0,y0,x0,t0,y1,x1,-1,1,ari,waypoints,'New'+username+' '+t0formate ]
        updatetrajet(username, course, trajet)   // sauve le trajet  
        document.getElementById('iddepart').selectedIndex=1                // selectdepart sur position coordonnees
        affichecoordsdep(y0,x0)
        affichecoordsari(y1,x1)
       map.panTo([y0,x0]) 
    }


   


}









//***************************************************************************************************************
//********  Nouvel Utilisateur inconnu dans la base de donnees donc dans les trajets    *************************
//***************************************************************************************************************

function utilisateurinconnu2(username,course){
  
console.log('Nouvel Utilisateur '+username +' sur la course '+course+' inconnu dans la base de donnees et dans les trajets ');

// on lui cree un trajet depart arrivee avec la course en cours par defaut 
    //courseencours        = document.getElementById('idcourse').value
    coursecomplete   = tabNameCourses.find(tabNameCourses => tabNameCourses[0] === course)
    let t0              = document.getElementById('datetime').value
    let dateObj         = new Date(t0);  
    let t0Secondes      = Math.floor(dateObj.getTime() / 1000);
    let t0formate           = formatTime(t0Secondes)
    y0           = coursecomplete[4][0]
    x0           = coursecomplete[4][1]
    y1           = coursecomplete[5][0]
    x1           = coursecomplete[5][1]

    try{var rayonari = courseencours[0][5][4]}   catch{rayonari=0}   // cas ou l arrivee est une ligne 
    waypoints=[[99, "Arrivee", y1, x1, rayonari]]
    ari=['Arrivee']
    console.log ('on enregistre le trajet comme un nouveau trajet car il n existe pas deja ');
    trajet=[username,course,y0,x0,y0,x0,t0,y1,x1,-1,1,ari,waypoints,'New'+username+' '+t0formate ]
    document.getElementById('iddepart').selectedIndex=1 // selectdepart avec coordonnnees 
    updatetrajet (username,course,trajet)    // sauve le trajet pour la prochaine fois 
    document.getElementById('iddepart').selectedIndex=0     // inconnu selectdepart sur coordonnnees 
    affichecoordsdep(y0,x0)
    afficheselectarrivee(waypoints,ari)
    affichecoordsari(y1,x1)
    // valeurs arbitraires pour l affichage du bateau 
    twsvr=10
    twdvr=270
    heading=0
    afficheBoat (y0,x0,t0Secondes,twsvr,twdvr,heading,username)
    map.panTo([y0,x0]) 


}




async function utilisateurinconnu(){
  
    let tabNameCoursesEnCours = tabNameCourses.filter(ligne => ligne[3] !== 'ended');
    let tabValeurs = tabNameCoursesEnCours.map(subArray => subArray[0]);
    let tabNoms    = tabNameCoursesEnCours.map(subArray => subArray[1]);
    coursesuser=[]
    course=tabNameCoursesEnCours[0][0]   
    // on peut maintenant afficher le select et le nom du user 
    var selectcourse  = generateSelect( 'idcourse',tabValeurs,tabNoms, coursesUser, course,'limited-width-select-200') 
    document.getElementById('idselectcourse').innerHTML= selectcourse

    // on affiche le select depart 
    tabNoms=['Position VR','Coordonnées']
    tabValeurs=[0,1]
    grises =[]
    selectini=1
    selectdepart  = generateSelect( 'iddepart',tabValeurs,tabNoms, grises, selectini,'limited-width-select-100') 
    document.getElementById('idselectdepart').innerHTML= selectdepart
    document.getElementById('iddepart').selectedIndex=1     // inconnu => selectdepart sur coordonnnees 
      
    // on va rajouter l inconnu au local storage 
    username = document.getElementById('idusername').value
    t0       = document.getElementById('datetime').value
    course   = document.getElementById('idcourse').value
    y0       = tabNameCoursesEnCours[0][4][0]
    x0       = tabNameCoursesEnCours[0][4][1]
    y1       = tabNameCoursesEnCours[0][5][0]
    x1       = tabNameCoursesEnCours[0][5][1]
    var rayonari = tabNameCoursesEnCours[0][5][4]
    affichecoordsdep(y0,x0)
    affichecoordsari(y1,x1)
    waypoints=[[99, "Arrivee", y1, x1, rayonari]]


    // console.log( 'username,t0,course  '+username+' '+t0+' course ' +course )
    // console.log ('course attribuée par defaut '+tabNameCourses[0])
    trajet [0] =   username
    trajet [1] =   course
    trajet [2] =   y0             // Derniers coordonnees rentrees on prend le depart par defaut
    trajet [3] =   x0
    trajet [4] =   y0             // Dernière position VR 
    trajet [5] =   x0
    trajet [6] =   t0             // dernier temps de calcul
    trajet [7] =   y1             // derniers coordonnés de l 'arrivee 
    trajet [8] =   x1 
    trajet [9] =   -1             // valeur de depart
    trajet [10] =   -1             // valeur de depart    
    trajet [11]= ['Arrivee']               // ari  c 'est un tableau '
    trajet [12]=   waypoints
    trajet [13]=  'Nouveau user'

    updatetrajet(username,course,trajet)    //on rajoute trajet dans le localstorage

    afficheselectarrivee(waypoints,ari)
    
    alert ("Vous devez selectionner une course, indiquer des coordonnees de depart et positionner un WP d'arrivee ") ;  
}

          






//*******************************************************************************************************
//**********  Fonctions d affichage diverses   **********************************************************
//*******************************************************************************************************




function afficheprogsvr(data){
  //  programmationsJson=JSON.parse(data.programmations)  
   // console.log (' Ligne 3686 type de programmations '+data.programmations)   
    console.log ('Type de programmations : '+data.typeprogs)                            


   
    if (data.typeprogs=="progs"){ //console.log ('On a affaire a des progs')
      afficheligneprogs (data)   //# on peut alors tracer la polyline  tracer
      affichetabprogsvr(data) 
       }

    else if (data.typeprogs=="wps") { 
      //console.log ('On a affaire a des wp')
      affichelignewaypoints (data)   //# on peut alors tracer la polyline  tracer
      affichetabwpvr(data)
     // affichelignewaypoints2(polylineprogs)
       }
   
   else (console.log ('Probleme dans la recuperation progs ou wp  '))

}









function affichelignewaypoints(data){

    lgMarkersVR.clearLayers()
    progsvrLayer.clearLayers()

    //console.log ('on est dans affichelignewaypoints  ')
   // console.log('data'+data.programmations)

    waypointsvr=JSON.parse(data.programmations) 
    polylineprogs    = data.polyline
    

   

    for (var i=0 ; i<waypointsvr.length ; i++ )
     {   //Cercles de couleur blanche pour les WP
         latwp=waypointsvr[i]['WPLat']
         lonwp=waypointsvr[i]['WPLon']
         circlewp = L.circle([latwp,lonwp] ,{fillColor: 'white' ,color:'white' , weight:1 ,opacity:1,fillOpacity:0 ,radius: 500,}).bindTooltip('WP'+(i+1)).addTo(lgMarkersVR)                                                              
     }

    for (var i=0;i<polylineprogs.length ;i++)
    {    tooltip[i]=intlhmn.format(polylineprogs[i][4]*1000)+'<br>'+typeVoiles[polylineprogs[i][5]]
         circleprog2[i] = L.circle([polylineprogs[i][0],polylineprogs[i][1]] ,{fillColor: 'white' ,color:colors[polylineprogs[i][5]] , weight:1 ,opacity:1,fillOpacity: 0,radius: 100,}).bindTooltip(tooltip[i]).addTo(lgMarkersVR)
    }                                                                
    
    lgMarkersVR.addTo(map)
}






function afficheZonesExclusions(personalInfosJS) {
    console.log("Affichage des zones d'exclusion");

    // Vider le layer avant de tout recharger
    layerExclusions.clearLayers();
    listeZones = []; 
    zonesPolygones = {}; 

    if (personalInfosJS.exclusions) {
        Object.entries(personalInfosJS.exclusions).forEach(([nomZone, zone]) => {     
            console.log("Valeurs de la zone d'exclusion :", zone);

            let polygone = L.polygon(zone)
                .setStyle({ color: 'black', fillColor: 'blue', weight: 0.5, fillOpacity: 0.2 })
                .bindTooltip(nomZone, { permanent: false, direction: "center", className: "zone-tooltip" })
                .on("click", () => ouvrirEditeurExclusions(nomZone, zone)) // 🔹 Ouvrir l'éditeur sur clic
                .addTo(layerExclusions);

            listeZones.push(nomZone); 
            zonesPolygones[nomZone] = polygone; // 🔹 Stocker la zone pour suppression rapide
        });

        layerExclusions.addTo(map)
    }
}





// function affichepersonalinfos(personalinfos){
//     nomzones=personalinfos.nomzone
//     polygones=personalinfos.polygone
//     zonesjson           = JSON.parse (polygones)
//     nomsZonesExclu      = JSON.parse (nomzones)
//     let  texte=" "
//    for (let i=0;i<zonesjson.length;i++)
//     {        
//     let exclusionsperso=L.polygon(zonesjson[i]).setStyle({ color: 'blue', weight:1, opacity:.2, }).addTo(map);     
//     exclusionsperso.bindTooltip(nomsZonesExclu[i])
//     texte+= '<option value="'+nomsZonesExclu[i]+'">'+nomsZonesExclu[i]+'</option>'
//     exclusionsMap.set(nomsZonesExclu[i], exclusionsperso);

//     document.getElementById('dynamicSelect').innerHTML=texte
//     } 
// }







function afficheleginfos(leginfos)  // affiche les particularites de la course
    {  //leginfos contient les marques les zones exclusion la trajectoire 

        if (leginfos!=null)
    {
        leginfos     = JSON.parse (leginfos)
        lgMarkers    .clearLayers();  // Contient les lignes de checkpoints   
        lgDashLines  .clearLayers();

        //console.log  ('checkpoints '+leginfos['checkpoints'])
        
        // on recupere les lignes de checkpoint 
        var   nombreLignes=leginfos['checkpoints'].length
       
        tabLignesCheckPoints.length=nombreLignes
        for ( var i=0 ; i<nombreLignes ; i++ )
            { var starti=[ leginfos['checkpoints'][i]['start']['lat'],  leginfos['checkpoints'][i]['start']['lon'],  leginfos['checkpoints'][i]['name']   ]
                    var   endi=[ leginfos['checkpoints'][i]['end']['lat'],  leginfos['checkpoints'][i]['end']['lon'] ,leginfos['checkpoints'][i]['name']   ]
                    var   displayi=    leginfos['checkpoints'][i]['display']  
                    tabLignesCheckPoints[i]=[starti,endi,displayi]
            }
        console.log ('Lignes de checkpoints récupérées')    
        //console.log (tabLignesCheckPoints)

        // tracage des lignes de checkpoints
        for (var i=0;i< tabLignesCheckPoints.length;i++) 
                {let y0=tabLignesCheckPoints[i][0][0]
                let  x0=tabLignesCheckPoints[i][0][1]
                let y1=tabLignesCheckPoints[i][1][0]
                let x1=tabLignesCheckPoints[i][1][1]
        tracearc(y0,x0,y1,x1)
                // on va mettre un marqueur a chaque point de depart  
        
        //L.marker([y0,x0 ],    {icon: blackIcon}).bindTooltip(tabLignesCheckPoints[i][0][2]).addTo(lgMarkers)     
       // L.circle([y0,x0] ,{fillColor: 'white' ,color:'green' , weight:1 ,opacity:1,fillOpacity: 0,radius: 100,}).bindTooltip('bouee').addTo(lgMarkersVR)
                
  }
        // On recupere les points du trace de la course servant a definir la courbe de bezier   
        var tracecourse=leginfos['course']
        
        
        
        // console.log ('Itineraire  de la course ', tracecourse)


            nbpt=tracecourse.length   
            polylineCurve.length=nbpt
            for ( var i=0 ; i<nbpt ; i++ )   { polylineCurve[i] = [tracecourse[i]['lat'],tracecourse[i]['lon']]   }

           

        // on recupere les zones d exclusions  si elles existent 
        try{
            nbzones=leginfos['restrictedZones'].length
            zonesExclusions.length = (nbzones)
            for ( var i=0 ; i<nbzones ; i++ )
            {   vertices=leginfos['restrictedZones'][i]['vertices']
                nbPoints=vertices.length
                pointsvertice=new Array(nbPoints+1)
                for ( var j=0 ; j<nbPoints ; j++ )
                    { pointsvertice[j]=[vertices[j]['lat'],vertices[j]['lon']]}    
                    pointsvertice[nbPoints]=[vertices[0]['lat'],vertices[0]['lon']]  // on referme le polygone
                    zonesExclusions[i]= pointsvertice
            }
            console.log( "Zones d'Exclusions")
            console.log( zonesExclusions) 
        }
        catch {  zonesExclusions=[]; console.log('Pas de zones d exclusion pour la course')}

        // on recupere la zone de glace si elle existe 
        tabicelimits=leginfos['ice_limits']['south']

        const polyicelimit = tabicelimits.map(({ lat, lon }) => [lat, lon]);
        //console.log ('Limite des glaces')
        //console.log(polyicelimit);
        Lpolyicelimit=L.polyline(polyicelimit).setStyle({ color: 'red', weight:2, opacity:1, }).addTo(lgMarkers)



        //remplissage du select de depart et arrivee 
        indiceCourse= rechercheindice2(tabNameCourses,course)     
        //console.log('indiceCourse '+indiceCourse)      
        depart   = [tabNameCourses[indiceCourse][4][0],tabNameCourses[indiceCourse][4][1],tabNameCourses[indiceCourse][4][2]]
        arrivee  = [tabNameCourses[indiceCourse][5][0],tabNameCourses[indiceCourse][5][1],tabNameCourses[indiceCourse][5][2]]
        // [y,x,nom]
        // affichagecoordsDep(tabNameCourses[indiceCourse][4][0],tabNameCourses[indiceCourse][4][1])
        // ca ce sont les coordonnees du depart de la course 

        //Marqueurs depart arrivee et cercle arrivee
        L.marker(depart,    {icon: greenIcon}).bindTooltip(tabNameCourses[indice][4][2]).addTo(lgMarkers)
        L.marker(arrivee,    {icon: redIcon}).bindTooltip(tabNameCourses[indice][5][2]).addTo(lgMarkers)
        radiusend=tabNameCourses[indice][5][4]*1852
        var circleari = new L.circle(arrivee, { color: 'white',weight:0.7, fillColor: '#f03',opacity:1,fillOpacity: 0,radius: radiusend,}).addTo(lgMarkers);

        // lignes de checkpoints
        for (var i=0;i< tabLignesCheckPoints.length;i++) 
                {y0=tabLignesCheckPoints[i][0][0]
                x0=tabLignesCheckPoints[i][0][1]
                y1=tabLignesCheckPoints[i][1][0]
                x1=tabLignesCheckPoints[i][1][1]
                tracearc(y0,x0,y1,x1)
                // on va mettre un marqueur a chaque point de depart  
                L.marker([y0,x0 ],    {icon: blackIcon}).bindTooltip(tabLignesCheckPoints[i][0][2]).addTo(lgMarkers)        
                L.circle([y0,x0] ,{fillColor: 'white' ,color:'black' , weight:1 ,opacity:1,fillOpacity: 0,radius: 500,}).bindTooltip('bouee').addTo(lgMarkers)
                 }    
        troncons=couperPolyligneLongitude(polylineCurve)       // trajectoire theorique 
        troncons.forEach(troncon => {
            var bezierPath = createBezierPath(troncon);
            try     {   L.curve(bezierPath, { color: 'blue', weight: 2 }).addTo(lgDashLines);}
            catch   {   console.log('Le trace a echoué')}
        });

        // lignes exclusions si elles existent 
        try{    L.polyline(zonesExclusions).setStyle({ color: 'red', weight:1, opacity:1, }).addTo(lgDashLines); }
        catch{ 'console.log pas de zones d exclusion' }


        lgMarkers.addTo(map)  
        lgDashLines.addTo(map)

    }

    else {alert('Vous devez d abord vous connecter sur la course pour avoir les informations sur la course ')}
        //WpCirclesLayer.addTo(map) la place est plutot dans l affichage des donnees perso
    
    }   // fin de affiche leginfos





async function afficheboatinfos(boatinfosdata)  // affiche les particularites de la course
    { 
       // update reguliere pour afficher les dernieres infos  
       // en state waiting on a user_id, race_id, et leg , polar_id legStartDate, displayName heading pos sail speed gategroupcounters tws twd twa lastCalcdate      
       //  on a pas twaAuto stamina     


    


    boatinfos           = boatinfosdata.result                                      
    indicemajgrib       = boatinfosdata.indicemajgrib
    tig                 = boatinfosdata.tig
    boatinfos           = JSON.parse (boatinfos)
    boatinfosbs         = boatinfos['bs']
   
    console.log (' ligne 3866   boatinfosbs \n  '+ JSON.stringify(boatinfosbs ))
    console.log (' ligne 4100   indicemajgrib \n  '+ indicemajgrib)


    try{boatinfosBA         = boatinfos['ba']} catch{boatinfosBA=[]}
    //console.log (' ligne 3468   boatinfosBA \n  '+ JSON.stringify(boatinfosBA ))
    
    typebateau          = boatinfosbs['boat']['name']                    //ok si course pas demarree              
    username            = boatinfosbs['displayName']                     //ok si course pas demarree   
    race                = boatinfosbs['_id']['race_id']                  //ok si course pas demarree  
    leg                 = boatinfosbs['_id']['leg_num']                 //ok si course pas demarree   

    userId              = boatinfosbs['_id']['user_id']
    polar_id            = boatinfosbs['boat']['polar_id']
    heading             = boatinfosbs['heading']
    y0vr                = boatinfosbs['pos']['lat']
    x0vr                = boatinfosbs['pos']['lon']
    sail                = boatinfosbs['sail']
    speed               = boatinfosbs['speed']
    legStartDate        = boatinfosbs['legStartDate']


    if (boatinfosbs['lastCalcDate'])      { lastCalcDate   = boatinfosbs['lastCalcDate'] } else {lastCalcDate=legStartDate}
    if (boatinfosbs['twa'])               { twavr    = boatinfosbs['twa'] } else {twavr=40}
    if (boatinfosbs['tws'])               { twsvr    = boatinfosbs['tws'] } else {twsvr=10}
    if (boatinfosbs['twd'])               { twdvr    = boatinfosbs['twd'] } else {twdvr=0}
    if (boatinfosbs['stamina'])           { stamina    = boatinfosbs['stamina'] } else {stamina=100}
    if (boatinfosbs['state'])             { state= boatinfosbs['state']} 
    if (boatinfosbs['twaAuto'])           {twaAuto   = boatinfosbs['twaAuto'] }  else {twaAuto = twavr}
    if (boatinfosbs['stamina'])           { stamina   = boatinfosbs['stamina'] }  else {stamina = 100}
    if (boatinfosbs['rank'])              {rankvr   = boatinfosbs['rank'] }  else {rankvr =0}
    if (boatinfosbs['tsEndOfAutoSail'])   {tsEndOfAutoSail =boatinfosbs['tsEndOfAutoSail']  }  else {tsEndOfAutoSail =lastCalcDate }
    if (boatinfosbs['tsEndOfSailChange']) {tsEndOfSailChange    = boatinfosbs['tsEndOfSailChange']}
    if (boatinfosbs['tsEndOfGybe'])       {tsEndofGybe          = boatinfosbs['tsEndOfGybe']}
    if (boatinfosbs['tsEndOfTack'])       { tsEndofTack         = boatinfosbs['tsEndOfTack']}
    if (boatinfosbs['tsLastAction'])      { tsLastAction        = boatinfosbs['tsLastAction']}
    if (boatinfosbs['gateGroupCounters']) { gateGroupCounters   = boatinfosbs['gateGroupCounters']}


    var autosail=  sail>10 ? true:false


    let nowJS           = new Date()
    let nowMSec          = nowJS.getTime()
     
    ecartTemps =(nowMSec-lastCalcDate)/1000

    console.log ('Ecart entre boatinfos et temps present  ' +parseInt(ecartTemps)+ 's')
    
    if (ecartTemps < 600 && overlay) {  overlay.remove();}

    // if (ecartTemps>600 ){ 'L actualisation de la position date de plus de 10 mn';
    // verifierDeltat(ecartTemps)
    // //alert ('Temps depuis la mise a jour superieur a 10 mn');
    // }

    //var decalageUTC     = nowJS.getTimezoneOffset()
    

    console.log('Valeurs principales boatinfos username : '+username+' typebateau : '+typebateau+' race : ' + race+' leg :' +leg+' polar id : '+ polar_id+' state : ' +state)
    try{
    console.log ('heading : '+heading+' lat :'+y0vr.toFixed(4)+' lon : '+x0vr.toFixed(4)+' sail :'+sail  +' speed :'+speed.toFixed(2) +' twa : '+twavr+' tws : '+twsvr.toFixed(2)+' stamina : '+stamina.toFixed(2)+' gateGroupCounters : '+gateGroupCounters)
       }
    catch{console.log ('Tous les parametres ne sont pas recuperes ')} 

    // heure de depart    
    if (state=='waiting')
       { console.log ('boatinfos course en attente'+JSON.stringify(boatinfosbs)) 
        if (boatinfosbs['record']) {  console.log ('On est sur une course record')
            document.getElementById('iddepart').value=2   //select depart sur depart heure manuelle
            // on laisse le datetime tranquille 
        }
   
        else { //on est en attente mais on connait l heure de depart c est lindice 2 dans tabnameCourses 
            console.log ('Waiting n est pas precise mais l heure est anterieure a l heure de depart')
            console.log ('heure par boatinfos' +intlhmn.format(legStartDate))

            const nowUnix = Math.floor(Date.now()); // Timestamp Unix en M secondes
    
            if (legStartDate< nowUnix) 
            t0           = legStartDate/1000
            let dateFormattee =convertirUnixEnDatetimeLocal(legStartDate)
            document.getElementById('datetime').value = dateFormattee
            document.getElementById('iddepart').value = 1   //select depart sur depart heure auto
            }
          }

    // course en attente on a   boat polar_id    legstartdate  heading pos sail speed 0 stamina haspermanentautosails 

    

    else          {   // on est pas waiting=, donc on est en course ou inconnu (mais a ce moment la pas de boatinfos )
    t0 = lastCalcDate/1000  
     }

   // mise a jour de la boite 1 avec les donnnees de update
   affichecoordsdep(y0vr,x0vr)                   // Les coordonnnees du depart sont celle de boatinfos  dans tous les cas    
 

   //console.log (' Option depart vr ou autre '+document.getElementById('iddepart').value) 

   if (document.getElementById('iddepart').value==0)    
   {// on affiche une heure egale a la minute superieure pour l heure de depart 
   heuredepart = Math.ceil(lastCalcDate / 60) * 60;
   let dateFormattee =convertirUnixEnDatetimeLocal(heuredepart)
  // let dateFormattee = date.toISOString().slice(0, 16);
   document.getElementById('datetime').value= dateFormattee
   console.log ('heuredepart '+hmns.format(heuredepart))}
   




    id_user=userId
    // Remplissage de la boite 2 avec les donnees VR
    document.getElementById('dateposvr').innerHTML  = intlhmn.format(lastCalcDate)
    document.getElementById('usernamevr').innerHTML = username
    document.getElementById('y0vr').innerHTML       = pos_dec_mn_lat(y0vr)+'('+ y0vr.toFixed(4) + ") "
    document.getElementById('x0vr').innerHTML       = pos_dec_mn_lng(x0vr)+'('+ x0vr.toFixed(4) + ") " 
    document.getElementById('twsvr').innerHTML      = twsvr.toFixed(2)
    document.getElementById('twdvr').innerHTML      = twdvr.toFixed(2)
    document.getElementById('twavr').innerHTML      = twavr.toFixed(2)
    document.getElementById('rankvr').innerHTML     = rankvr
    document.getElementById('speedvr').innerHTML    = speed.toFixed(2)
    document.getElementById('sailvr').innerHTML     = typeVoiles[(sail%10)-1]
    document.getElementById('headingvr').innerHTML  = heading.toFixed(2)
    document.getElementById('staminavr').innerHTML  = stamina.toFixed(2)
    //document.getElementById('twscalc').innerHTML    = twscalc.toFixed(2)
    //document.getElementById('twdcalc').innerHTML    = twdcalc.toFixed(2)
    document.getElementById('twsvmg').value         =twsvr.toFixed(2)
    if (sail>=10){document.getElementById('voilesautovr').checked=true    }
    else {document.getElementById('voilesautovr').checked=false    }


    console.log('twaAuto '+twaAuto+'twa '+twavr)

    if (twaAuto==twavr){document.getElementById('twaauto').checked=true    }
    else {document.getElementById('twaauto').checked=false    }

    //document.getElementById('lienpolaires').innerHTML= "<a href=javascript:popupbasique('http://blacksailingpolars.vrzen.org/?race_id="+course+"&tws="+twsvr+"&twa="+Math.abs(twavr)+"&stam="+stamina+"&hull=true&winch=true&foil=true&light=true&heavy=true&reach=true&magicFurler=true&comfortLoungePug=true&vrtexJacket=true&voile="+sail%10+"')>Polaires </a></span>"
   
    urlPolaires=`http://blacksailingpolars.vrzen.org/?race_id=${course}&tws=${twsvr}&twa=${Math.abs(twavr)}&stam=${stamina}&hull=true&winch=true&foil=true&light=true&heavy=true&reach=true&magicFurler=true&comfortLoungePug=true&vrtexJacket=true&voile=${sail%10}`
   
 
    document.getElementById('dategrib').innerHTML   ='Grib du '+ intldhmn.format(tig*1000+decalageUTC*60000)+' + '+indicemajgrib*3+ 'h'
    document.getElementById('voilesautovr').checked= autosail

    //Positionnement du bateau    
    t0=lastCalcDate/1000
    //console.log(' ligne 3582 '+lastCalcDate/1000)
    afficheBoat (y0vr,x0vr,t0,twsvr,twdvr,heading,username)

    //map.panTo([y0vr,x0vr])     La positionnement se fait a chaque update ce qui est genant 
    //document.getElementById('lienpolaires').innerHTML= "<a href=javascript:popupbasique('http://blacksailingpolars.vrzen.org/?race_id="+course+"&tws="+twsvr+"&twa="+Math.abs(twavr)+"&stam="+stamina+"&hull=true&winch=true&foil=true&light=true&heavy=true&reach=true&magicFurler=true&comfortLoungePug=true&vrtexJacket=true&voile="+sail%10+"')>Polaires </a></span>"
    urlPolaires=`http://blacksailingpolars.vrzen.org/?race_id=${course}&tws=${twsvr}&twa=${Math.abs(twavr)}&stam=${stamina}&hull=true&winch=true&foil=true&light=true&heavy=true&reach=true&magicFurler=true&comfortLoungePug=true&vrtexJacket=true&voile=${sail%10}`
   
// On va chercher les valeurs pour les voiles et le vent 
        
        // on remet a jour le trajet avec les dernieres donnees boatinfos
    trajet=[username,course,y0vr,x0vr,y0vr,x0vr,t0vr,y1,x1,-1,1,ari,waypoints,'maj par main' ]
    updatetrajet (username,course,trajet)


   
    //console.log ('ligne2743 '+intlhmn.format(t0vr*1000))
        t0routage=  Math.ceil(t0 / 60) * 60;
        try{  await chercheprogsvr(user_id,course,t0routage)  }  // se charge de l affichage
        catch{console.log('Probleme dans la recuperation de progsvr')}

    //console.log ('ligne 3599 '+y0vr+'  '+x0vr+ '  '+t0+' '+twsvr+'  '+twavr+' '+polar_id)
    resvoiles           = await cherchevoiles(y0vr,x0vr,t0,twsvr,twavr,polar_id)  
    //deltat= nowUnix-LastCalcDate/1000
    //console.log ('ecartTemps   '+ecartTemps ) 
    //verifierDeltat(ecartTemps) 

    }









function affichagerecou(tabrecouvrements){
    // console.log (' fonction affichagerecou')
    // console.log (tabrecouvrements)
    tableau=tabrecouvrements
        texte='<div class="recou">Recouvrements </div>';
        texte+="<tr><td>----</td><td>----</td><td>"+typeVoiles[tableau[0][0]]+"</td><td>"+tableau[0][2].toFixed(1)+"</td><td>"+tableau[0][4].toFixed(1)+"</td></tr>"
        for (var i=1;i<tableau.length-1 ;i++)        
        {
        texte+="<tr><td>"+tableau[i][3].toFixed(1)+"</td><td>"+tableau[i][1].toFixed(1)+"</td><td>"+typeVoiles[tableau[i][0]]+"</td><td>"+tableau[i][2].toFixed(1)+"</td><td>"+tableau[i][4].toFixed(1)+"</td></tr>"
        }
        texte+="<tr><td>"+tableau[i][3].toFixed(1)+"</td><td>"+tableau[i][1].toFixed(1)+"</td><td>"+typeVoiles[tableau[i][0]]+"</td><td>----</td><td>----</td></tr>" 
        document.getElementById('tabrecou').innerHTML=texte
}





function progressbar(y0,x0,y1,x1) //function progressbar(y0,x0,y1,x1,carabateau)
    {
        //moyenne=carabateau['maxSpeed']/2      # necessite de charger polairesjson 
        moyenne=15
        res =dist_cap_ortho(y0,x0,y1,x1)  
        temps_trajet=res[0]/moyenne 
        t_calcul=((temps_trajet-12)+72)*0.06 / 1.1 //72 isochrones pour les 12 premieres heures + 1 par h  le /1.5 est pour le nouvel algorithme
        nbprogress=0;
        duree=t_calcul;
        var max=100;
        intervalid=setInterval (function(){nbprogress++;  if (nbprogress>max){ clearInterval( intervalid );  }; 
        document.getElementById('progress').value=nbprogress;},10*duree);
    }







//catch (error) {  console.error("Erreur lors de la récupération des courses :", error); }

//*********************************************************************************************************************
//**************      Ecouteurs (Listeners)    ***********************************************************************
//*********************************************************************************************************************

// idusername          changement user   
// inputCoordinates    Coordonnees collées dans champ 
// datetime            Changement datetimedepart
// idselectarrivee     changement arrivee 
// idselectdepart      Changement depart
// idcourse            Changement de course 
// cocheexclusions     Activation des exclusions 
// showisochrones      Affichage des isochrones
// showprogsvr         Affichage des programmations vr (UI) sur la carte  
// twsvmg              Affichage des vmg et des recouvrements 
// dupliquerprogsvr    Dupplique les progs Vr dans les programmations jaunes 
// lancerroutage       Lance le routage  
// detailroute2        Affiche le detail du routage
// rafraichir          Pour rafraichir l affichage des progs vr 


// 

var idusername=document.getElementById('idusername') 
        idusername.addEventListener("change", function (evt) 
{
   let username2=document.getElementById('idusername').value
   
   changementuser(username2)

});





// Écouteur pour l'événement "paste" sur input Coordinates
document.getElementById("inputCoordinates").addEventListener("paste", (event) => {

    event.preventDefault();     // Empêcher le comportement par défaut si nécessaire
    const clipboardData = event.clipboardData || window.clipboardData;   // Récupérer le texte collé
    const pastedData = clipboardData.getData("text");   
    event.target.value = pastedData;                                     // Insérer le texte collé dans le champ    
    const { latDecimal, lngDecimal } = dmsToDecimal(pastedData);         // Conversion des coordonnées en décimales
    console.log ('latDecimal '+latDecimal )
    console.log ('lngDecimal '+lngDecimal )
    y0=latDecimal
    x0=lngDecimal
    affichecoordsdep(y0,x0)

    let t0              = document.getElementById('datetime').value
    let dateObj         = new Date(t0);  
    var t0Secondes      = Math.floor(dateObj.getTime() / 1000);
    var t0formate           = formatTime(t0Secondes)

    let username=document.getElementById('idusername').value
    let course= document.getElementById('idcourse').value
    // on va chercher s il existe deja un trajet pour ce user et cette course  
    trajet= trouvetrajet( username, course) 
    // si un trajet existe on va se contenter de changer les coordonnees y1,x1
    
    if (trajet.length != 0){
        trajet[2]=y0
        trajet[3]=x0
        updatetrajet(username,course,trajet)
        }



    else{ // le trajet est vide , on  cree un trajet }    
    let coursecomplete   = tabNameCourses.find(tabNameCourses => tabNameCourses[0] === course)
  
    y0           = coursecomplete[4][0]
    x0           = coursecomplete[4][1]
    y1           = coursecomplete[5][0]
    x1           = coursecomplete[5][1]

    console.log (t0Secondes)

    try{var rayonari = courseencours[0][5][4]}   catch{rayonari=0}   // cas ou l arrivee est une ligne 
    ari=['Arrivee']
    waypoints=[[99, "Arrivee", y1, x1, rayonari]]
    trajet=[username,course,y0,x0,y0,x0,t0,y1,x1,-1,1,ari,waypoints,' '+username+' '+t0formate ]
  
 
    updatetrajet (username,course,trajet)    // sauve le trajet pour la prochaine fois
    }
    
    tws=10
    twd=270
    heading=0  
    afficheBoat(y0,x0,t0Secondes,tws,twd,heading,username)
    document.getElementById('iddepart').selectedIndex=1 // on peut afficher un selectdepart avec Coordonnees  
    map.panTo([y0,x0])
});


// Ecouteur pour datetime de depart
const datetimeInput = document.getElementById('datetime');
    datetimeInput.value = getCurrentLocalDateTime();  // mise a l heure du champ depart routage
    datetimeInput.addEventListener('change', () => {   
    unixTimestamp = datetimeLocalToUnix(datetimeInput.value);     
    console.log(`Nouvelle date sélectionnée : ${datetimeInput.value}`);
    console.log ('unixTimestamp '+unixTimestamp)
    });





// changement sur le selectarrivee 
var selectari=document.getElementById('idselectarrivee') 
        selectari.addEventListener("change", function (evt) 
        { // recupere les valeurs des wp selectionnes lors d 'un changement du select et les stocke dans localstorage
        console.log ('Ligne 2965 changement sur arrivee')     
        // ici ca doit etre le nom du select     
        let selectedValues = Array.from( idarrivee.selectedOptions).map(option => option.value);
        ari=  selectedValues    
              
        console.log("Valeurs sélectionnées pour les WP :", selectedValues);
        // on change les valeurs d ari dans le localstorage   
        memoiretrajets = JSON.parse(localStorage.getItem("memoiretrajets"))
        memoiretrajets[0][10]=1
        memoiretrajets[0][11]=ari
        localStorage.setItem('memoiretrajets',JSON.stringify(memoiretrajets))
        // on Reaffiche avec ari  
        afficheselectarrivee(waypoints,ari)
        

        if (ari.length>0){
        let dernier= ari[ari.length-1]
        // // on change les coordonnees de l arrivee 
        // dernierwp=ari[ari.length-1]
        let dernierwaypoint = waypoints.find(ligne => ligne[1] === dernier);
        y1=dernierwaypoint[2]
        x1=dernierwaypoint[3]
        // y1=waypoints[dernierwp-1][2]
        // x1=waypoints[dernierwp-1][3]
        // // console.log('dernierwp'+dernierwp)
        // // console.log ('coordonnees dernier wp'+ waypoints[dernierwp-1][2],waypoints[dernierwp-1][3]) 
        // // On affiche dans les co0rdas ari
        affichecoordsari(y1,x1)
        }
        }); 



// changement sur le selectdepart
var selectDepart=document.getElementById('idselectdepart') 
        selectDepart.addEventListener("change", function (evt) 
    { 
    iddepart=document.getElementById('iddepart') 
        // on recupere la valeur du select 
        var valeurSelectionnee = iddepart.value;
        console.log("Valeur sélectionnée :", valeurSelectionnee);
        if (valeurSelectionnee==0){  // c est la position vr 
            
        // On stocke provisoirement les coordonnees dans localstorage
        var  latDeg = document.getElementById("deplatDeg").value;
        var  latMin = document.getElementById("deplatMin").value;
        var  latSec = document.getElementById("deplatSec").value;
        var  latDir = document.getElementById("deplatDir").value;
        var  lngDeg = document.getElementById("deplngDeg").value;
        var  lngMin = document.getElementById("deplngMin").value;
        var  lngSec = document.getElementById("deplngSec").value;
        var  lngDir = document.getElementById("deplngDir").value;
        var  { lat, lng } = toDecimal(latDeg, latMin, latSec, latDir, lngDeg, lngMin, lngSec, lngDir);

        console.log ('latitude a stocker '+lat+' Longitude '+lng) 
        // on ouvre localstorage  


        memoiretrajets = JSON.parse(localStorage.getItem("memoiretrajets"))
        memoiretrajets[0][2]=lat
        memoiretrajets[0][3]=lng
        localStorage.setItem('memoiretrajets',JSON.stringify(memoiretrajets))


    // on reaffiche les coordonnees vr 
        console.log(' coordonnees vr '+y0vr+' '+x0vr)
        // on vide le champ dinput copié collé
        document.getElementById("inputCoordinates").value=" "
        // on repositionne le bateau 
        afficheboatinfos (boatinfosdata)  

        affichecoordsdep(y0vr,x0vr)

        }
        else{    
        // on recupere les coordonneees de localstorage et on les affiche 

        memoiretrajets = JSON.parse(localStorage.getItem("memoiretrajets"))
        lat = memoiretrajets[0][2]
        lon = memoiretrajets[0][3]
        affichecoordsdep(lat,lon)
        }


    });


document.getElementById('idselectcourse').addEventListener("change", function (evt) {  
    if (evt.target && evt.target.id === 'idcourse') {
        console.log('changement de course détecté');
        course = evt.target.value;
        username = document.getElementById('idusername').value;
        changementcourse(username, course);
    }
});
    
// var idcourse=document.getElementById('idcourse')
//         idcourse.addEventListener("change", function (evt)  c
 
//     {   console.log('changement de course detecte')
//         // course   = document.getElementById('idcourse').value
//         // username = document.getElementById('idusername').value
       

//         //changementcourse(user,course)


//     });








// Changement sur le cocheexclusions
var casecocheexclusions=document.getElementById('cocheexclusions') 
        casecocheexclusions.addEventListener("change", function (evt)  
        {   
            cocheexclusions=document.getElementById('cocheexclusions').checked
            console.log ('  ' ) 
            console.log ('Changement sur cocheexclusions ='+cocheexclusions)
            console.log ('******************************************')
            
        });

// Changement sur le showisochrones
const checkboxiso=document.getElementById('showisochrones')
    checkboxiso.addEventListener('change', toggleIsochronesLayer)

    function toggleIsochronesLayer() {
    if (checkboxiso.checked) {
        // Ajouter le layer à la carte
        isochronesLayer.addTo(map);
    } else {

        //isochronesLayer.clearLayers()
        // Retirer le layer de la carte
        map.removeLayer(isochronesLayer);
    }
    }

// Changement sur le showboat
const checkboxboat=document.getElementById('showboat')
    checkboxboat.addEventListener('change', toggleBoatMarkers)

    function toggleBoatMarkers() {
    if (showboat.checked) {
        console.log('visibility checked '+ document.getElementById('showboat').value)
        boatVisibility=1
        console.log ( 'boatVisibility'+ boatVisibility)
        // Ajouter le layer à la carte
        console.log (y0vr,x0vr,t0,twsvr,twdvr,heading,username)
        afficheBoat (y0vr,x0vr,t0,twsvr,twdvr,heading,username)
        boatMarkers.addTo(map);
    } else {
        boatVisibility=0
        console.log ( 'boatVisibility'+ boatVisibility)
        console.log('visibility non checked '+ document.getElementById('showboat').value)
        boatMarkers.clearLayers()
        // Retirer le layer de la carte
        //map.removeLayer(isochronesLayer);
    }
    }


// Changement sur le showboat
const checkboxmarques=document.getElementById('showmarques')
    checkboxmarques.addEventListener('change', toggleMarques)

    function toggleMarques() {
    if (showmarques.checked) {
        console.log('visibility checked '+ document.getElementById('showmarques').value)
        marquesVisibility=1
        console.log ( 'marquesVisibility'+ marquesVisibility)       // Ajouter le layer à la carte
        lgMarkers.addTo(map);
    } 
    else {
        marquesVisibility=0
        console.log ( 'marquesVisibility'+ marquesVisibility)
        console.log('Marquesvisibility non checked '+ document.getElementById('showmarques').value)
        map.removeLayer(lgMarkers)
        // Retirer le layer de la carte
        //map.removeLayer(isochronesLayer);
    }
    }




// Changement sur le showprogsvr
const showprogsvr=document.getElementById('showprogsvr')
    showprogsvr.addEventListener('change', toggleshowprogsLayer)

    function toggleshowprogsLayer() {
    if (showprogsvr.checked) {
        // Ajouter le layer à la carte
        progsvrLayer.addTo(map);
    } else {
        // Retirer le layer de la carte

        //progsvrLayer.clearLayers()
        map.removeLayer(progsvrLayer);
    }
    }


// Changement sur le showprogsvrjaunes 
// const showprogsvrjaunes=document.getElementById('showprogsvrjaunes')
//     showprogsvrjaunes.addEventListener('change', toggleshowprogsLayerJaune)

//     function toggleshowprogsLayerJaune() {
//     console.log ('checkbox layer jaune activee')
//     if (showprogsvrjaunes.checked) { progsvrLayerJaune.addTo(map); } // Ajouter le layer à la carte   
//     else                           {  map.removeLayer(progsvrLayerJaune);}// Retirer le layer de la carte
//     }



//Changement sur le twsvmg
var twsvmg=document.getElementById('twsvmg') 
    twsvmg.addEventListener("change", function (evt){
    console.log('Changement detecte sur twsvmg')
    twsvmg=document.getElementById('twsvmg').value
    console.log ('changement du vent tws= '+twsvmg)    
    tws10vmg=parseInt(Math.round(twsvmg*10))    
    resvoiles           =  cherchevoiles(y0vr,x0vr,t0vr,twsvmg,twavr,polar_id)


      });  



// bouton dupliquer dans jaune 
var dupliquerprogsvr=document.getElementById('dupliquerprogsvr') 
    dupliquerprogsvr.addEventListener("click", function (evt)
    { 
    console.log ('Bouton de duplication cliqué')
    console.log ('id_user '+id_user)
    console.log ('course '+course)
    //programmationsvr=chercheprogsserveur(id_user,course)
    console.log ('programmationsvr issues de la demande de duplication' )
    console.log (programmationsvr  )
    programmationsvrjaunes= [].concat(programmationsvr)
    afficherTableau3(programmationsvr)
    

    });






// n existe pas encore 
// const showprogsvrjaunes=document.getElementById('showprogsvrjaunes')
// showprogsvrjaunes.addEventListener('change', toggleshowprogsLayerJaune)


//affichage de la programmation jaune 
function toggleshowprogsLayerJaune() {
    if (showprogsvrjaunes.checked) {
        // Ajouter le layer à la carte
        progsvrLayerJaune.addTo(map);
    } else {
        // Retirer le layer de la carte
        map.removeLayer(progsvrLayerJaune);
    }
    }








var lancerRoutage=document.getElementById('lancerRoutage') 
        lancerRoutage.addEventListener("click", function (evt)  
        {   // on va recuperer les donnees du routage  sur l interface


            console.log('\n Lancement d\'un routage')
            var { lat,lng } = recuperecoordsdep();
            console.log ('lat lng'+lat+' '+lng)
            //var trajetsencours = JSON.parse(localStorage.getItem("memoiretrajets"))  // on recupere le tableau des waypoints 
            // waypoints = trajetsencours[0][12] est une variable globale  
            console.log ('ligne 4363 waypoints '+waypoints)
            console.log ('ligne 4364 ari '+ari)

            // ari = Array.from( idarrivee.selectedOptions).map(option => option.value);
            // if (ari==[]){ari=['Arrivee']; }    //Si on a oublié de cocher une case             
            heuredepart=document.getElementById('datetime').value     // on recupere l heure de depart 
            


            console.log("Valeurs des WP selectionnés : ari = ", ari);
            console.log( 'y0, '+y0+' x0 '+x0)
            console.log (waypoints)
            console.log('heure de depart  '+heuredepart)
            var timestamp = new Date(heuredepart).getTime() / 1000; // Convertit en secondes
            var heuredepart = Math.ceil(timestamp / 60) * 60; // Arrondi à la minute supérieure
            console.log ('heure de depart en secondes du routage '+ heuredepart + 'soit ' +hmns.format(heuredepart*1000)) 

            t0routage=heuredepart
            // console.log( 'soit ' +hmns.format(heurededepart*1000))
            
             // on recuperecocheexclusions 
            let cocheexclusions=document.getElementById('cocheexclusions').checked

            y0 = lat
            x0 = lng
            // on demande le routage
            chercheroutage(lat,lng,heuredepart,waypoints,ari,cocheexclusions)
            chercheprogsvr(id_user,course,heuredepart+120)
        });



 document.getElementById("detailroute2").addEventListener("click", function() {
    var popupBlocked = false;
    var testPopup = null;

    try {
        testPopup = window.open("", "_blank", "width=100,height=100");
        if (!testPopup || testPopup.closed || typeof testPopup.closed === "undefined") {
            popupBlocked = true;
        } else {
            // Vérifier l'accès au document (bloqueur de popup empêche cela)
            testPopup.document.write("<p>Test</p>");
            testPopup.document.close();
        }
    } catch (e) {
        popupBlocked = true;
    }

    if (testPopup) {
        testPopup.close();
    }

    if (!popupBlocked) {
        openPopupWindow();
    } else {
        openPopupDiv();
    }
});

//   document.getElementById("detailroute2").addEventListener("click", function() {
//     var testPopup = window.open("", "_blank", "width=100,height=100");
//     var popupAllowed = testPopup && !testPopup.closed; // Vérifie si la popup s'ouvre  

//     console.log('popupAllowed',popupAllowed)
//     if (popupAllowed) {
//         testPopup.close();       // Fermer la popup test
//         openPopupWindow();       // Ouvrir la popup réelle avec window.open
//     } else {
//         openPopupDiv();  // Fallback : utiliser la version en div
//     } 

// //  // createDraggablePopup();

//  });





function createTexteRoute()
         {var texteroute;
            urlcss=        "{{ url_for('static', filename='css/vrouteur.css') }}"
        let dernier= arrayroutage.length-1
        texteroute=`<!DOCTYPE html> <h2> ${username} -- ${tabNameCourses[indiceCourse][1]}   --  ${intlhmn.format(arrayroutage[0][3]*1000)}
                            <span class="purple"> -- ETA : ${intlhmn.format(arrayroutage[dernier][3]*1000)}</span></h2>
                            <title>Détail du routage </title>
                            <link rel="stylesheet" type="text/css" href="${urlcss} ">
                            <table class='table4'>
                            <th  >N </th><th>H +</th><th>Lat</th><th>Lon</th><th>Date </th><th>Twa</th><th>Cap</th>
                            <th>Vmgmin</th><th>Vmgmax</th><th>Speed</th><th>Voile</th><th>Boost</th><th>Tws</th><th>Twd</th><th>Stamina</th><th>Pen.</th>`

  
                   for (var i=0;i<(arrayroutage.length);i++)
                            {   delta= parseInt(arrayroutage[i][3]-arrayroutage[0][3])
                                he=parseInt(delta/3600)
                                mni=Math.round((delta-3600*he)/60)
                                texteroute+="<tr>"
                               
                                if (i==0){texteroute+="<td class='c10' > Pos VR</td>"}
                                else{texteroute += "<td class='c10' >"+ i+"</td>"} 

                                texteroute+=`<td>${he}h <br>${mni}mn</td>
                                             <td>${arrayroutage[i][1].toFixed(4)}</td>
                                             <td>${arrayroutage[i][2].toFixed(4)}</td>
                                             <td>${intlhmn.format(arrayroutage[i][3]*1000)}</td>`
                                
                                if (i<((arrayroutage.length)-1)&(i>0))      // twa
                                { if (Math.round(arrayroutage[i][4])== Math.round(arrayroutage[i+1][4]) || (Math.round(arrayroutage[i][4])== Math.round(arrayroutage[i-1][4]) )  )

                                        { // cas ou les 2 valeurs sont egales 
                                        if (arrayroutage[i][4]> 0) {texteroute+="<td class='greenfgrey' id  ='twa"+i+"' >"+arrayroutage[i][4].toFixed(0)+"</td>" } //twa
                                        else{                       texteroute+="<td class='redfgrey'   id  ='twa"+i+"' >"+arrayroutage[i][4].toFixed(0)+"</td>" }
                                        }
                                        else{  // cas ou les 2 valeurs ne sont pas egales 

                                            if (arrayroutage[i][4]> 0) {texteroute+="<td class='green' id  ='twa"+i+"' >"+arrayroutage[i][4].toFixed(0)+"</td>" } //twa
                                            else{                       texteroute+="<td class='red'   id  ='twa"+i+"' >"+arrayroutage[i][4].toFixed(0)+"</td>" }

                                  }  
                                }
                                else  //cas normal 
                                {
                                if (arrayroutage[i][4]> 0) {texteroute+="<td class='green' id  ='twa"+i+"' >"+arrayroutage[i][4].toFixed(1)+"</td>" } //twa
                                else{                       texteroute+="<td class='red'   id  ='twa"+i+"' >"+arrayroutage[i][4].toFixed(1)+"</td>" }
                                }

                                if (i<((arrayroutage.length)-1)&(i>0))
                                        { if (Math.round(arrayroutage[i][7])== Math.round(arrayroutage[i+1][7]) || (Math.round(arrayroutage[i][7])== Math.round(arrayroutage[i-1][7]) )                        )
                                            {texteroute+="<td class='bluefgrey'   id  ='cap"+i+"'      >"+arrayroutage[i][7].toFixed(0)+"</td>"  }                               //cap
                                            else  
                                            { texteroute+=`<td class='blue'   id ='cap${i}'      >${arrayroutage[i][7].toFixed(0)}</td>`}  
                                        }
                                else    { texteroute+=`<td class='blue'  id='cap${i}'      >${arrayroutage[i][7].toFixed(0)}</td>`  }
                            
                                if (Math.abs(arrayroutage[i][4])<arrayroutage[i][5]){color='red'} else{color='black'}                //on est inferieur a la twa min 
                                if (Math.ceil(Math.abs(arrayroutage[i][4]))>arrayroutage[i][6]){color='red'} else{color='green'}                //on est superieur a la twa max 
                                
                                texteroute+=`<td class=${color}>${arrayroutage[i][5].toFixed(1)}</td>             
                                             <td class=${color}>${arrayroutage[i][6].toFixed(1)}</td>
                                             <td >${arrayroutage[i][8].toFixed(2)}</td>`                                             //speed
                               //+"<td >"+ typeVoiles[parseInt(arrayroutage[i][9]%10)]+"</td>"

                                if    ((arrayroutage[i][10] >1)  &&  (arrayroutage[i][10] <1.0141)){ texteroute+="<td class= 'fondrose'>"+typeVoiles[parseInt(arrayroutage[i][9]%10)]+"</td>"
                                                                                                     texteroute+="<td class= 'fondrose'>"+arrayroutage[i][10].toFixed(3)+"</td>"
                                 }       //voile
                                else         {texteroute+=`<td class= 'black'>${typeVoiles[parseInt(arrayroutage[i][9]%10)]}</td>
                                                           <td               >${arrayroutage[i][10].toFixed(3)}</td>` 
                                             }                  //rapport
 
                                texteroute+=`<td>${arrayroutage[i][11].toFixed(2)}</td>                                
                                            <td>${arrayroutage[i][12].toFixed(2)}</td>
                                            <td>${arrayroutage[i][13].toFixed(1)}</td>
                                            <td>${arrayroutage[i][15].toFixed(0)}</td>    
                                            </tr>`
                            }

                             texteroute += `</table></body></html>`
        return texteroute

         }


// fonction si popup blockees 

function openPopupDiv() {
      texteroute=                      createTexteRoute()
      const popup = document.createElement("div");
      popup.classList.add("popup");
      // Position verticale par défaut
      popup.style.top = "100px";
      popup.style.width = "1000px";
      popup.style.height = "1000px";
      popup.style.overflow = "auto";

      // Création de la barre de titre avec la croix de fermeture
      const header = document.createElement("div");
      header.classList.add("popup-header");
      header.textContent = "Detail du routage";
      
      const close = document.createElement("span");
      close.classList.add("popup-close");
      close.innerHTML = "&times;"; // Affiche le symbole "×"
      header.appendChild(close);
      
      // Création du contenu de la popup avec le texte fourni
      const content = document.createElement("div");
      content.classList.add("popup-content");
      content.innerHTML = texteroute;
      
      // Assemblage de la popup
      popup.appendChild(header);
      popup.appendChild(content);
      document.body.appendChild(popup);
      
      // Positionner la popup à 5px du bord droit
      repositionPopup(popup);
      
      // Fermeture de la popup lors du clic sur la croix
      close.addEventListener("click", function() {
        popup.remove();
      });
      
      // Attacher un écouteur sur les lignes du tableau (si présent dans le contenu)
      attachRowClickListeners2(popup);
      
      // Rendre la popup déplaçable via la barre de titre
      makeDraggable(popup, header);
      
      // Repositionnement de la popup lors du redimensionnement de la fenêtre
      function handleResize() {
        if (document.body.contains(popup)) {
          repositionPopup(popup);
        } else {
          window.removeEventListener("resize", handleResize);
        }
      }
      window.addEventListener("resize", handleResize);
    }





    function repositionPopup(popup) {
      // Calcul : largeur de la fenêtre - largeur de la popup - 5px
      const newLeft = window.innerWidth - popup.offsetWidth - 5;
      popup.style.left = newLeft + "px";
    }



    function makeDraggable(popup, handle) {
      let offsetX = 0, offsetY = 0;
      let isDragging = false;
      
      handle.addEventListener("mousedown", function(e) {
        isDragging = true;
        // Calculer le décalage entre la position du curseur et le coin supérieur gauche de la popup
        offsetX = e.clientX - popup.offsetLeft;
        offsetY = e.clientY - popup.offsetTop;
        document.addEventListener("mousemove", mouseMove);
        document.addEventListener("mouseup", mouseUp);
      });
      
      function mouseMove(e) {
        if (isDragging) {
          popup.style.left = (e.clientX - offsetX) + "px";
          popup.style.top = (e.clientY - offsetY) + "px";
        }
      }
      
      function mouseUp() {
        isDragging = false;
        document.removeEventListener("mousemove", mouseMove);
        document.removeEventListener("mouseup", mouseUp);
      }
    }


//*****************************************************************************************************
//***********   Variante avec popup *******************************************************************
//*****************************************************************************************************


var popup1 = null;






function openPopupWindow(){
      if (popup1 && !popup1.closed) {  popup1.close();   }
      // Ouvrir la nouvelle popup
      popup1 = window.open('', 'route', 'top=10,left=1000,width=1000,height=1000,scrollbars=yes');
      texteroute=                      createTexteRoute()      
      // Écrire le contenu dans la popup
      popup1.document.write(texteroute);
      popup1.document.close(); // Nécessaire pour finaliser le chargement du DOM
      // Attendre un court instant pour être sûr que le contenu est disponible
      setTimeout(function() { attachRowClickListeners(popup1); }, 500);
    // Fermer la popup automatiquement après 600000 ms (10 minutes)
      setInterval(function(){ fermeturepopup(popup1); }, 600000);
    }


    // Fonction de fermeture de la popup
function fermeturepopup(fenetre) {
      if (fenetre && !fenetre.closed) {
        fenetre.close();
      }
      // Par exemple, on réinitialise le contenu du bouton et la progress bar
      document.getElementById('detailroute2').innerHTML = "Afficher Détail Route";
      var prog = document.getElementById('progress');
      if (prog) prog.value = 0;
    }




//*****************************************************************************************************
//***********   Fin Variante avec popup *******************************************************************
//*****************************************************************************************************



  














// c est le bouton rafraichir pour les progs pas utile avec le websocket

var rafraichir=document.getElementById('rafraichir') 
            rafraichir.addEventListener("click", function (evt)
         { console.log ('Bouton de rafraichissement des progs cliqué')
            // on appelle la fonction ajax qui recupere le trace des progs
            // il faut avoir id_user et course qui sont des variables globales      
            chercheprogsvr(id_user,course,t0routage)
         });



         document.getElementById("btnPolaires").addEventListener("click", function() {
   // const urlPolaires = "http://inc.bureauvallee.free.fr/polaires/?race_id=654.1&tws=13.6+&twa=45&utm_source=VRDashboard";
    urlPolaires=`http://blacksailingpolars.vrzen.org/?race_id=${course}&tws=${twsvr}&twa=${Math.abs(twavr)}&stam=${stamina}&hull=true&winch=true&foil=true&light=true&heavy=true&reach=true&magicFurler=true&comfortLoungePug=true&vrtexJacket=true&voile=${sail%10}`
    const width = 950;
    const height = 850;
    const screenWidth = window.screen.width;
    const left = screenWidth - width - 50; // 50 px du bord droit
    const top = 100; // Position verticale (modifiable)    
    if (popupPolaires && !popupPolaires.closed) {
        popupPolaires.close();
        popupPolaires = null;
    } else {
        popupPolaires = window.open(urlPolaires, "popupPolaires", `width=${width},height=${height},left=${left},top=${top},scrollbars=no,resizable=yes`);
    }
});



document.getElementById("btnDivers").addEventListener("click", function() {
   // const urlPolaires = "http://inc.bureauvallee.free.fr/polaires/?race_id=654.1&tws=13.6+&twa=45&utm_source=VRDashboard";
   console.log ('polar_id'+polar_id)
   
   url=`${serveur}/parametres?course=${course}&polar_id=${polar_id}&tws=${twsvr}&twa=${Math.abs(twavr)}&stam=${stamina}&hull=true&winch=true&foil=true&light=true&heavy=true&reach=true&magicFurler=true&comfortLoungePug=true&vrtexJacket=true&voile=${sail%10}`
    const width = 950;
    const height = 850;
    const screenWidth = window.screen.width;
    const left = screenWidth - width - 50; // 50 px du bord droit
    const top = 100; // Position verticale (modifiable)    

     console.log (url)

    if (popupPara && !popupPara.closed) {
        popupPara.close();
        popupPara = null;
    } else {
        popupPara = window.open(url, "popupParametres", `width=${width},height=${height},left=${left},top=${top},scrollbars=no,resizable=yes`);
    }
});





 // Fonction pour attacher les écouteurs de clic sur les lignes de tableau dans la popup
 function attachRowClickListeners(popupWindow) {
      // Recherche des lignes dans le document de la popup
      var rows = popupWindow.document.querySelectorAll(".table4 tr");
      console.log("Rows trouvées dans le popup :", rows.length);
      rows.forEach(function(row) {
        row.addEventListener("click", function() {
          // Retirer la classe 'selected' de toutes les lignes
          rows.forEach(function(r) { r.classList.remove("selected"); });
          // Ajouter la classe 'selected' à la ligne cliquée
          this.classList.add("selected");
        });
      });
    }
 

    function attachRowClickListeners2(popup) {
      const rows = popup.querySelectorAll(".table4 tr");
      rows.forEach(function(row) {
        row.addEventListener("click", function() {
          // Retirer la classe 'selected' de toutes les lignes
          rows.forEach(r => r.classList.remove("selected"));
          // Ajouter la classe 'selected' à la ligne cliquée
          this.classList.add("selected");
        });
      });
    }




 window.centrage = () => {
    try{
    map.panTo([y0vr,x0vr])   }
    catch{console.log ('Centrage pas possible')} 

}



    
// // Écouteur pour l'événement "paste" sur input Coordinates
// document.getElementById("inputCoordinates").addEventListener("paste", (event) => {
//     // Empêcher le comportement par défaut si nécessaire
//     event.preventDefault();

//     // Récupérer le texte collé
//     const clipboardData = event.clipboardData || window.clipboardData;
//     const pastedData = clipboardData.getData("text");

//     // Insérer le texte collé dans le champ
//     event.target.value = pastedData;

//     // Conversion des coordonnées en décimales
//     const { latDecimal, lngDecimal } = dmsToDecimal(pastedData);
//     affichecoordsdep(latDecimal,lngDecimal)
  
// });





//************************************************************************************************
//***********    Gestionnaires de map       ******************************************************
//************************************************************************************************


map.on('contextmenu', function(e)
        {    
        console.log ('username'+username +' course'+course +'lat'+e.latlng.lat  )    
           
            popup.setLatLng(e.latlng,map)
                .setContent
                    ( "  <b>   Latitude &nbsp; &nbsp;: " +pos_dec_mn(e.latlng.lat)+" (" +arrondi(e.latlng.lat,4) + ") "
                    +" <br> Longitude : " +pos_dec_mn(e.latlng.lng)+" ("+arrondi(e.latlng.lng,4)+")"
                        +"<br><a href=javascript:void(0); onclick= 'centrage() ';> Centrage sur Bateau</a>"    
                 

                //     //+'<br> {"lat":'+arrondi(e.latlng.lat,4)+',"lon":'+arrondi(e.latlng.lng,4)+'},'
                //     +"<br><a href=javascript:void(0); onclick= 'Routagejsdepart("+e.latlng.lat+","+e.latlng.lng+") ';> Definir comme Depart</a>"

                //     +"<br><a href=javascript:void(0); onclick= 'Routagejsarrivee("+e.latlng.lat+","+e.latlng.lng+") ';> Definir comme Arrivee</a>"
                //    // +"<br><a href=javascript:void(0); onclick= 'Routagejsarrivee("+e.latlng.lat+","+e.latlng.lng+") ';> Definir comme Arrivee</a>"
               
               // +"<br><a href=javascript:void(0); onclick= 'stockepoint("+e.latlng.lat+","+e.latlng.lng+") ';> Ajouter une Zone d'exclusions </a>"
                )
                
                .openOn(map);
                PopupOpen=true;  
        }); 



map.on('mousemove', function(e)
        { 
         
            
            document.getElementById('latitudevent'  ).innerHTML = pos_dec_mn_lat(e.latlng.lat)+' ('+e.latlng.lat.toFixed(4)+')'
            document.getElementById('longitudevent') .innerHTML  = pos_dec_mn_lng(e.latlng.lng)+' ('+e.latlng.lng.toFixed(4)+')'
            distcapcurseur=dist_cap_ortho2(y0vr,x0vr,e.latlng.lat,e.latlng.lng)              // distance et cap vers le curseur       
            twac=ftwao(distcapcurseur[1],twdvr)                                              // twa pour le premier troncon vers le curseur 
            document.getElementById('hdg').innerHTML        = distcapcurseur[1].toFixed(0)  
            document.getElementById('twa').innerHTML        = twac.toFixed(0) 


              
        try {
               var decalage= document.getElementById('mnDecalageMeteo').value  
               var tempsdecale=tempscourant+decalage*3600*1000 // temps pour affichage meteo avec decalage 
               meteocurseur=vit_angle_vent (e.latlng.lat,e.latlng.lng ,tempsdecale/1000)
               twscurseur                                      = meteocurseur[0].toFixed(2)
               twdcurseur                                      = meteocurseur[1].toFixed(2)            
               document.getElementById('twscurseur').innerHTML = twscurseur
               document.getElementById('twdcurseur').innerHTML = twdcurseur    
               

              

    //    //        console.log ('Meteo depart  tws '+twsvr+ ' twd '+twdvr +' twavr '+twavr )
               
    //            cap0=distcapcurseur[1]
    //            //t0simul=t0start.getTime()
    //            t0simul=t0vr*1000   // pour que les courvbes soient en phase

    //         //    console.log ('ligne 1228 y0vr '+y0vr)
    //         //    console.log ('ligne 1228 x0vr '+x0vr)
    //         //    console.log ('ligne 1228 cap0 '+cap0)
    //         //    console.log ('ligne 1228 twavr'+twavr)
    //         //    console.log ('ligne 1228  sail '+sail)
    //         //    console.log ('ligne 1228 stamina '+stamina)
    //         //    console.log ('ligne 1228 tempsdepartsimul en ms '+t0simul + ' soit ' +intlhmn.format(t0simul))   //  la simulation se fait a partir du temps de depart du routage
               
               
    //         if (cap0!=valinit)     // calcul des lignes rouge cap  et verte twa s il y a changement de cap
    //           {   
    //             valinit=cap0
    //             for ( var j=1 ; j<74 ; j++ )  {map.removeLayer(circle1[j]);  map.removeLayer(circle2[j])    }  // on efface les anciens points 
    //             map.removeLayer(polycap1)

    //         if (affichecapval==1)
    //             {    

    //            // for ( var j=1 ; j<74 ; j++ )  {map.removeLayer(circle1[j]);  map.removeLayer(circle2[j])    }  // on efface les anciens points 
    //                 nb=72

    //                 tabpolycapvoile= polycap(y0routage,x0routage,t0simul/1000,cap0,twavr,sail,stamina,nb,polairesglobales,carabateau)
                
                
    //             //    console.log (tabpolycapvoile);
    //             //   var ligne=  L.polyline( tabpolycapvoile).setStyle({ color: 'blue', weight:1, opacity:1, }).addTo(map);
    //                 // ligne =new Array
    //                 // ligne[0]=[y0routage,x0routage]
    //                 for ( var i=1 ; i<tabpolycapvoile.length ; i++ )                // on affiche les nouveaux 
    //                     {
    //                         if (i%6 != 0) 
    //                         {circle1[i] = L.circle([tabpolycapvoile[i][0],tabpolycapvoile[i][1]] ,{fillColor: colors[tabpolycapvoile[i][2]] ,color: [tabpolycapvoile[i][2]], weight:1 ,opacity:1,fillOpacity: 1,radius: 150,}).addTo(map)}
    //                         else
    //                         { circle1[i] = L.circle([tabpolycapvoile[i][0],tabpolycapvoile[i][1]] ,{fillColor: colors[tabpolycapvoile[i][2]] ,color: [tabpolycapvoile[i][2]], weight:1 ,opacity:1,fillOpacity: 1,radius: 220,}).addTo(map)  }                                                                
    //                    //ligne[i]=([tabpolycapvoile[i][0],tabpolycapvoile[i][1]])
    //                     }

    //             //         console.log ('en 2460')
    //             //         console.log(ligne)
    //             //    var polycap1 =     L.polyline( ligne).setStyle({ color: 'blue', weight:1, opacity:1, }).addTo(map);

    //             }


    //          if (affichetwaval==1){
    //                // for ( var j=1 ; j<74 ; j++ )  {map.removeLayer(circle1[j]);  map.removeLayer(circle2[j])    }  // on efface les anciens points 
    //                 twa0=-Math.round(twac)   
    //                 tabpolytwavoile= polytwa(y0routage,x0routage,t0simul/1000,  twa0 ,twavr,sail,stamina,nb,polairesglobales,carabateau)  
       
                
    //                 for ( var i=1 ; i<tabpolytwavoile.length ; i++ )                // on affiche les nouveaux       
    //                     {
    //                     if (i%6 != 0) 
    //                     {   circle2[i] = L.circle([tabpolytwavoile[i][0],tabpolytwavoile[i][1]] ,{fillColor: colors[tabpolytwavoile[i][2]] ,color: 'black', weight:1,opacity:1,fillOpacity: 1,radius: 150,}).addTo(map)     }
    //                 else{
    //                         circle2[i] = L.circle([tabpolytwavoile[i][0],tabpolytwavoile[i][1]] ,{fillColor: colors[tabpolytwavoile[i][2]] ,color: 'red', weight:1,opacity:1,fillOpacity: 1,radius: 220,}).addTo(map) 
    //                     }
    //                     }
    //                 }
    //             }
            

            }
                    catch {console.log('Les vents ne sont pas encore disponibles')}
            
            
            
            
            
                });





broadcast.on('redrawFinished', () => 
        {          
            let sec=((store.get('timestamp')-Date.now())/1000);
            let npoint=recherche(sec,tc)-1;
            // console.log (' point   '+arrayroutage[npoint][1]+' ' +arrayroutage[npoint][2])
        
        try{  //  ne fonctionne que s'il y a eu un routage
              //console.log(' ecart en sec '+sec+' numero de point   '+npoint )
           map.removeLayer(circlew)
           console.log (' point   '+arrayroutage[npoint][0])
           circlew = L.circle([arrayroutage[npoint][1],arrayroutage[npoint][2]], { color: 'red',  fillColor: 'white', opacity:1, fillOpacity: 0.5, radius: 3000 }).addTo(map);            
            }
            catch{ console.log(' ')
            }
                        
        });











//************************************************************************************************
//***********    Lancement et mises a jour t       ******************************************************
//************************************************************************************************
   //initialise le local storage, si c'est la premiere connexion 
initialise1()    // initialise si rien dans localstorage et charge la liste des courses 

if (sourceinfos=='dash')
{  maindash(posStart)}


main()
//setInterval(function(){  update(username,course,bloque)        ;}, 20000);      // update2 toutes les 20s sauf si bloque=1

setInterval(function(){ 
    let nowMSec          = nowJS.getTime()
    ecartTemps =(nowMSec-lastCalcDate)/1000; 
    console.log('ecartTemps'+ecartTemps);
    verifierDeltat(ecartTemps)            ;}, 60000);      //         toutes les 60s






})//fin de windyinit


//************************************************************************************************
//***********    Fin du script       ******************************************************
//************************************************************************************************


</script>
</head>


<body>
    <div id="windy"></div>   
</body>
</html>






